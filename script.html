<script>
/* [SPX] DAILY CHECKLIST - Enhanced Version Client Script */

(function() {
  'use strict';
  
  /* ====== GLOBAL STATE ====== */
  var currentUser = null;
  var lang = localStorage.getItem('spx_lang') || 'vi';
  var theme = localStorage.getItem('spx_theme') || 'light';
  
  var hubData = {
    '80TVH01': { name: '80-TVH TRA VINH HUB' },
    '80TVH02': { name: '80-TVH DUYEN HAI HUB' },
    '80TVH03': { name: '80-TVH CAU NGANG HUB' },
    '80TVH04': { name: '80-TVH CANG LONG HUB' },
    '80TVH05': { name: '80-TVH TIEU CAN HUB' },
    '80TVH06': { name: '80-TVH TRA CU HUB' },
    '80TVH07': { name: '80-TVH TRA VINH 02 HUB' },
    '80TVH08': { name: '80-TVH TRA VINH 03 HUB' },
    '80TVH09': { name: '80-TVH CAU KE HUB' },
    '80TVH10': { name: '80-TVH DUYEN HAI 02 HUB' },
    '80TVH11': { name: '80-TVH TRA VINH 04 HUB' }
  };
  
  var currentHub = localStorage.getItem('currentHubId') || '80TVH01';
  var tasksData = {};
  var TASK_CACHE_TTL = 10 * 60 * 1000; // 10 ph√∫t
  
  function getTaskCacheKey(key) {
    return 'spx_tasks_cache_' + key;
  }
  
  function getCachedTasks(storageKey) {
    try {
      var raw = localStorage.getItem(getTaskCacheKey(storageKey));
      if (!raw) return null;
      var payload = JSON.parse(raw);
      if (!payload || !payload.tasks || !payload.savedAt) {
        localStorage.removeItem(getTaskCacheKey(storageKey));
        return null;
      }
      if (Date.now() - payload.savedAt > TASK_CACHE_TTL) {
        localStorage.removeItem(getTaskCacheKey(storageKey));
        return null;
      }
      return payload.tasks;
    } catch (e) {
      console.warn('Task cache read error:', e);
      return null;
    }
  }
  
  function saveTasksToCache(storageKey, tasks) {
    try {
      localStorage.setItem(
        getTaskCacheKey(storageKey),
        JSON.stringify({
          savedAt: Date.now(),
          tasks: tasks || []
        })
      );
    } catch (e) {
      console.warn('Task cache save error:', e);
    }
  }
  
  function clearTaskCache(storageKey) {
    try {
      localStorage.removeItem(getTaskCacheKey(storageKey));
    } catch (e) {
      console.warn('Task cache clear error:', e);
    }
  }
  
  /* ====== DATA CACHING SYSTEM ====== */
  
  var CacheManager = {
    // Cache configuration
    config: {
      defaultTTL: 5 * 60 * 1000, // 5 minutes default
      maxSize: 50, // Maximum number of cached items
      enabled: true
    },
    
    // Cache storage
    cache: {},
    
    // Initialize cache from localStorage
    init: function() {
      try {
        var stored = localStorage.getItem('spx_cache');
        if (stored) {
          this.cache = JSON.parse(stored);
          // Clean expired entries
          this.cleanExpired();
        }
      } catch (e) {
        console.warn('Cache init error:', e);
        this.cache = {};
      }
    },
    
    // Generate cache key
    getKey: function(action, data) {
      return action + '_' + JSON.stringify(data || {});
    },
    
    // Get from cache
    get: function(action, data) {
      if (!this.config.enabled) return null;
      
      var key = this.getKey(action, data);
      var item = this.cache[key];
      
      if (!item) return null;
      
      // Check if expired
      if (Date.now() > item.expires) {
        delete this.cache[key];
        this.save();
        return null;
      }
      
      return item.data;
    },
    
    // Set cache
    set: function(action, data, value, ttl) {
      if (!this.config.enabled) return;
      
      var key = this.getKey(action, data);
      var expires = Date.now() + (ttl || this.config.defaultTTL);
      
      this.cache[key] = {
        data: value,
        expires: expires,
        timestamp: Date.now()
      };
      
      // Enforce max size
      this.enforceMaxSize();
      
      // Save to localStorage
      this.save();
    },
    
    // Clear cache
    clear: function(pattern) {
      if (pattern) {
        // Clear matching keys
        Object.keys(this.cache).forEach(function(key) {
          if (key.indexOf(pattern) !== -1) {
            delete this.cache[key];
          }
        });
      } else {
        // Clear all
        this.cache = {};
      }
      this.save();
    },
    
    // Clean expired entries
    cleanExpired: function() {
      var now = Date.now();
      var cleaned = false;
      
      Object.keys(this.cache).forEach(function(key) {
        if (this.cache[key].expires < now) {
          delete this.cache[key];
          cleaned = true;
        }
      }.bind(this));
      
      if (cleaned) {
        this.save();
      }
    },
    
    // Enforce max size
    enforceMaxSize: function() {
      var keys = Object.keys(this.cache);
      if (keys.length <= this.config.maxSize) return;
      
      // Sort by timestamp and remove oldest
      keys.sort(function(a, b) {
        return this.cache[a].timestamp - this.cache[b].timestamp;
      }.bind(this));
      
      var toRemove = keys.length - this.config.maxSize;
      for (var i = 0; i < toRemove; i++) {
        delete this.cache[keys[i]];
      }
    },
    
    // Save to localStorage
    save: function() {
      try {
        localStorage.setItem('spx_cache', JSON.stringify(this.cache));
      } catch (e) {
        console.warn('Cache save error:', e);
        // If storage is full, clear old entries
        if (e.name === 'QuotaExceededError') {
          this.clear();
        }
      }
    },
    
    // Get cache stats
    getStats: function() {
      return {
        size: Object.keys(this.cache).length,
        maxSize: this.config.maxSize,
        enabled: this.config.enabled
      };
    }
  };
  
  // Initialize cache on load
  CacheManager.init();
  
  /* ====== DYNAMIC SCRIPT LOADER ====== */
  
  var externalScriptPromises = {};
  
  function loadExternalScript(src) {
    if (externalScriptPromises[src]) {
      return externalScriptPromises[src];
    }
    
    externalScriptPromises[src] = new Promise(function(resolve, reject) {
      var script = document.createElement('script');
      script.src = src;
      script.async = true;
      script.dataset.dynamicSrc = src;
      script.onload = function() {
        resolve();
      };
      script.onerror = function(err) {
        script.remove();
        reject(new Error('Failed to load script: ' + src));
      };
      document.head.appendChild(script);
    }).catch(function(error) {
      delete externalScriptPromises[src];
      throw error;
    });
    
    return externalScriptPromises[src];
  }
  
  /* ====== API OPTIMIZATION ====== */
  
  // Request queue for batching
  var requestQueue = [];
  var requestTimer = null;
  var requestBatchDelay = 100; // 100ms batch delay
  
  // Debounce function
  function debounce(func, wait) {
    var timeout;
    return function() {
      var context = this;
      var args = arguments;
      clearTimeout(timeout);
      timeout = setTimeout(function() {
        func.apply(context, args);
      }, wait);
    };
  }
  
  // Throttle function
  function throttle(func, limit) {
    var inThrottle;
    return function() {
      var args = arguments;
      var context = this;
      if (!inThrottle) {
        func.apply(context, args);
        inThrottle = true;
        setTimeout(function() {
          inThrottle = false;
        }, limit);
      }
    };
  }
  
  /* ====== ERROR HANDLING ====== */
  
  // Error message mapping
  function getErrorMessage(action, error) {
    var errorStr = error.toString().toLowerCase();
    
    // Common error patterns
    if (errorStr.indexOf('permission') !== -1 || errorStr.indexOf('denied') !== -1) {
      return 'B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y. Vui l√≤ng li√™n h·ªá admin.';
    }
    
    if (errorStr.indexOf('not authenticated') !== -1 || errorStr.indexOf('authentication') !== -1) {
      return 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng l√†m m·ªõi trang.';
    }
    
    if (errorStr.indexOf('network') !== -1 || errorStr.indexOf('timeout') !== -1) {
      return 'L·ªói k·∫øt n·ªëi m·∫°ng. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi v√† th·ª≠ l·∫°i.';
    }
    
    if (errorStr.indexOf('quota') !== -1 || errorStr.indexOf('limit') !== -1) {
      return 'ƒê√£ v∆∞·ª£t qu√° gi·ªõi h·∫°n. Vui l√≤ng th·ª≠ l·∫°i sau.';
    }
    
    // Action-specific errors
    switch(action) {
      case 'whoami':
        return 'Kh√¥ng th·ªÉ x√°c th·ª±c ng∆∞·ªùi d√πng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.';
      case 'saveTasks':
        return 'Kh√¥ng th·ªÉ l∆∞u tasks. Vui l√≤ng th·ª≠ l·∫°i.';
      case 'loadTasks':
        return 'Kh√¥ng th·ªÉ t·∫£i tasks. Vui l√≤ng th·ª≠ l·∫°i.';
      case 'saveUser':
        return 'Kh√¥ng th·ªÉ l∆∞u user. Vui l√≤ng ki·ªÉm tra th√¥ng tin v√† th·ª≠ l·∫°i.';
      case 'deleteUser':
        return 'Kh√¥ng th·ªÉ x√≥a user. Vui l√≤ng th·ª≠ l·∫°i.';
      default:
        return 'ƒê√£ x·∫£y ra l·ªói: ' + (error.message || error.toString());
    }
  }
  
  /* ====== AUTHENTICATION ====== */
  
  function checkAuth() {
    return callApi('whoami').then(function(userInfo) {
      if (!userInfo || userInfo.error) {
        var errorMsg = userInfo ? userInfo.error : 'Cannot connect to server';
        showAuthError(getErrorMessage('whoami', new Error(errorMsg)));
        return null;
      }
      
      currentUser = userInfo;
      initializeApp();
      return userInfo;
    }).catch(function(error) {
      showAuthError(getErrorMessage('whoami', error));
      return null;
    });
  }
  
  function showAuthError(message) {
    var overlay = document.getElementById('authOverlay');
    overlay.innerHTML = `
      <div class="glass" style="padding:40px;text-align:center;max-width:500px;animation:fadeIn 0.3s ease-in">
        <h2 style="margin:0 0 16px;color:#ef4444">‚ùå Access Denied</h2>
        <p style="margin-bottom:20px;line-height:1.6">${esc(message)}</p>
        <p class="hint" style="margin-bottom:20px">Please contact your administrator to request access.</p>
        <div style="margin-top:20px;display:flex;gap:8px;justify-content:center">
          <button class="btn btn-primary" onclick="location.reload()">üîÑ Retry</button>
          <button class="btn btn-soft" onclick="CacheManager.clear();location.reload()">üîÑ Clear Cache & Retry</button>
        </div>
      </div>
    `;
  }
  
  // Clear cache on logout or errors
  function clearCacheOnError(action) {
    if (action === 'whoami' || action === 'saveTasks' || action === 'loadTasks') {
      // Clear related cache on error
      CacheManager.clear(action);
    }
  }
  
  function initializeApp() {
    // Hide auth overlay
    document.getElementById('authOverlay').style.display = 'none';
    
    // Initialize performance monitoring
    if (PerformanceMonitor) {
      if (window.logger) logger.log('[Performance] Monitoring initialized');
    }
    
    // Periodic memory cleanup (every 5 minutes)
    setInterval(function() {
      MemoryManager.clearLargeData();
    }, 5 * 60 * 1000);
    
    // Show topbar
    document.getElementById('topbar').style.display = 'flex';
    
    // Re-apply branding after elements are visible (ensure logo loads)
    setTimeout(function() {
      loadBrandingConfig();
    }, 100);
    
    // Setup user chip
    setupUserChip();
    
    // Populate hub dropdown based on permissions
    populateHubDropdown();
    
    // Show admin tab if user is admin
    if (currentUser.role === 'admin') {
      document.getElementById('adminTab').style.display = 'block';
    }
    
    // Initialize Global Search
    GlobalSearch.init();
    
    // Initialize PWA
    initializePWA();
    
    // Initialize UI
    initUI();
    
    // Show cover page
    showCover();
  }
  
  /* ====== PWA SUPPORT ====== */
  
  function initializePWA() {
    // Set manifest URL
    try {
      var manifestLink = document.getElementById('pwaManifest');
      if (manifestLink) {
        google.script.url.getLocation(function(location) {
          if (location && location.scriptUrl) {
            manifestLink.href = location.scriptUrl + '?action=manifest';
          }
        });
      }
    } catch (e) {
      if (window.logger) logger.warn('[PWA] Could not set manifest URL:', e);
    }
    
    // Register service worker (disabled for Google Apps Script due to MIME type limitations)
    // Google Apps Script cannot serve service workers with proper MIME type
    // This is a known limitation - PWA features will work but service worker caching won't
    if ('serviceWorker' in navigator) {
      // Check if we're running in Google Apps Script environment
      var isGoogleAppsScript = window.location.href.indexOf('script.google.com') !== -1 || 
                               window.location.href.indexOf('script.googleusercontent.com') !== -1;
      
      if (isGoogleAppsScript) {
        // Skip service worker registration in Google Apps Script
        // The manifest will still work for PWA installation
        if (window.logger) logger.log('[PWA] Service Worker disabled in Google Apps Script environment (MIME type limitation)');
      } else {
        // Try to register service worker in other environments
        var scriptUrl = null;
        
        try {
          google.script.url.getLocation(function(location) {
            scriptUrl = location ? location.scriptUrl : null;
          });
        } catch (e) {
          if (window.logger) logger.warn('[PWA] Could not get script URL:', e);
        }
        
        if (!scriptUrl) {
          // Fallback: try to get from current page
          scriptUrl = window.location.href.split('?')[0];
        }
        
        if (scriptUrl) {
          // Register service worker
          navigator.serviceWorker.register(scriptUrl + '?action=sw')
          .then(function(registration) {
            if (window.logger) logger.log('[PWA] Service Worker registered:', registration.scope);
            
            // Check for updates
            registration.addEventListener('updatefound', function() {
              var newWorker = registration.installing;
              newWorker.addEventListener('statechange', function() {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New service worker available
                  toast('C√≥ phi√™n b·∫£n m·ªõi! L√†m m·ªõi trang ƒë·ªÉ c·∫≠p nh·∫≠t.', 'info', { duration: 5000 });
                }
              });
            });
          })
          .catch(function(error) {
            // Silently handle service worker registration errors
            // This is expected in Google Apps Script environment
            if (error.message && error.message.indexOf('MIME type') === -1) {
              if (window.logger) logger.warn('[PWA] Service Worker registration failed:', error.message);
            }
          });
          
          // Handle service worker updates
          navigator.serviceWorker.addEventListener('controllerchange', function() {
            window.location.reload();
          });
        }
      }
    }
    
    // Handle install prompt
    var deferredPrompt;
    window.addEventListener('beforeinstallprompt', function(e) {
      e.preventDefault();
      deferredPrompt = e;
      
      // Show install button
      showInstallButton();
    });
    
    // Check if app is already installed
    if (window.matchMedia('(display-mode: standalone)').matches) {
      if (window.logger) logger.log('[PWA] Running as standalone app');
    }
  }
  
  function showInstallButton() {
    // Create install button if not exists
    var installBtn = document.getElementById('pwaInstallBtn');
    if (!installBtn) {
      installBtn = document.createElement('button');
      installBtn.id = 'pwaInstallBtn';
      installBtn.className = 'btn btn-primary';
      installBtn.innerHTML = 'üì± C√†i ƒë·∫∑t App';
      installBtn.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.3);';
      installBtn.addEventListener('click', installPWA);
      document.body.appendChild(installBtn);
    }
  }
  
  function installPWA() {
    if (window.deferredPrompt) {
      window.deferredPrompt.prompt();
      window.deferredPrompt.userChoice.then(function(choiceResult) {
        if (choiceResult.outcome === 'accepted') {
          toast('App ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t!', 'ok');
        }
        window.deferredPrompt = null;
        var installBtn = document.getElementById('pwaInstallBtn');
        if (installBtn) installBtn.remove();
      });
    }
  }
  
  function setupUserChip() {
    var chip = document.getElementById('userChip');
    if (!chip) return;
    
    var avatarHtml = '';
    var displayName = currentUser.displayName || currentUser.email.split('@')[0] || 'User';
    var role = currentUser.role === 'admin' ? 'Admin' : 'User';
    var roleColor = currentUser.role === 'admin' ? '#ef4444' : '#3b82f6';
    var roleBg = currentUser.role === 'admin' ? 'rgba(239,68,68,0.1)' : 'rgba(59,130,246,0.1)';
    
    if (currentUser.photoUrl) {
      avatarHtml = `<img src="${esc(currentUser.photoUrl)}" alt="Avatar" class="avatar" style="width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid ${roleColor}">`;
    } else {
      // Default avatar icon if no photo - Professional design
      var initial = displayName.charAt(0).toUpperCase();
      avatarHtml = `<div class="avatar" style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,${roleColor},${roleColor}dd);display:grid;place-items:center;font-weight:700;color:#fff;font-size:18px;border:2px solid ${roleColor}40;box-shadow:0 4px 12px rgba(0,0,0,0.15)">${esc(initial)}</div>`;
    }
    
    // Professional user chip design - Enhanced
    chip.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;padding:10px 18px;background:linear-gradient(135deg, var(--glass-strong) 0%, rgba(255,255,255,0.05) 100%);border-radius:20px;border:1.5px solid ${roleColor}40;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);cursor:pointer;min-width:220px;box-shadow:0 2px 8px rgba(0,0,0,0.08);position:relative;overflow:hidden">
        <!-- Decorative gradient overlay -->
        <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg, ${roleColor}, ${roleColor}80, transparent);opacity:0.6"></div>
        ${avatarHtml}
        <div style="flex:1;min-width:0;position:relative;z-index:1">
          <div style="font-weight:700;font-size:15px;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.3;letter-spacing:-0.2px;margin-bottom:4px">${esc(displayName)}</div>
          <div style="display:flex;align-items:center;gap:6px">
            <span style="display:inline-flex;align-items:center;gap:4px;padding:3px 10px;background:${roleBg};color:${roleColor};border-radius:10px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;border:1px solid ${roleColor}30">${esc(role)}</span>
            <span style="width:6px;height:6px;background:${roleColor};border-radius:50%;opacity:0.6;animation:pulse 2s infinite"></span>
          </div>
        </div>
        <div style="color:var(--muted);font-size:16px;transition:transform 0.2s;flex-shrink:0">‚ñº</div>
      </div>
    `;
    chip.title = currentUser.email + ' ‚Ä¢ ' + role;
    
    // Add hover effect with smooth animation
    var chipDiv = chip.querySelector('div');
    chip.addEventListener('mouseenter', function() {
      if (chipDiv) {
        chipDiv.style.transform = 'translateY(-3px) scale(1.02)';
        chipDiv.style.boxShadow = '0 12px 32px rgba(0,0,0,0.15), 0 0 0 1px ' + roleColor + '60';
        chipDiv.style.borderColor = roleColor + '80';
        var arrow = chipDiv.querySelector('div:last-child');
        if (arrow) arrow.style.transform = 'rotate(180deg)';
      }
    });
    chip.addEventListener('mouseleave', function() {
      if (chipDiv) {
        chipDiv.style.transform = 'translateY(0) scale(1)';
        chipDiv.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
        chipDiv.style.borderColor = roleColor + '40';
        var arrow = chipDiv.querySelector('div:last-child');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
      }
    });
  }
  
  function populateHubDropdown() {
    var hubSel = document.getElementById('hub');
    hubSel.innerHTML = '';
    
    var hubs = [];
    if (currentUser.role === 'admin' || currentUser.hubs === 'ALL') {
      hubs = Object.keys(hubData);
    } else {
      hubs = currentUser.hubs || [];
    }
    
    hubs.forEach(function(hubId) {
      var opt = document.createElement('option');
      opt.value = hubId;
      opt.textContent = hubData[hubId] ? hubData[hubId].name : hubId;
      hubSel.appendChild(opt);
    });
    
    // Set current hub to first available if not accessible
    if (hubs.indexOf(currentHub) === -1 && hubs.length > 0) {
      currentHub = hubs[0];
      localStorage.setItem('currentHubId', currentHub);
    }
    
    hubSel.value = currentHub;
  }
  
  /* ====== API BRIDGE ====== */
  
  // Actions that should be cached
  var cacheableActions = [
    'whoami',
    'getAllUsers',
    'getTaskTemplateFor',
    'loadTasks',
    'getQuestions',
    'getUIConfig',
    'loadReport',
    'getAuditLog'
  ];
  
  // Actions that should not be cached (write operations or frequently changing data)
  var nonCacheableActions = [
    'saveTasks',
    'saveUser',
    'deleteUser',
    'submitQuestion',
    'answerQuestion',
    'sendChatMessage',
    'saveNotes',
    'presenceHeartbeat',
    'logEvent',
    'getCategoryChangeLog' // Category change logs are dynamic and should not be cached
  ];
  
  function callApi(action, data, options) {
    var perfLabel = PerformanceMonitor.start('api-' + action);
    options = options || {};
    var useCache = options.useCache !== false && cacheableActions.indexOf(action) !== -1;
    var skipCache = options.skipCache || nonCacheableActions.indexOf(action) !== -1;
    var cacheTTL = options.cacheTTL || CacheManager.config.defaultTTL;
    
    // Try to get from cache first (if cacheable and not skipped)
    if (useCache && !skipCache) {
      var cached = CacheManager.get(action, data);
      if (cached !== null) {
        console.log('[Cache] Hit:', action, data);
        if (perfLabel) PerformanceMonitor.end(perfLabel);
        return Promise.resolve(cached);
      }
    }
    
    var hasGS = typeof google !== 'undefined' && google.script && google.script.run;
    
    if (!hasGS) {
      // Preview mode - call preview server API via fetch
      console.log('[Preview API] Calling:', action, data);
      return fetch('/api/' + action, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data || {})
      })
      .then(function(response) {
        console.log('[Preview API] Response status:', response.status);
        if (!response.ok) {
          throw new Error('API request failed: ' + response.status);
        }
        return response.json();
      })
      .then(function(jsonData) {
        console.log('[Preview API] Response data:', action, jsonData);
        // Cache the response if cacheable
        if (useCache && !skipCache && jsonData && !jsonData.error) {
          CacheManager.set(action, data, jsonData, cacheTTL);
        }
        // End performance monitoring
        if (perfLabel) {
          var duration = PerformanceMonitor.end(perfLabel);
          PerformanceMonitor.checkPerformance('api-' + action, duration);
        }
        return jsonData;
      })
      .catch(function(error) {
        console.error('[Preview API Error]', action, error);
        // End performance monitoring even on error
        if (perfLabel) PerformanceMonitor.end(perfLabel);
        // Fallback to mock if preview server fails
        return mockApiCall(action, data);
      });
    }
    
    return new Promise(function(resolve, reject) {
      var runner = google.script.run
        .withSuccessHandler(function(result) {
          // Cache the response if cacheable
          if (useCache && !skipCache && result && !result.error) {
            CacheManager.set(action, data, result, cacheTTL);
          }
          // End performance monitoring
          if (perfLabel) {
            var duration = PerformanceMonitor.end(perfLabel);
            PerformanceMonitor.checkPerformance('api-' + action, duration);
          }
          resolve(result);
        })
        .withFailureHandler(function(error) {
          console.error('[API Error]', action, error);
          // End performance monitoring even on error
          if (perfLabel) PerformanceMonitor.end(perfLabel);
          // Provide better error messages
          var errorMessage = getErrorMessage(action, error);
          reject(new Error(errorMessage));
        });
      
      switch(action) {
        // Authentication
        case 'whoami':
          return runner.whoami();
        
        // Tasks CRUD
        case 'loadTasks':
          return runner.loadTasks(data.storageKey);
        case 'saveTasks':
          return runner.saveTasks(data.storageKey, data.tasks);
        case 'getTaskTemplateFor':
          return runner.getTaskTemplateFor(data.hubId);
        
        // Reports Module
        case 'loadReport':
          return runner.loadReport(data);
        case 'exportToExcel':
          return runner.exportToExcel(data);
        case 'exportToPDF':
          return runner.exportToPDF(data);
        
        // Highlight Module
        case 'getHighlights':
          return runner.getHighlights(data);
        
        // Access Log Module
        case 'getAuditLog':
          return runner.getAuditLog(data);
        
        // Admin Module
        case 'getAllUsers':
          return runner.getAllUsers();
        case 'saveUser':
          return runner.saveUser(data);
        case 'deleteUser':
          return runner.deleteUser(data.email);
        
        // Q&A Module
        case 'submitQuestion':
          return runner.submitQuestion(data);
        case 'getQuestions':
          return runner.getQuestions(data);
        case 'answerQuestion':
          return runner.answerQuestion(data);
        
        // Unfinished Tasks Module
        case 'loadUnfinishedTasks':
          return runner.loadUnfinishedTasks(data);
        
        // Chat Module
        case 'sendChatMessage':
          return runner.sendChatMessage(data);
        case 'getChatMessages':
          return runner.getChatMessages(data);
        
        // Access Log Module
        case 'exportAccessLog':
          return runner.exportAccessLog(data);
        
        // Notes Module
        case 'saveNotes':
          return runner.saveNotes(data);
        case 'loadNotes':
          return runner.loadNotes(data);
        
        // Presence Module
        case 'presenceHeartbeat':
          return runner.presenceHeartbeat(data);
        case 'getOnlineUsers':
          return runner.getOnlineUsers(data);
        
        // Audit Logging
        case 'logEvent':
          return runner.logAudit(currentUser.email, data.action, data.hub, data.details);
        
        // Calendar Integration
        case 'syncSlaToCalendar':
          return runner.syncSlaToCalendar(data);
        case 'removeSlaFromCalendar':
          return runner.removeSlaFromCalendar(data.hub, data.dateStr);
        
        // UIConfig
        case 'getUIConfig':
          return runner.getUIConfig();
        
        // Task Notes (for Unfinished tasks)
        case 'saveTaskNote':
          return runner.saveTaskNote(data);
        
        // Utility
        case 'ping':
          return runner.ping();
        
        default:
          reject(new Error('Unknown action: ' + action));
      }
    });
  }
  
  function mockApiCall(action, data) {
    return new Promise(function(resolve) {
      setTimeout(function() {
        var mockData = {
          whoami: {
            email: 'admin@spx.vn',
            role: 'admin',
            hubs: 'ALL',
            displayName: 'Admin User',
            photoUrl: 'https://lh3.googleusercontent.com/a/default-user'
          },
          loadTasks: [],
          saveTasks: { status: 'ok' },
          getTaskTemplateFor: [],
          
          // Reports Module
          loadReport: {
            tasks: [],
            summary: {
              total: 0,
              completed: 0,
              pending: 0,
              onTime: 0,
              late: 0,
              onTimeRate: 0
            },
            hub: data ? data.hub : '',
            start: data ? data.start : '',
            end: data ? data.end : ''
          },
          exportToExcel: {
            url: 'https://docs.google.com/spreadsheets/d/mock-id',
            id: 'mock-spreadsheet-id'
          },
          exportToPDF: {
            url: 'https://drive.google.com/file/d/mock-id',
            id: 'mock-file-id'
          },
          
          // Highlight Module
          getHighlights: {
            activeUsers: 0,
            visits: 0,
            interactions: 0,
            tasksTotal: 0,
            tasksDone: 0,
            slaOnTime: 0,
            slaLate: 0,
            slaRate: 0,
            visitsByHour: Array.from({length: 24}, function(_, i) {
              return { hour: i, count: 0 };
            }),
            categories: []
          },
          
          // Access Log Module
          getAuditLog: [],
          
          // Admin Module
          getAllUsers: [
            { email: 'admin@spx.vn', hub: 'ALL', role: 'admin', active: true, displayName: 'Admin' },
            { email: 'user1@spx.vn', hub: '80TVH01', role: 'user', active: true, displayName: 'User 1' }
          ],
          saveUser: { status: 'ok' },
          deleteUser: { status: 'ok' },
          
          // Notes Module
          saveNotes: { status: 'ok' },
          loadNotes: [],
          
          // Presence Module
          presenceHeartbeat: { status: 'ok' },
          getOnlineUsers: [],
          
          // Audit Logging
          logEvent: { status: 'ok' },
          
          // Calendar
          syncSlaToCalendar: { ok: true, created: 0, skipped: 0, errors: 0 },
          removeSlaFromCalendar: { ok: true, removed: 0 },
          
          // Utility
          ping: 'pong'
        };
        
        resolve(mockData[action] || {});
      }, 300);
    });
  }
  
  /* ====== UTILITY FUNCTIONS ====== */
  
  function esc(s) {
    return String(s || '').replace(/[&<>"']/g, function(m) {
      return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
    });
  }
  
  /* ====== NOTIFICATIONS SYSTEM ====== */
  
  var NotificationManager = {
    // Notification center
    notifications: [],
    maxNotifications: 50,
    
    // Add notification
    add: function(message, type, options) {
      options = options || {};
      var notification = {
        id: 'notif_' + Date.now() + '_' + Math.random(),
        message: message,
        type: type || 'info',
        timestamp: Date.now(),
        read: false,
        actions: options.actions || [],
        duration: options.duration || 3000,
        persistent: options.persistent || false
      };
      
      this.notifications.unshift(notification);
      
      // Enforce max notifications
      if (this.notifications.length > this.maxNotifications) {
        this.notifications = this.notifications.slice(0, this.maxNotifications);
      }
      
      // Show toast
      this.showToast(notification);
      
      // Show browser notification if enabled
      if (options.browserNotification && 'Notification' in window && Notification.permission === 'granted') {
        this.showBrowserNotification(notification);
      }
      
      // Update notification center UI if exists
      this.updateNotificationCenter();
      
      return notification.id;
    },
    
    // Show toast - Enhanced with progress bar and actions
    showToast: function(notification) {
    try {
      var wrap = document.getElementById('toast');
        if (!wrap) {
          // Create toast container if doesn't exist
          wrap = document.createElement('div');
          wrap.id = 'toast';
          document.body.appendChild(wrap);
        }
        
      var el = document.createElement('div');
        el.className = 'toast ' + (notification.type || 'ok');
        el.setAttribute('data-notification-id', notification.id);
        
        // Add icon based on type
        var icons = {
          'ok': '‚úÖ',
          'err': '‚ùå',
          'warn': '‚ö†Ô∏è',
          'info': '‚ÑπÔ∏è'
        };
        var icon = icons[notification.type] || '‚ÑπÔ∏è';
        
        // Build toast HTML
        var html = '<div class="toast-content">';
        html += '<span class="toast-icon">' + icon + '</span>';
        html += '<span class="toast-message">' + esc(notification.message) + '</span>';
        html += '<button class="toast-close" aria-label="ƒê√≥ng">√ó</button>';
        html += '</div>';
        
        // Add actions if provided
        if (notification.actions && notification.actions.length > 0) {
          html += '<div class="toast-actions">';
          notification.actions.forEach(function(action) {
            var btnClass = action.primary ? 'toast-action-btn primary' : 'toast-action-btn';
            html += '<button class="' + btnClass + '" data-action="' + esc(action.label) + '">' + esc(action.label) + '</button>';
          });
          html += '</div>';
        }
        
        // Add progress bar if not persistent
        if (!notification.persistent) {
          html += '<div class="toast-progress"><div class="toast-progress-bar" style="animation-duration: ' + notification.duration + 'ms"></div></div>';
        }
        
        el.innerHTML = html;
        
        // Add close button handler
        var closeBtn = el.querySelector('.toast-close');
        if (closeBtn) {
          closeBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            this.dismiss(el);
          }.bind(this));
        }
        
        // Add action button handlers
        var actionBtns = el.querySelectorAll('.toast-action-btn');
        actionBtns.forEach(function(btn) {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            var actionLabel = this.getAttribute('data-action');
            var action = notification.actions.find(function(a) { return a.label === actionLabel; });
            if (action && action.action) {
              action.action();
            }
            this.dismiss(el);
          }.bind(this));
        }.bind(this));
        
        // Add click handler to dismiss (click anywhere on toast)
        el.addEventListener('click', function(e) {
          // Don't dismiss if clicking on action buttons
          if (!e.target.closest('.toast-actions') && !e.target.closest('.toast-close')) {
            this.dismiss(el);
          }
        }.bind(this));
        
      wrap.appendChild(el);
        
        // Auto-dismiss if not persistent
        if (!notification.persistent) {
      setTimeout(function() {
            this.dismiss(el);
          }.bind(this), notification.duration);
        }
    } catch (e) {
        console.error('Toast error:', e);
        alert(notification.message); // Fallback
      }
    },
    
    // Dismiss toast - Enhanced with slide-out animation
    dismiss: function(el) {
      if (!el) return;
      el.classList.add('slide-out');
      setTimeout(function() {
        if (el && el.parentNode) {
          el.parentNode.removeChild(el);
        }
      }, 300);
    },
    
    // Show browser notification
    showBrowserNotification: function(notification) {
      try {
        new Notification('[SPX] Daily Checklist', {
          body: notification.message,
          icon: '/favicon.ico',
          tag: notification.id,
          requireInteraction: notification.persistent
        });
      } catch (e) {
        console.warn('Browser notification error:', e);
      }
    },
    
    // Request browser notification permission
    requestPermission: function() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(function(permission) {
          console.log('Notification permission:', permission);
        });
      }
    },
    
    // Update notification center UI
    updateNotificationCenter: function() {
      // This will be called when notification center UI is implemented
      // For now, just log
      console.log('Notifications:', this.notifications.length);
    },
    
    // Mark as read
    markAsRead: function(id) {
      var notification = this.notifications.find(function(n) { return n.id === id; });
      if (notification) {
        notification.read = true;
        this.updateNotificationCenter();
      }
    },
    
    // Clear all notifications
    clearAll: function() {
      this.notifications = [];
      this.updateNotificationCenter();
    }
  };
  
  // Request notification permission on load
  if (typeof window !== 'undefined') {
    window.addEventListener('load', function() {
      NotificationManager.requestPermission();
    });
  }
  
  // Enhanced toast function
  function toast(msg, type, options) {
    return NotificationManager.add(msg, type, options);
  }

  /* ====== PERFORMANCE MONITORING ====== */
  
  var PerformanceMonitor = {
    metrics: {
      renderTimes: [],
      apiCallTimes: [],
      memoryUsage: []
    },
    
    // Start timing
    start: function(label) {
      if (!window.performance || !window.performance.mark) return null;
      window.performance.mark(label + '-start');
      return label;
    },
    
    // End timing
    end: function(label) {
      if (!window.performance || !window.performance.measure) return null;
      try {
        window.performance.mark(label + '-end');
        window.performance.measure(label, label + '-start', label + '-end');
        var measure = window.performance.getEntriesByName(label)[0];
        var duration = measure.duration;
        
        // Store metric
        if (label.indexOf('render') !== -1) {
          this.metrics.renderTimes.push({ label: label, duration: duration, timestamp: Date.now() });
          // Keep only last 50
          if (this.metrics.renderTimes.length > 50) {
            this.metrics.renderTimes.shift();
          }
        } else if (label.indexOf('api') !== -1) {
          this.metrics.apiCallTimes.push({ label: label, duration: duration, timestamp: Date.now() });
          if (this.metrics.apiCallTimes.length > 50) {
            this.metrics.apiCallTimes.shift();
          }
        }
        
        // Clean up
        window.performance.clearMarks(label + '-start');
        window.performance.clearMarks(label + '-end');
        window.performance.clearMeasures(label);
        
        return duration;
      } catch (e) {
        return null;
      }
    },
    
    // Get memory usage (if available)
    getMemoryUsage: function() {
      if (performance.memory) {
        return {
          used: Math.round(performance.memory.usedJSHeapSize / 1048576), // MB
          total: Math.round(performance.memory.totalJSHeapSize / 1048576), // MB
          limit: Math.round(performance.memory.jsHeapSizeLimit / 1048576) // MB
        };
      }
      return null;
    },
    
    // Get average render time
    getAverageRenderTime: function() {
      if (this.metrics.renderTimes.length === 0) return 0;
      var sum = this.metrics.renderTimes.reduce(function(acc, m) { return acc + m.duration; }, 0);
      return Math.round(sum / this.metrics.renderTimes.length);
    },
    
    // Get stats
    getStats: function() {
      return {
        renderTimes: this.metrics.renderTimes,
        apiCallTimes: this.metrics.apiCallTimes,
        memory: this.getMemoryUsage(),
        averageRenderTime: this.getAverageRenderTime()
      };
    },
    
    // Log performance warning if slow (only for operations > 2000ms to reduce noise)
    checkPerformance: function(label, duration) {
      var log = window.logger ? logger.warn : console.warn;
      var logInfo = window.logger ? logger.log : console.log;
      
      if (duration && duration > 2000) {
        log('[Performance] Slow operation detected:', label, Math.round(duration) + 'ms');
      } else if (duration && duration > 1000) {
        // Log as info for moderate slowness (1000-2000ms)
        logInfo('[Performance] Moderate operation time:', label, Math.round(duration) + 'ms');
      }
    }
  };
  
  /* ====== VIRTUAL SCROLLING ====== */
  
  /**
   * Virtual scrolling implementation for large lists
   * Only renders visible items + buffer
   */
  var VirtualScroller = {
    // Create virtual scroller
    create: function(container, items, renderItem, options) {
      options = options || {};
      var itemHeight = options.itemHeight || 60; // Default item height
      var buffer = options.buffer || 5; // Number of items to render outside viewport
      var containerHeight = container.clientHeight || 600;
      var visibleCount = Math.ceil(containerHeight / itemHeight);
      
      // Create wrapper
      var wrapper = document.createElement('div');
      wrapper.style.position = 'relative';
      wrapper.style.height = (items.length * itemHeight) + 'px';
      wrapper.style.overflow = 'hidden';
      
      // Create viewport
      var viewport = document.createElement('div');
      viewport.style.position = 'absolute';
      viewport.style.top = '0';
      viewport.style.left = '0';
      viewport.style.right = '0';
      viewport.style.height = containerHeight + 'px';
      viewport.style.overflow = 'auto';
      
      // Create content
      var content = document.createElement('div');
      content.style.position = 'relative';
      
      var currentStart = 0;
      var currentEnd = Math.min(visibleCount + buffer * 2, items.length);
      
      function renderVisible() {
        var start = Math.max(0, currentStart - buffer);
        var end = Math.min(items.length, currentEnd + buffer);
        
        content.innerHTML = '';
        content.style.height = (items.length * itemHeight) + 'px';
        content.style.paddingTop = (start * itemHeight) + 'px';
        
        for (var i = start; i < end; i++) {
          var item = items[i];
          var itemEl = renderItem(item, i);
          if (itemEl) {
            itemEl.style.position = 'absolute';
            itemEl.style.top = (i * itemHeight) + 'px';
            itemEl.style.left = '0';
            itemEl.style.right = '0';
            itemEl.style.height = itemHeight + 'px';
            content.appendChild(itemEl);
          }
        }
      }
      
      viewport.addEventListener('scroll', function() {
        var scrollTop = viewport.scrollTop;
        var newStart = Math.floor(scrollTop / itemHeight);
        var newEnd = Math.min(newStart + visibleCount + buffer * 2, items.length);
        
        if (newStart !== currentStart || newEnd !== currentEnd) {
          currentStart = newStart;
          currentEnd = newEnd;
          renderVisible();
        }
      });
      
      viewport.appendChild(content);
      wrapper.appendChild(viewport);
      container.innerHTML = '';
      container.appendChild(wrapper);
      
      // Initial render
      renderVisible();
      
      return {
        update: function(newItems) {
          items = newItems;
          wrapper.style.height = (items.length * itemHeight) + 'px';
          renderVisible();
        },
        scrollTo: function(index) {
          viewport.scrollTop = index * itemHeight;
        }
      };
    }
  };
  
  /* ====== LAZY LOADING ====== */
  
  var LazyLoader = {
    // Lazy load images
    loadImage: function(img, src) {
      if (!img || !src) return;
      
      // Use Intersection Observer if available
      if ('IntersectionObserver' in window) {
        var observer = new IntersectionObserver(function(entries) {
          entries.forEach(function(entry) {
            if (entry.isIntersecting) {
              var target = entry.target;
              if (target.dataset.src) {
                target.src = target.dataset.src;
                target.removeAttribute('data-src');
                observer.unobserve(target);
              }
            }
          });
        }, {
          rootMargin: '50px' // Start loading 50px before image enters viewport
        });
        
        img.dataset.src = src;
        img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1 1"%3E%3C/svg%3E'; // Placeholder
        observer.observe(img);
      } else {
        // Fallback: load immediately
        img.src = src;
      }
    },
    
    // Lazy load components (defer rendering)
    loadComponent: function(callback, delay) {
      delay = delay || 0;
      if (delay > 0) {
        setTimeout(callback, delay);
      } else {
        // Use requestIdleCallback if available
        if ('requestIdleCallback' in window) {
          requestIdleCallback(callback, { timeout: 1000 });
        } else {
          setTimeout(callback, 0);
        }
      }
    }
  };
  
  /* ====== MEMORY MANAGEMENT ====== */
  
  var MemoryManager = {
    // Clean up event listeners
    cleanup: function(element) {
      if (!element) return;
      
      // Clone and replace to remove all event listeners
      var newElement = element.cloneNode(true);
      if (element.parentNode) {
        element.parentNode.replaceChild(newElement, element);
      }
      
      return newElement;
    },
    
    // Clear large data structures
    clearLargeData: function() {
      // Clear old cache entries
      if (CacheManager && CacheManager.cleanExpired) {
        CacheManager.cleanExpired();
      }
      
      // Clear old performance metrics
      if (PerformanceMonitor && PerformanceMonitor.metrics) {
        if (PerformanceMonitor.metrics.renderTimes.length > 100) {
          PerformanceMonitor.metrics.renderTimes = PerformanceMonitor.metrics.renderTimes.slice(-50);
        }
        if (PerformanceMonitor.metrics.apiCallTimes.length > 100) {
          PerformanceMonitor.metrics.apiCallTimes = PerformanceMonitor.metrics.apiCallTimes.slice(-50);
        }
      }
    },
    
    // Force garbage collection (if available)
    forceGC: function() {
      if (window.gc) {
        window.gc();
      }
    }
  };
  
  /* ====== COMPONENT LIBRARY ====== */
  
  /**
   * Create a button component
   * @param {string} text - Button text
   * @param {Object} options - Configuration object
   * @param {string} options.variant - Button variant: 'primary', 'secondary', 'danger', 'ghost', 'soft'
   * @param {string} options.icon - Icon/emoji to display before text
   * @param {Function} options.onClick - Click handler
   * @param {boolean} options.disabled - Whether button is disabled
   * @param {string} options.size - Button size: 'sm', 'md', 'lg'
   * @param {string} options.type - Button type: 'button', 'submit', 'reset'
   * @returns {HTMLElement} Button element
   */
  function createButton(text, options) {
    options = options || {};
    var variant = options.variant || 'primary';
    var size = options.size || 'md';
    var type = options.type || 'button';
    
    var btn = document.createElement('button');
    btn.type = type;
    btn.className = 'btn btn-' + variant;
    if (size !== 'md') {
      btn.className += ' btn-' + size;
    }
    if (options.disabled) {
      btn.disabled = true;
    }
    
    var content = '';
    if (options.icon) {
      content += '<span>' + options.icon + '</span> ';
    }
    content += esc(text);
    btn.innerHTML = content;
    
    if (options.onClick) {
      btn.addEventListener('click', options.onClick);
    }
    
    return btn;
  }
  
  /**
   * Create an input component
   * @param {Object} options - Configuration object
   * @param {string} options.type - Input type: 'text', 'email', 'password', 'date', etc.
   * @param {string} options.placeholder - Placeholder text
   * @param {string} options.value - Initial value
   * @param {string} options.id - Input ID
   * @param {string} options.name - Input name
   * @param {boolean} options.required - Whether input is required
   * @param {boolean} options.disabled - Whether input is disabled
   * @param {Function} options.onChange - Change handler
   * @param {string} options.label - Label text (optional)
   * @param {string} options.error - Error message (optional)
   * @returns {HTMLElement} Input wrapper element
   */
  function createInput(options) {
    options = options || {};
    var wrapper = document.createElement('div');
    wrapper.className = 'group';
    
    if (options.label) {
      var label = document.createElement('label');
      label.className = 'label';
      label.setAttribute('for', options.id || '');
      label.innerHTML = esc(options.label);
      if (options.required) {
        label.innerHTML += ' <span style="color:var(--color-error)">*</span>';
      }
      wrapper.appendChild(label);
    }
    
    var control = document.createElement('div');
    control.className = 'control';
    if (options.error) {
      control.classList.add('control-error');
    }
    
    var input = document.createElement('input');
    input.type = options.type || 'text';
    if (options.id) input.id = options.id;
    if (options.name) input.name = options.name;
    if (options.placeholder) input.placeholder = options.placeholder;
    if (options.value) input.value = options.value;
    if (options.required) input.required = true;
    if (options.disabled) input.disabled = true;
    
    if (options.onChange) {
      input.addEventListener('change', options.onChange);
      input.addEventListener('input', options.onChange);
    }
    
    control.appendChild(input);
    wrapper.appendChild(control);
    
    if (options.error) {
      var errorMsg = document.createElement('div');
      errorMsg.className = 'caption';
      errorMsg.style.color = 'var(--color-error)';
      errorMsg.style.marginTop = 'var(--space-xs)';
      errorMsg.textContent = options.error;
      wrapper.appendChild(errorMsg);
    }
    
    return wrapper;
  }
  
  /**
   * Create a select component
   * @param {Object} options - Configuration object
   * @param {Array} options.options - Array of {value, label} objects
   * @param {string} options.value - Selected value
   * @param {string} options.id - Select ID
   * @param {string} options.name - Select name
   * @param {string} options.label - Label text (optional)
   * @param {Function} options.onChange - Change handler
   * @returns {HTMLElement} Select wrapper element
   */
  function createSelect(options) {
    options = options || {};
    var wrapper = document.createElement('div');
    wrapper.className = 'group';
    
    if (options.label) {
      var label = document.createElement('label');
      label.className = 'label';
      label.setAttribute('for', options.id || '');
      label.textContent = options.label;
      wrapper.appendChild(label);
    }
    
    var control = document.createElement('div');
    control.className = 'control';
    
    var select = document.createElement('select');
    if (options.id) select.id = options.id;
    if (options.name) select.name = options.name;
    
    if (options.options && options.options.length > 0) {
      options.options.forEach(function(opt) {
        var option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label || opt.value;
        if (options.value === opt.value) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    }
    
    if (options.onChange) {
      select.addEventListener('change', options.onChange);
    }
    
    control.appendChild(select);
    wrapper.appendChild(control);
    
    return wrapper;
  }
  
  /**
   * Create a card component
   * @param {Object} options - Configuration object
   * @param {string} options.title - Card title (optional)
   * @param {string|HTMLElement} options.content - Card content
   * @param {string} options.variant - Card variant: 'default', 'elevated', 'outlined'
   * @param {boolean} options.interactive - Whether card is clickable
   * @param {Function} options.onClick - Click handler (if interactive)
   * @returns {HTMLElement} Card element
   */
  function createCard(options) {
    options = options || {};
    var card = document.createElement('div');
    card.className = 'glass';
    
    if (options.variant === 'elevated') {
      card.style.boxShadow = 'var(--elevation-3)';
    } else if (options.variant === 'outlined') {
      card.style.border = '2px solid var(--stroke)';
    }
    
    if (options.interactive) {
      card.classList.add('card-interactive');
      if (options.onClick) {
        card.addEventListener('click', options.onClick);
      }
    }
    
    if (options.title) {
      var title = document.createElement('h3');
      title.className = 'h4';
      title.textContent = options.title;
      card.appendChild(title);
    }
    
    var content = document.createElement('div');
    if (typeof options.content === 'string') {
      content.innerHTML = options.content;
    } else if (options.content instanceof HTMLElement) {
      content.appendChild(options.content);
    }
    card.appendChild(content);
    
    return card;
  }
  
  /**
   * Create a badge component
   * @param {string} text - Badge text
   * @param {Object} options - Configuration object
   * @param {string} options.variant - Badge variant: 'default', 'success', 'error', 'warning', 'info'
   * @param {string} options.size - Badge size: 'sm', 'md', 'lg'
   * @returns {HTMLElement} Badge element
   */
  function createBadge(text, options) {
    options = options || {};
    var variant = options.variant || 'default';
    var size = options.size || 'md';
    
    var badge = document.createElement('span');
    badge.className = 'badge badge-' + variant + ' badge-' + size;
    badge.textContent = text;
    
    return badge;
  }
  
  /**
   * Create a modal component
   * @param {Object} options - Configuration object
   * @param {string|HTMLElement} options.content - Modal content
   * @param {string} options.title - Modal title (optional)
   * @param {boolean} options.closable - Whether modal can be closed (default: true)
   * @param {Function} options.onClose - Close handler
   * @returns {HTMLElement} Modal element
   */
  function createModal(options) {
    options = options || {};
    var modal = document.createElement('div');
    modal.className = 'modal';
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:grid;place-items:center;z-index:9999;animation:fadeIn 0.2s ease;';
    
    var box = document.createElement('div');
    box.className = 'glass';
    box.style.cssText = 'max-width:600px;width:90%;max-height:80vh;overflow:auto;border-radius:16px;animation:slideInUp 0.3s ease;';
    box.setAttribute('role', 'document');
    
    if (options.title) {
      var header = document.createElement('div');
      header.style.cssText = 'padding:20px 24px;border-bottom:1px solid var(--stroke);display:flex;justify-content:space-between;align-items:center;';
      
      var title = document.createElement('h3');
      title.className = 'h3';
      title.style.margin = '0';
      title.textContent = options.title;
      header.appendChild(title);
      
      if (options.closable !== false) {
        var closeBtn = createButton('√ó', {
          variant: 'ghost',
          onClick: function() {
            if (options.onClose) options.onClose();
            modal.remove();
          }
        });
        closeBtn.style.cssText = 'min-width:auto;width:32px;height:32px;padding:0;font-size:24px;';
        closeBtn.setAttribute('aria-label', 'ƒê√≥ng');
        header.appendChild(closeBtn);
      }
      
      box.appendChild(header);
    }
    
    var content = document.createElement('div');
    content.style.padding = '24px';
    if (typeof options.content === 'string') {
      content.innerHTML = options.content;
    } else if (options.content instanceof HTMLElement) {
      content.appendChild(options.content);
    }
    box.appendChild(content);
    
    modal.appendChild(box);
    
    // Close on backdrop click
    if (options.closable !== false) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          if (options.onClose) options.onClose();
          modal.remove();
        }
      });
    }
    
    // Close on Escape key
    var escapeHandler = function(e) {
      if (e.key === 'Escape' && options.closable !== false) {
        if (options.onClose) options.onClose();
        modal.remove();
        document.removeEventListener('keydown', escapeHandler);
      }
    };
    document.addEventListener('keydown', escapeHandler);
    
    return modal;
  }
  
  /* ====== EMPTY STATE HELPER ====== */
  
  /**
   * Create a beautiful empty state component
   * @param {Object} options - Configuration object
   * @param {string} options.icon - Emoji or icon (default: "üìã")
   * @param {string} options.title - Title text
   * @param {string} options.description - Description text
   * @param {string} options.actionLabel - Action button label (optional)
   * @param {Function} options.onAction - Action button callback (optional)
   * @returns {HTMLElement} Empty state element
   */
  function createEmptyState(options) {
    options = options || {};
    var icon = options.icon || 'üìã';
    var title = options.title || 'Kh√¥ng c√≥ d·ªØ li·ªáu';
    var description = options.description || '';
    var actionLabel = options.actionLabel;
    var onAction = options.onAction;
    
    var emptyState = document.createElement('div');
    emptyState.className = 'empty-state glass';
    
    var html = '<div class="empty-state-icon">' + icon + '</div>';
    html += '<h3 class="empty-state-title">' + esc(title) + '</h3>';
    if (description) {
      html += '<p class="empty-state-description">' + esc(description) + '</p>';
    }
    emptyState.innerHTML = html;
    
    // Attach action handler properly
    if (actionLabel && onAction) {
      var actionDiv = document.createElement('div');
      actionDiv.className = 'empty-state-action';
      var actionBtn = document.createElement('button');
      actionBtn.className = 'btn btn-primary';
      actionBtn.textContent = actionLabel;
      actionBtn.addEventListener('click', onAction);
      actionDiv.appendChild(actionBtn);
      emptyState.appendChild(actionDiv);
    }
    
    return emptyState;
  }
  
  /* ====== TASK INFO POPUP - NEW FEATURE ====== */
  
  function showTaskInfoModal(task) {
    // Get or create modal
    var modal = document.getElementById('taskInfoModal');
    
    if (!modal) {
      // Create modal if doesn't exist
      modal = document.createElement('div');
      modal.id = 'taskInfoModal';
      modal.className = 'task-info-modal';
      modal.innerHTML = `
        <div class="task-info-content glass">
          <div class="task-info-header">
            <h3 id="taskInfoTitle"></h3>
            <button class="task-info-close" onclick="window.closeTaskInfoModal()" title="ƒê√≥ng">‚úï</button>
          </div>
          <div class="task-info-body" id="taskInfoBody"></div>
          <div class="task-info-meta" id="taskInfoMeta"></div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Close on backdrop click
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          if (typeof window.closeTaskInfoModal === 'function') {
            window.closeTaskInfoModal();
          }
        }
      });
      
      // Close on Escape key
      var escapeHandler = function(e) {
        if (e.key === 'Escape') {
          if (typeof window.closeTaskInfoModal === 'function') {
            window.closeTaskInfoModal();
          }
          document.removeEventListener('keydown', escapeHandler);
        }
      };
      document.addEventListener('keydown', escapeHandler);
    }
    
    // Populate modal content
    var titleEl = document.getElementById('taskInfoTitle');
    var bodyEl = document.getElementById('taskInfoBody');
    var metaEl = document.getElementById('taskInfoMeta');
    
    titleEl.textContent = task.text || 'Chi ti·∫øt Task';
    
    // Task description - ensure we get the info field correctly
    var taskInfo = task.info || task.description || '';
    if (taskInfo && String(taskInfo).trim() !== '') {
      var infoText = String(taskInfo).trim();
      bodyEl.innerHTML = '<div style="font-size:14px;line-height:1.8;color:var(--fg);white-space:pre-wrap;word-wrap:break-word">' + esc(infoText).replace(/\n/g, '<br>') + '</div>';
    } else {
      bodyEl.innerHTML = '<p class="hint" style="color:var(--fg2);font-style:italic">Kh√¥ng c√≥ m√¥ t·∫£ chi ti·∫øt cho task n√†y.</p>';
    }
    
    // Task metadata
    var metaHTML = '';
    
    metaHTML += '<div class="task-info-meta-item">';
    metaHTML += '<strong>Danh m·ª•c</strong>';
    metaHTML += '<span>' + esc(task.category || 'Kh√¥ng x√°c ƒë·ªãnh') + '</span>';
    metaHTML += '</div>';
    
    if (task.sla) {
      metaHTML += '<div class="task-info-meta-item">';
      metaHTML += '<strong>SLA Deadline</strong>';
      metaHTML += '<span>‚è∞ ' + esc(task.sla) + '</span>';
      metaHTML += '</div>';
    }
    
    if (task.isLead) {
      metaHTML += '<div class="task-info-meta-item">';
      metaHTML += '<strong>Ph√¢n c√¥ng</strong>';
      metaHTML += '<span>üëî LEAD Task</span>';
      metaHTML += '</div>';
    }
    
    if (task.link) {
      metaHTML += '<div class="task-info-meta-item" style="grid-column: span 2">';
      metaHTML += '<strong>Quick Link</strong>';
      metaHTML += '<a href="' + esc(task.link) + '" target="_blank" class="task-link">M·ªü link</a>';
      metaHTML += '</div>';
    }
    
    metaEl.innerHTML = metaHTML;
    
    // Show modal
    modal.classList.add('active');
    
    // Log event
    callApi('logEvent', {
      action: 'VIEW_TASK_INFO',
      hub: currentHub,
      details: { taskId: task.id, taskText: task.text }
    });
  }
  
  function closeTaskInfoModal() {
    var modal = document.getElementById('taskInfoModal');
    if (modal) {
      modal.classList.remove('active');
    }
  }
  
  // Expose to global scope for onclick handlers
  window.closeTaskInfoModal = closeTaskInfoModal;
  
  /* ====== TASK NOTE MODAL - NEW FEATURE ====== */
  
  function showTaskNoteModal(task) {
    var dateEl = $('#date');
    var dateStr = (dateEl && dateEl.value) ? dateEl.value : todayStr();
    var storageKey = 'notes_' + currentHub + '_' + dateStr;
    
    // Load existing notes for this task
    callApi('loadNotes', { storageKey: storageKey }).then(function(notes) {
      if (!Array.isArray(notes)) notes = [];
      
      // Filter notes for this specific task
      var taskNotes = notes.filter(function(n) {
        return n.taskText === task.text;
      });
      
      // Create modal
      var modal = createModal({
        title: 'üìù Ghi ch√∫: ' + (task.text || 'Task'),
        content: `
          <div style="margin-bottom:16px">
            <label style="display:block;font-size:13px;color:var(--muted);margin-bottom:6px">Ghi ch√∫ s·ª± v·ª• c√≥ li√™n quan:</label>
            <textarea id="taskNoteInput" rows="4" placeholder="Nh·∫≠p ghi ch√∫..." class="control" style="width:100%;resize:vertical;font-size:14px;padding:12px">${taskNotes.length > 0 ? taskNotes.map(function(n) { return n.note; }).join('\n\n') : ''}</textarea>
          </div>
          ${taskNotes.length > 0 ? `
          <div style="margin-bottom:16px;padding:12px;background:rgba(0,0,0,0.03);border-radius:8px">
            <div style="font-size:12px;color:var(--muted);margin-bottom:8px;font-weight:500">üìã L·ªãch s·ª≠ ghi ch√∫:</div>
            ${taskNotes.map(function(n, idx) {
              return `<div style="padding:8px;background:var(--glass);border-radius:6px;margin-bottom:8px;font-size:13px;line-height:1.5">
                <div style="color:var(--ink);white-space:pre-wrap">${esc(n.note)}</div>
                <div style="font-size:11px;color:var(--muted);margin-top:4px">${n.author ? (n.author.split('@')[0]) : 'Unknown'} ‚Ä¢ ${n.at ? new Date(n.at).toLocaleString('vi-VN') : ''}</div>
              </div>`;
            }).join('')}
          </div>
          ` : ''}
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button id="taskNoteCancel" class="btn btn-soft" style="padding:8px 16px">H·ªßy</button>
            <button id="taskNoteSave" class="btn btn-primary" style="padding:8px 16px">üíæ L∆∞u</button>
          </div>
        `,
        closable: true
      });
      
      document.body.appendChild(modal);
      
      // Save button handler
      var saveBtn = document.getElementById('taskNoteSave');
      var cancelBtn = document.getElementById('taskNoteCancel');
      var noteInput = document.getElementById('taskNoteInput');
      
      if (saveBtn) {
        saveBtn.addEventListener('click', function() {
          var noteText = noteInput ? noteInput.value.trim() : '';
          if (!noteText) {
            toast('Vui l√≤ng nh·∫≠p ghi ch√∫', 'err');
            return;
          }
          
          callApi('saveTaskNote', {
            hub: currentHub,
            date: dateStr,
            taskText: task.text,
            note: noteText
          }).then(function(result) {
            if (result && result.status === 'ok') {
              toast('‚úÖ Ghi ch√∫ ƒë√£ l∆∞u th√†nh c√¥ng!', 'ok');
              modal.remove();
            } else {
              toast('L·ªói: ' + (result ? result.message : 'Failed'), 'err');
            }
          }).catch(function(error) {
            toast('L·ªói: ' + (error.message || error), 'err');
          });
        });
      }
      
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
          modal.remove();
        });
      }
    }).catch(function(error) {
      toast('L·ªói khi t·∫£i ghi ch√∫: ' + (error.message || error), 'err');
    });
  }
  
  function $(selector) {
    return document.querySelector(selector);
  }
  
  function $$(selector) {
    return document.querySelectorAll(selector);
  }
  
  function storageKey(hub, date) {
    return 'tasks_' + hub + '_' + date;
  }
  
  function todayStr() {
    return new Date().toISOString().slice(0, 10);
  }
  
  function updateClock() {
    var now = new Date();
    var el = $('#now');
    if (el) {
      el.textContent = now.toLocaleString(lang === 'en' ? 'en-US' : 'vi-VN');
    }
  }
  
  /* ====== GLOBAL SEARCH SYSTEM ====== */
  
  var GlobalSearch = {
    // Search data cache
    searchData: {
      tasks: [],
      users: [],
      questions: [],
      notes: [],
      accessLog: []
    },
    
    // Search history
    searchHistory: [],
    maxHistory: 10,
    dataLoaded: false,
    remoteDataLoaded: false,
    loadingPromise: null,
    
    // Initialize
    init: function() {
      // Load search history from localStorage
      try {
        var stored = localStorage.getItem('spx_search_history');
        if (stored) {
          this.searchHistory = JSON.parse(stored);
        }
      } catch (e) {
        console.warn('Search history load error:', e);
        this.searchHistory = [];
      }
      
      // Setup search input
      var searchInput = document.getElementById('globalSearch');
      var searchResults = document.getElementById('globalSearchResults');
      
      if (!searchInput || !searchResults) return;
      
      var ensureDataLoaded = this.ensureDataLoaded.bind(this);
      
      // Debounced search
      var debouncedSearch = debounce(function(query) {
        this.performSearch(query);
      }.bind(this), 300);
      
      // Search on input
      searchInput.addEventListener('input', function(e) {
        ensureDataLoaded();
        var query = e.target.value.trim();
        if (query.length >= 2) {
          debouncedSearch(query);
        } else {
          searchResults.style.display = 'none';
        }
      });
      
      searchInput.addEventListener('focus', ensureDataLoaded);
      
      // Keyboard shortcuts
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          searchResults.style.display = 'none';
          searchInput.blur();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          var query = searchInput.value.trim();
          if (query) {
            this.performSearch(query, true);
          }
        }
      }.bind(this));
      
      // Click outside to close
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#globalSearchContainer')) {
          searchResults.style.display = 'none';
        }
      });
      
      // Focus search with Ctrl+K or Cmd+K
      document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          ensureDataLoaded();
          searchInput.focus();
        }
      });
    },
    
    // Perform search
    performSearch: function(query, showFullResults) {
      if (!query || query.length < 2) return;
      
      var results = {
        tasks: [],
        users: [],
        questions: [],
        notes: [],
        accessLog: []
      };
      
      // Search in tasks
      if (this.searchData.tasks.length > 0) {
        results.tasks = this.searchData.tasks.filter(function(task) {
          return this.matchTask(task, query);
        }.bind(this));
      }
      
      // Search in users
      if (this.searchData.users.length > 0) {
        results.users = this.searchData.users.filter(function(user) {
          return this.matchUser(user, query);
        }.bind(this));
      }
      
      // Search in questions
      if (this.searchData.questions.length > 0) {
        results.questions = this.searchData.questions.filter(function(q) {
          return this.matchQuestion(q, query);
        }.bind(this));
      }
      
      // Search in notes
      if (this.searchData.notes.length > 0) {
        results.notes = this.searchData.notes.filter(function(note) {
          return this.matchNote(note, query);
        }.bind(this));
      }
      
      // Search in access log
      if (this.searchData.accessLog.length > 0) {
        results.accessLog = this.searchData.accessLog.filter(function(log) {
          return this.matchLog(log, query);
        }.bind(this));
      }
      
      // Display results
      this.displayResults(results, query);
      
      // Save to history
      if (query.length >= 3) {
        this.addToHistory(query);
      }
    },
    
    // Match task
    matchTask: function(task, query) {
      var q = query.toLowerCase();
      return (
        (task.text && task.text.toLowerCase().indexOf(q) !== -1) ||
        (task.category && task.category.toLowerCase().indexOf(q) !== -1) ||
        (task.info && task.info.toLowerCase().indexOf(q) !== -1)
      );
    },
    
    // Match user
    matchUser: function(user, query) {
      var q = query.toLowerCase();
      return (
        (user.email && user.email.toLowerCase().indexOf(q) !== -1) ||
        (user.displayName && user.displayName.toLowerCase().indexOf(q) !== -1) ||
        (user.hub && user.hub.toLowerCase().indexOf(q) !== -1)
      );
    },
    
    // Match question
    matchQuestion: function(question, query) {
      var q = query.toLowerCase();
      return (
        (question.question && question.question.toLowerCase().indexOf(q) !== -1) ||
        (question.answer && question.answer.toLowerCase().indexOf(q) !== -1) ||
        (question.category && question.category.toLowerCase().indexOf(q) !== -1)
      );
    },
    
    // Match note
    matchNote: function(note, query) {
      var q = query.toLowerCase();
      return (
        (note.content && note.content.toLowerCase().indexOf(q) !== -1) ||
        (note.hub && note.hub.toLowerCase().indexOf(q) !== -1)
      );
    },
    
    // Match log
    matchLog: function(log, query) {
      var q = query.toLowerCase();
      return (
        (log.email && log.email.toLowerCase().indexOf(q) !== -1) ||
        (log.action && log.action.toLowerCase().indexOf(q) !== -1) ||
        (log.hub && log.hub.toLowerCase().indexOf(q) !== -1)
      );
    },
    
    // Display results
    displayResults: function(results, query) {
      var searchResults = document.getElementById('globalSearchResults');
      if (!searchResults) return;
      
      var totalResults = results.tasks.length + results.users.length + 
                        results.questions.length + results.notes.length + 
                        results.accessLog.length;
      
      if (totalResults === 0) {
        searchResults.innerHTML = `
          <div style="padding:20px;text-align:center;color:var(--muted)">
            <div style="font-size:32px;margin-bottom:8px">üîç</div>
            <div>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ cho "<strong>${esc(query)}</strong>"</div>
          </div>
        `;
        searchResults.style.display = 'block';
        return;
      }
      
      var html = '<div style="max-height:400px;overflow-y:auto">';
      
      // Tasks results
      if (results.tasks.length > 0) {
        html += '<div style="margin-bottom:12px">';
        html += '<div style="font-weight:700;padding:8px;border-bottom:1px solid var(--stroke);margin-bottom:8px">üìã Tasks (' + results.tasks.length + ')</div>';
        results.tasks.slice(0, 5).forEach(function(task) {
          html += '<div class="search-result-item" data-type="task" data-id="' + esc(task.id) + '" style="padding:8px;cursor:pointer;border-radius:8px;margin-bottom:4px;transition:background 0.2s" onmouseover="this.style.background=\'var(--hover)\'" onmouseout="this.style.background=\'\'">';
          html += '<div style="font-weight:600">' + esc(task.text) + '</div>';
          html += '<div style="font-size:12px;color:var(--muted);margin-top:4px">' + esc(task.category || '') + '</div>';
          html += '</div>';
        });
        if (results.tasks.length > 5) {
          html += '<div style="padding:8px;text-align:center;color:var(--muted);font-size:12px">+ ' + (results.tasks.length - 5) + ' k·∫øt qu·∫£ kh√°c</div>';
        }
        html += '</div>';
      }
      
      // Users results
      if (results.users.length > 0) {
        html += '<div style="margin-bottom:12px">';
        html += '<div style="font-weight:700;padding:8px;border-bottom:1px solid var(--stroke);margin-bottom:8px">üë• Users (' + results.users.length + ')</div>';
        results.users.slice(0, 5).forEach(function(user) {
          html += '<div class="search-result-item" data-type="user" data-email="' + esc(user.email) + '" style="padding:8px;cursor:pointer;border-radius:8px;margin-bottom:4px;transition:background 0.2s" onmouseover="this.style.background=\'var(--hover)\'" onmouseout="this.style.background=\'\'">';
          html += '<div style="font-weight:600">' + esc(user.displayName || user.email) + '</div>';
          html += '<div style="font-size:12px;color:var(--muted);margin-top:4px">' + esc(user.email) + ' ‚Ä¢ ' + esc(user.hub || '') + '</div>';
          html += '</div>';
        });
        if (results.users.length > 5) {
          html += '<div style="padding:8px;text-align:center;color:var(--muted);font-size:12px">+ ' + (results.users.length - 5) + ' k·∫øt qu·∫£ kh√°c</div>';
        }
        html += '</div>';
      }
      
      // Questions results
      if (results.questions.length > 0) {
        html += '<div style="margin-bottom:12px">';
        html += '<div style="font-weight:700;padding:8px;border-bottom:1px solid var(--stroke);margin-bottom:8px">‚ùì Questions (' + results.questions.length + ')</div>';
        results.questions.slice(0, 3).forEach(function(question) {
          html += '<div class="search-result-item" data-type="question" data-id="' + esc(question.id) + '" style="padding:8px;cursor:pointer;border-radius:8px;margin-bottom:4px;transition:background 0.2s" onmouseover="this.style.background=\'var(--hover)\'" onmouseout="this.style.background=\'\'">';
          html += '<div style="font-weight:600">' + esc(question.question) + '</div>';
          html += '<div style="font-size:12px;color:var(--muted);margin-top:4px">' + esc(question.category || '') + '</div>';
          html += '</div>';
        });
        html += '</div>';
      }
      
      html += '</div>';
      
      searchResults.innerHTML = html;
      searchResults.style.display = 'block';
      
      // Setup click handlers
      searchResults.querySelectorAll('.search-result-item').forEach(function(item) {
        item.addEventListener('click', function() {
          var type = item.getAttribute('data-type');
          var id = item.getAttribute('data-id') || item.getAttribute('data-email');
          this.handleResultClick(type, id);
        }.bind(this));
      }.bind(this));
    },
    
    // Handle result click
    handleResultClick: function(type, id) {
      var searchResults = document.getElementById('globalSearchResults');
      var searchInput = document.getElementById('globalSearch');
      
      if (searchResults) searchResults.style.display = 'none';
      if (searchInput) searchInput.blur();
      
      switch(type) {
        case 'task':
          // Switch to checklist tab and highlight task
          this.switchToTab('check');
          // Scroll to task (will be implemented)
          break;
        case 'user':
          // Switch to admin tab and show user
          if (currentUser.role === 'admin') {
            this.switchToTab('admin');
            // Edit user (will be implemented)
            setTimeout(function() {
              if (typeof editUser === 'function') {
                editUser(id);
              }
            }, 500);
          }
          break;
        case 'question':
          // Switch to Q&A tab
          this.switchToTab('qa');
          break;
      }
    },
    
    // Switch to tab
    switchToTab: function(tabName) {
      // Hide cover if showing
      if (document.getElementById('cover').style.display !== 'none') {
        enterApp();
      }
      
      // Switch to tab
      var tab = document.querySelector('[data-tab="' + tabName + '"]');
      if (tab) {
        tab.click();
      }
    },
    
    // Add to history
    addToHistory: function(query) {
      // Remove if already exists
      this.searchHistory = this.searchHistory.filter(function(h) {
        return h !== query;
      });
      
      // Add to beginning
      this.searchHistory.unshift(query);
      
      // Limit history size
      if (this.searchHistory.length > this.maxHistory) {
        this.searchHistory = this.searchHistory.slice(0, this.maxHistory);
      }
      
      // Save to localStorage
      try {
        localStorage.setItem('spx_search_history', JSON.stringify(this.searchHistory));
      } catch (e) {
        console.warn('Search history save error:', e);
      }
    },
    
    // Load search data
    loadSearchData: function(options) {
      var forceRemote = options && options.forceRemote;
      this.searchData.tasks = tasksData[currentHub] || [];
      
      if (this.loadingPromise && !forceRemote) {
        return this.loadingPromise;
      }
      
      var fetches = [];
      var shouldFetchRemote = !this.remoteDataLoaded || forceRemote;
      
      if (shouldFetchRemote) {
        if (currentUser && currentUser.role === 'admin') {
          fetches.push(
            callApi('getAllUsers')
              .then(function(users) {
                if (users && !users.error) {
                  this.searchData.users = users;
                }
              }.bind(this))
              .catch(function(e) {
                console.warn('Failed to load users for search:', e);
              })
          );
        }
        
        fetches.push(
          callApi('getQuestions', {})
            .then(function(questions) {
              if (questions && !questions.error) {
                this.searchData.questions = questions;
              }
            }.bind(this))
            .catch(function(e) {
              console.warn('Failed to load questions for search:', e);
            })
        );
      }
      
      if (fetches.length === 0) {
        this.dataLoaded = true;
        return Promise.resolve();
      }
      
      var self = this;
      this.loadingPromise = Promise.all(fetches).then(function() {
        self.remoteDataLoaded = true;
        self.dataLoaded = true;
      }).catch(function(e) {
        console.warn('Failed to load search data:', e);
        self.remoteDataLoaded = false;
      }).finally(function() {
        self.loadingPromise = null;
      });
      
      return this.loadingPromise;
    },
    
    ensureDataLoaded: function() {
      if (!this.dataLoaded) {
        return this.loadSearchData();
      }
      this.searchData.tasks = tasksData[currentHub] || [];
      return Promise.resolve();
    },
    
    // Refresh search data
    refresh: function() {
      this.searchData.tasks = tasksData[currentHub] || [];
    }
  };
  
  /* ====== BULK OPERATIONS SYSTEM ====== */
  
  var BulkOperations = {
    // Selection mode
    selectionMode: false,
    selectedTasks: [],
    
    // Toggle selection mode
    toggleSelectionMode: function() {
      this.selectionMode = !this.selectionMode;
      this.selectedTasks = [];
      
      // Update UI
      var bulkSelectBtn = document.getElementById('bulkSelectBtn');
      var bulkEditBtn = document.getElementById('bulkEditBtn');
      var bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
      var bulkExportBtn = document.getElementById('bulkExportBtn');
      var bulkCancelBtn = document.getElementById('bulkCancelBtn');
      
      if (this.selectionMode) {
        if (bulkSelectBtn) bulkSelectBtn.style.display = 'none';
        if (bulkEditBtn) bulkEditBtn.style.display = 'inline-block';
        if (bulkDeleteBtn) bulkDeleteBtn.style.display = 'inline-block';
        if (bulkExportBtn) bulkExportBtn.style.display = 'inline-block';
        if (bulkCancelBtn) bulkCancelBtn.style.display = 'inline-block';
        
        // Re-render tasks with selection checkboxes
        renderTasks();
        toast('Ch·∫ø ƒë·ªô ch·ªçn nhi·ªÅu ƒë√£ b·∫≠t. Ch·ªçn tasks ƒë·ªÉ thao t√°c h√†ng lo·∫°t.', 'info');
      } else {
        if (bulkSelectBtn) bulkSelectBtn.style.display = 'inline-block';
        if (bulkEditBtn) bulkEditBtn.style.display = 'none';
        if (bulkDeleteBtn) bulkDeleteBtn.style.display = 'none';
        if (bulkExportBtn) bulkExportBtn.style.display = 'none';
        if (bulkCancelBtn) bulkCancelBtn.style.display = 'none';
        
        // Re-render tasks normally
        renderTasks();
      }
    },
    
    // Toggle task selection
    toggleTaskSelection: function(taskId) {
      var index = this.selectedTasks.indexOf(taskId);
      if (index === -1) {
        this.selectedTasks.push(taskId);
      } else {
        this.selectedTasks.splice(index, 1);
      }
      
      // Update UI
      this.updateBulkButtons();
    },
    
    // Select all tasks
    selectAll: function() {
      var tasks = tasksData[currentHub] || [];
      this.selectedTasks = tasks.map(function(t) { return t.id; });
      this.updateBulkButtons();
      
      // Update checkboxes
      document.querySelectorAll('.bulk-select-checkbox').forEach(function(checkbox) {
        checkbox.checked = true;
      });
    },
    
    // Deselect all tasks
    deselectAll: function() {
      this.selectedTasks = [];
      this.updateBulkButtons();
      
      // Update checkboxes
      document.querySelectorAll('.bulk-select-checkbox').forEach(function(checkbox) {
        checkbox.checked = false;
      });
    },
    
    // Update bulk buttons
    updateBulkButtons: function() {
      var count = this.selectedTasks.length;
      var bulkEditBtn = document.getElementById('bulkEditBtn');
      var bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
      var bulkExportBtn = document.getElementById('bulkExportBtn');
      
      if (bulkEditBtn) {
        bulkEditBtn.textContent = '‚úèÔ∏è S·ª≠a h√†ng lo·∫°t (' + count + ')';
        bulkEditBtn.disabled = count === 0;
      }
      
      if (bulkDeleteBtn) {
        bulkDeleteBtn.textContent = 'üóëÔ∏è X√≥a h√†ng lo·∫°t (' + count + ')';
        bulkDeleteBtn.disabled = count === 0;
      }
      
      if (bulkExportBtn) {
        bulkExportBtn.textContent = 'üìó Export (' + count + ')';
        bulkExportBtn.disabled = count === 0;
      }
    },
    
    // Bulk edit
    bulkEdit: function() {
      if (this.selectedTasks.length === 0) {
        toast('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt task', 'warn');
        return;
      }
      
      var tasks = tasksData[currentHub] || [];
      var selectedTasks = tasks.filter(function(t) {
        return this.selectedTasks.indexOf(t.id) !== -1;
      }.bind(this));
      
      this.showBulkEditDialog(selectedTasks);
    },
    
    // Show bulk edit dialog
    showBulkEditDialog: function(tasks) {
      var html = '<div style="padding:24px">';
      html += '<h3 style="margin:0 0 20px;font-size:20px;color:var(--fg)">‚úèÔ∏è S·ª≠a H√†ng Lo·∫°t (' + tasks.length + ' tasks)</h3>';
      html += '<form id="bulkEditForm" onsubmit="return false;">';
      
      // Category
      html += '<div class="group" style="margin-bottom:16px">';
      html += '<div class="label">Danh m·ª•c</div>';
      html += '<div class="control">';
      html += '<select id="bulkEditCategory" style="width:100%">';
      html += '<option value="">Gi·ªØ nguy√™n</option>';
      html += '<option value="ƒê·∫ßu Ca">ƒê·∫ßu Ca</option>';
      html += '<option value="Trong Ca">Trong Ca</option>';
      html += '<option value="Cu·ªëi Ca">Cu·ªëi Ca</option>';
      html += '<option value="H√†ng Tu·∫ßn">H√†ng Tu·∫ßn</option>';
      html += '</select>';
      html += '</div>';
      html += '</div>';
      
      // SLA
      html += '<div class="group" style="margin-bottom:16px">';
      html += '<div class="label">SLA Deadline</div>';
      html += '<div class="control">';
      html += '<input type="time" id="bulkEditSLA" style="width:100%"/>';
      html += '<small style="color:var(--muted);font-size:12px;display:block;margin-top:4px">ƒê·ªÉ tr·ªëng ƒë·ªÉ gi·ªØ nguy√™n, nh·∫≠p th·ªùi gian ƒë·ªÉ thay ƒë·ªïi</small>';
      html += '</div>';
      html += '</div>';
      
      // Is Lead
      html += '<div class="group" style="margin-bottom:16px">';
      html += '<div class="label">Ph√¢n c√¥ng LEAD</div>';
      html += '<div class="control">';
      html += '<select id="bulkEditIsLead" style="width:100%">';
      html += '<option value="">Gi·ªØ nguy√™n</option>';
      html += '<option value="true">C√≥ (LEAD)</option>';
      html += '<option value="false">Kh√¥ng</option>';
      html += '</select>';
      html += '</div>';
      html += '</div>';
      
      // Completed
      html += '<div class="group" style="margin-bottom:20px">';
      html += '<div class="label">Tr·∫°ng th√°i ho√†n th√†nh</div>';
      html += '<div class="control">';
      html += '<select id="bulkEditCompleted" style="width:100%">';
      html += '<option value="">Gi·ªØ nguy√™n</option>';
      html += '<option value="true">ƒê√£ ho√†n th√†nh</option>';
      html += '<option value="false">Ch∆∞a ho√†n th√†nh</option>';
      html += '</select>';
      html += '</div>';
      html += '</div>';
      
      // Buttons
      html += '<div style="display:flex;gap:8px;justify-content:flex-end">';
      html += '<button type="button" class="btn btn-soft" onclick="this.closest(\'.modal\').remove()">H·ªßy</button>';
      html += '<button type="submit" class="btn btn-primary">üíæ √Åp d·ª•ng</button>';
      html += '</div>';
      
      html += '</form>';
      html += '</div>';
      
      var modalBox = showModal(html);
      
      // Setup form submit
      var form = modalBox.querySelector('#bulkEditForm');
      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          this.applyBulkEdit(tasks, modalBox);
        }.bind(this));
      }
    },
    
    // Apply bulk edit
    applyBulkEdit: function(tasks, modalBox) {
      var categoryEl = modalBox.querySelector('#bulkEditCategory');
      var slaEl = modalBox.querySelector('#bulkEditSLA');
      var isLeadEl = modalBox.querySelector('#bulkEditIsLead');
      var completedEl = modalBox.querySelector('#bulkEditCompleted');
      
      // Safety check: ensure all elements exist
      if (!categoryEl || !slaEl || !isLeadEl || !completedEl) {
        toast('L·ªói: Kh√¥ng t√¨m th·∫•y c√°c tr∆∞·ªùng form c·∫ßn thi·∫øt', 'err');
        return;
      }
      
      var category = categoryEl.value;
      var sla = slaEl.value;
      var isLead = isLeadEl.value;
      var completed = completedEl.value;
      
      var allTasks = tasksData[currentHub] || [];
      var updated = 0;
      
      tasks.forEach(function(task) {
        var taskIndex = allTasks.findIndex(function(t) { return t.id === task.id; });
        if (taskIndex === -1) return;
        
        if (category) {
          allTasks[taskIndex].category = category;
        }
        
        if (sla) {
          allTasks[taskIndex].sla = sla;
        } else if (sla === '' && slaEl && slaEl.value === '') {
          // Clear SLA if empty
          allTasks[taskIndex].sla = null;
        }
        
        if (isLead !== '') {
          allTasks[taskIndex].isLead = isLead === 'true';
        }
        
        if (completed !== '') {
          allTasks[taskIndex].completed = completed === 'true';
          if (completed === 'true') {
            allTasks[taskIndex].doneAt = new Date().toISOString();
          } else {
            allTasks[taskIndex].doneAt = null;
          }
        }
        
        updated++;
      });
      
      tasksData[currentHub] = allTasks;
      
      // Save tasks
      var hub = currentHub;
      var dateEl = $('#date');
      var date = (dateEl && dateEl.value) ? dateEl.value : todayStr();
      var key = storageKey(hub, date);
      
      callApi('saveTasks', { storageKey: key, tasks: allTasks }).then(function(result) {
        if (result.status === 'ok') {
          toast('ƒê√£ c·∫≠p nh·∫≠t ' + updated + ' tasks', 'ok');
          
          // Close modal
          var modal = document.querySelector('.modal');
          if (modal) modal.remove();
          
          // Exit selection mode
          this.toggleSelectionMode();
          
          // Re-render tasks
          renderTasks();
        } else {
          toast('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ l∆∞u'), 'err');
        }
      }.bind(this)).catch(function(error) {
        toast('L·ªói: ' + error.message, 'err');
      });
    },
    
    // Bulk delete
    bulkDelete: function() {
      if (this.selectedTasks.length === 0) {
        toast('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt task', 'warn');
        return;
      }
      
      if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ' + this.selectedTasks.length + ' tasks ƒë√£ ch·ªçn?')) {
        return;
      }
      
      var allTasks = tasksData[currentHub] || [];
      var beforeCount = allTasks.length;
      
      // Remove selected tasks
      allTasks = allTasks.filter(function(t) {
        return this.selectedTasks.indexOf(t.id) === -1;
      }.bind(this));
      
      tasksData[currentHub] = allTasks;
      var deletedCount = beforeCount - allTasks.length;
      
      // Save tasks
      var hub = currentHub;
      var dateEl = $('#date');
      var date = (dateEl && dateEl.value) ? dateEl.value : todayStr();
      var key = storageKey(hub, date);
      
      callApi('saveTasks', { storageKey: key, tasks: allTasks }).then(function(result) {
        if (result.status === 'ok') {
          toast('ƒê√£ x√≥a ' + deletedCount + ' tasks', 'ok');
          
          // Exit selection mode
          this.toggleSelectionMode();
          
          // Re-render tasks
          renderTasks();
        } else {
          toast('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ l∆∞u'), 'err');
        }
      }.bind(this)).catch(function(error) {
        toast('L·ªói: ' + error.message, 'err');
      });
    },
    
    // Bulk export
    bulkExport: function() {
      if (this.selectedTasks.length === 0) {
        toast('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt task', 'warn');
        return;
      }
      
      var tasks = tasksData[currentHub] || [];
      var selectedTasks = tasks.filter(function(t) {
        return this.selectedTasks.indexOf(t.id) !== -1;
      }.bind(this));
      
      // Export to CSV
      var csv = 'Task Text,Category,SLA,Is Lead,Completed,Done At\n';
      selectedTasks.forEach(function(task) {
        csv += '"' + (task.text || '').replace(/"/g, '""') + '",';
        csv += '"' + (task.category || '') + '",';
        csv += '"' + (task.sla || '') + '",';
        csv += '"' + (task.isLead ? 'Yes' : 'No') + '",';
        csv += '"' + (task.completed ? 'Yes' : 'No') + '",';
        csv += '"' + (task.doneAt || '') + '"\n';
      });
      
      // Download CSV
      var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      var url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'tasks_' + currentHub + '_' + todayStr() + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      toast('ƒê√£ export ' + selectedTasks.length + ' tasks', 'ok');
    }
  };
  
  /* ====== COVER PAGE ====== */
  
  function showCover() {
    var cover = document.getElementById('cover');
    var mainContent = document.getElementById('main-content');
    var topbar = document.getElementById('topbar');
    if (cover) cover.style.display = 'grid';
    if (mainContent) mainContent.style.display = 'none';
    if (topbar) topbar.style.display = 'none';
  }
  
  function enterApp() {
    var cover = document.getElementById('cover');
    var mainContent = document.getElementById('main-content');
    var topbar = document.getElementById('topbar');
    if (cover) cover.style.display = 'none';
    if (mainContent) mainContent.style.display = 'flex';
    if (topbar) topbar.style.display = 'flex';
    
    // Load initial data
    loadTasks();
  }
  
  /* ====== TASK MANAGEMENT ====== */
  
  function loadTasks() {
    var hub = currentHub;
    var dateEl = $('#date');
    var date = (dateEl && dateEl.value) ? dateEl.value : todayStr();
    var key = storageKey(hub, date);
    var cacheHit = false;
    
    var cached = getCachedTasks(key);
    if (cached) {
      cacheHit = true;
      tasksData[hub] = cached;
      renderTasks();
      updateKPI();
      if (typeof GlobalSearch !== 'undefined' && GlobalSearch.refresh) {
        GlobalSearch.refresh();
      }
    } else {
      showSkeleton();
    }
    
    callApi('loadTasks', { storageKey: key }).then(function(tasks) {
      tasksData[hub] = tasks || [];
      
      // Debug: Log first task to check info and link fields
      if (tasks && tasks.length > 0) {
        console.log('[DEBUG] First task loaded:', {
          text: tasks[0].text,
          info: tasks[0].info,
          link: tasks[0].link,
          category: tasks[0].category
        });
      }
      
      renderTasks();
      updateKPI();
      saveTasksToCache(key, tasks || []);
      
      // Refresh search data
      if (typeof GlobalSearch !== 'undefined' && GlobalSearch.refresh) {
        GlobalSearch.refresh();
      }
      
      // Log event
      callApi('logEvent', {
        action: 'LOAD_TASKS',
        hub: hub,
        details: { date: date, count: tasks ? tasks.length : 0 }
      });
    }).catch(function(error) {
      console.error('Load tasks error:', error);
      if (cacheHit) {
        toast('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi. ƒêang d√πng d·ªØ li·ªáu g·∫ßn nh·∫•t.', 'warn');
      } else {
        toast('Failed to load tasks: ' + (error.message || error), 'err');
        var container = document.getElementById('vRows');
        if (container) {
          container.innerHTML = '<div class="hint" style="padding:20px;text-align:center">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</div>';
        }
      }
    });
  }
  
  function saveTasks(justCompleted) {
    var hub = currentHub;
    var dateEl = $('#date');
    var date = (dateEl && dateEl.value) ? dateEl.value : todayStr();
    var key = storageKey(hub, date);
    var tasks = tasksData[hub] || [];
    
    var btn = $('#saveBtn');
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'ƒêang l∆∞u...';
    }
    
    callApi('saveTasks', { storageKey: key, tasks: tasks }).then(function(result) {
      if (result.status === 'ok') {
        // Show different message based on whether task was just completed
        if (justCompleted === true) {
          // Task was just ticked/completed - show encouraging message
          toast('Gi·ªèi qu√°!', 'ok');
        } else if (justCompleted === false) {
          // Task was unchecked - silent save (no toast)
          // Don't show toast when unchecking to reduce noise
        } else {
          // Default save (not from checkbox toggle) - show success message
          toast('ƒê√£ l∆∞u th√†nh c√¥ng!', 'ok');
        }
        saveTasksToCache(key, tasks);
        
        // Log event
        callApi('logEvent', {
          action: 'SAVE_TASKS',
          hub: hub,
          details: { date: date, count: tasks.length }
        });
      } else {
        toast('L∆∞u th·∫•t b·∫°i: ' + result.message, 'err');
      }
    }).catch(function(error) {
      toast('L·ªói: ' + error.message, 'err');
    }).finally(function() {
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'üíæ L∆∞u';
      }
    });
  }
  
  function renderTasks() {
    var perfLabel = PerformanceMonitor.start('render-tasks');
    var tasks = tasksData[currentHub] || [];
    var container = document.getElementById('vRows');
    if (!container) return;
    container.innerHTML = '';
    
    if (tasks.length === 0) {
      container.innerHTML = '<div class="hint" style="padding:20px;text-align:center">Kh√¥ng c√≥ task n√†o. Nh·∫•n "+ Task t·ª©c th√¨" ƒë·ªÉ th√™m.</div>';
      if (perfLabel) PerformanceMonitor.end(perfLabel);
      return;
    }
    
    // Group by category - normalize category names to prevent mismatches
    var groups = {
      'ƒê·∫ßu Ca': [],
      'Trong Ca': [],
      'Cu·ªëi Ca': [],
      'H√†ng Tu·∫ßn': []
    };
    
    // Normalize category function
    function normalizeCategory(cat) {
      if (!cat) return 'ƒê·∫ßu Ca';
      var normalized = String(cat).trim();
      // Map common variations
      if (normalized.toLowerCase() === 'ƒë·∫ßu ca' || normalized.toLowerCase() === 'dau ca') return 'ƒê·∫ßu Ca';
      if (normalized.toLowerCase() === 'trong ca') return 'Trong Ca';
      if (normalized.toLowerCase() === 'cu·ªëi ca' || normalized.toLowerCase() === 'cuoi ca') return 'Cu·ªëi Ca';
      if (normalized.toLowerCase() === 'h√†ng tu·∫ßn' || normalized.toLowerCase() === 'hang tuan') return 'H√†ng Tu·∫ßn';
      // If exact match, return as is
      if (groups[normalized]) return normalized;
      // Default fallback
      return 'ƒê·∫ßu Ca';
    }
    
    tasks.forEach(function(task) {
      // Normalize category before grouping
      task.category = normalizeCategory(task.category);
      var cat = task.category;
      groups[cat].push(task);
    });
    
    // Calculate completion stats
    var totalDone = tasks.filter(function(t) { return t.completed; }).length;
    var totalTasks = tasks.length;
    
    // Render each group with collapsible headers
    var categoryOrder = ['ƒê·∫ßu Ca', 'Trong Ca', 'Cu·ªëi Ca', 'H√†ng Tu·∫ßn'];
    
    categoryOrder.forEach(function(category) {
      var categoryTasks = groups[category];
      
      // End performance monitoring after render
      if (category === categoryOrder[categoryOrder.length - 1] && perfLabel) {
        var duration = PerformanceMonitor.end(perfLabel);
        PerformanceMonitor.checkPerformance('render-tasks', duration);
      }
      if (!categoryTasks || categoryTasks.length === 0) return;
      
      var doneTasks = categoryTasks.filter(function(t) { return t.completed; }).length;
      var isComplete = doneTasks === categoryTasks.length;
      
      var section = document.createElement('div');
      section.className = 'section glass';
      section.style.marginBottom = '16px';
      
      // Collapsible header - Improved layout to prevent overlap
      var header = document.createElement('div');
      header.className = 'category-header';
      header.style.cssText = 'cursor: pointer; padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; user-select: none; border-bottom: 1px solid rgba(255,255,255,0.1); gap: 12px; position: relative;';
      
      var headerLeft = document.createElement('div');
      headerLeft.style.cssText = 'display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0;';
      
      // Arrow icon - positioned to not overlap title
      var arrow = document.createElement('span');
      arrow.textContent = '‚ñº';
      arrow.style.cssText = 'font-size: 14px; transition: transform 0.2s; color: var(--muted); flex-shrink: 0; width: 20px; text-align: center;';
      
      // Title container with proper spacing
      var titleContainer = document.createElement('div');
      titleContainer.style.cssText = 'display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0;';
      
      var title = document.createElement('strong');
      title.textContent = category;
      title.style.cssText = 'font-size: 17px; font-weight: 600; color: var(--ink); white-space: nowrap;';
      
      var status = document.createElement('span');
      status.textContent = isComplete ? 'ƒê√£ ho√†n th√†nh' : 'Ch∆∞a ho√†n th√†nh';
      status.style.cssText = 'font-size: 12px; color: ' + (isComplete ? 'var(--brand-2)' : 'var(--fg2)') + '; padding: 3px 8px; background: ' + (isComplete ? 'rgba(16,185,129,0.1)' : 'rgba(156,163,175,0.1)') + '; border-radius: 6px; white-space: nowrap;';
      
      titleContainer.appendChild(title);
      titleContainer.appendChild(status);
      
      headerLeft.appendChild(arrow);
      headerLeft.appendChild(titleContainer);
      
      // Count badge on the right
      var headerRight = document.createElement('div');
      headerRight.textContent = doneTasks + '/' + categoryTasks.length;
      headerRight.style.cssText = 'font-size: 14px; font-weight: 600; color: var(--ink); background: var(--glass); padding: 6px 12px; border-radius: 8px; white-space: nowrap; flex-shrink: 0;';
      
      header.appendChild(headerLeft);
      header.appendChild(headerRight);
      
      // Task body (collapsible)
      var body = document.createElement('div');
      body.className = 'category-body';
      body.style.cssText = 'padding: 8px; transition: max-height 0.3s ease;';
      
      categoryTasks.forEach(function(task) {
        var item = createTaskItem(task);
        body.appendChild(item);
      });
      
      // Toggle collapse
      header.addEventListener('click', function() {
        var isCollapsed = body.style.display === 'none';
        body.style.display = isCollapsed ? 'block' : 'none';
        arrow.style.transform = isCollapsed ? 'rotate(0deg)' : 'rotate(-90deg)';
      });
      
      section.appendChild(header);
      section.appendChild(body);
      container.appendChild(section);
    });
  }
  
  var PRIORITY_LEVELS = {
    high: { label: 'üî¥ Cao', bg: 'rgba(239,68,68,0.12)', color: '#ef4444' },
    medium: { label: 'üü° Trung b√¨nh', bg: 'rgba(245,158,11,0.15)', color: '#d97706' },
    low: { label: 'üü¢ Th·∫•p', bg: 'rgba(16,185,129,0.15)', color: '#059669' }
  };
  
  function createTaskItem(task) {
    var item = document.createElement('div');
    item.className = 'item' + (task.completed ? ' done' : '');
    item.setAttribute('data-task-id', task.id);
    item.style.cssText = 'display: flex; align-items: flex-start; gap: 12px; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);';
    
    // Bulk selection checkbox (if in selection mode)
    if (BulkOperations && BulkOperations.selectionMode) {
      var bulkCheckbox = document.createElement('input');
      bulkCheckbox.type = 'checkbox';
      bulkCheckbox.className = 'bulk-select-checkbox';
      bulkCheckbox.checked = BulkOperations.selectedTasks.indexOf(task.id) !== -1;
      bulkCheckbox.style.cssText = 'margin-top: 4px; cursor: pointer; width:18px;height:18px;';
      bulkCheckbox.addEventListener('change', function(e) {
        e.stopPropagation();
        BulkOperations.toggleTaskSelection(task.id);
      });
      item.appendChild(bulkCheckbox);
    }
    
    // Task completion checkbox
    var checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = task.completed;
    checkbox.style.cssText = 'margin-top: 4px; cursor: pointer;';
    checkbox.disabled = (BulkOperations && BulkOperations.selectionMode);
    
    // Create label element early so it can be referenced in the event listener
    var label = document.createElement('span');
    label.textContent = task.text;
    label.style.cssText = 'font-size: 16px; font-weight: 500; line-height: 1.5;' + (task.completed ? ' text-decoration: line-through; opacity: 0.7;' : '');
    
    checkbox.addEventListener('change', function(e) {
      if (BulkOperations && BulkOperations.selectionMode) {
        e.stopPropagation();
        return;
      }
      task.completed = checkbox.checked;
      task.doneAt = checkbox.checked ? new Date().toISOString() : null;
      item.classList.toggle('done', checkbox.checked);
      
      // Update text strikethrough
      if (label) {
        label.style.textDecoration = checkbox.checked ? 'line-through' : 'none';
        label.style.opacity = checkbox.checked ? '0.7' : '1';
      }
      
      // Update category completion status without full re-render
      var categorySection = item.closest('.section');
      if (categorySection) {
        var allTasks = tasksData[currentHub] || [];
        var categoryTasks = allTasks.filter(function(t) { return t.category === task.category; });
        var doneTasks = categoryTasks.filter(function(t) { return t.completed; }).length;
        var totalCatTasks = categoryTasks.length;
        var isComplete = doneTasks === totalCatTasks;
        
        // Update status span (now inside titleContainer)
        var titleContainer = categorySection.querySelector('.category-header > div:first-child > div:last-child');
        if (titleContainer) {
          var statusSpan = titleContainer.querySelector('span');
          if (statusSpan) {
            statusSpan.textContent = isComplete ? 'ƒê√£ ho√†n th√†nh' : 'Ch∆∞a ho√†n th√†nh';
            statusSpan.style.color = isComplete ? 'var(--brand-2)' : 'var(--fg2)';
            statusSpan.style.background = isComplete ? 'rgba(16,185,129,0.1)' : 'rgba(156,163,175,0.1)';
          }
        }
        
        // Update count badge
        var countSpan = categorySection.querySelector('.category-header > div:last-child');
        if (countSpan) {
          countSpan.textContent = doneTasks + '/' + totalCatTasks;
        }
      }
      
      updateKPI();
      
      // Auto save after check
      var wasCompleted = checkbox.checked;
      saveTasks(wasCompleted); // Pass completion status to show appropriate message
    });
    
    var content = document.createElement('div');
    content.style.cssText = 'flex: 1; display: flex; flex-direction: column; gap: 6px;';
    
    var labelRow = document.createElement('div');
    labelRow.style.cssText = 'display: flex; align-items: center; gap: 8px; flex-wrap: wrap;';
    
    // Label was already created above, just append it
    labelRow.appendChild(label);
    
    // Priority badge
    var priorityKey = getTaskPriority(task);
    var priorityConf = PRIORITY_LEVELS[priorityKey];
    // Safety check: fallback to medium if priorityConf is undefined
    if (!priorityConf) {
      priorityConf = PRIORITY_LEVELS['medium'] || { label: 'üü° Trung b√¨nh', bg: 'rgba(245,158,11,0.15)', color: '#d97706' };
    }
    var priorityBadge = document.createElement('span');
    priorityBadge.className = 'chip priority-chip';
    priorityBadge.textContent = priorityConf.label;
    priorityBadge.style.cssText = 'background: ' + priorityConf.bg + '; color: ' + priorityConf.color + '; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 12px; cursor: pointer;';
    priorityBadge.title = 'Click ƒë·ªÉ ƒë·∫∑t ƒë·ªô ∆∞u ti√™n';
    priorityBadge.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      openPriorityPrompt(task);
    });
    labelRow.appendChild(priorityBadge);
    
    // Badges
    if (task.isLead) {
      var leadBadge = document.createElement('span');
      leadBadge.className = 'chip';
      leadBadge.textContent = 'üëî LEAD';
      leadBadge.style.cssText = 'background: var(--brand-2); color: #111; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 12px;';
      labelRow.appendChild(leadBadge);
    }
    
    if (task.sla) {
      var slaBadge = document.createElement('span');
      slaBadge.className = 'chip';
      slaBadge.textContent = '‚è∞ SLA: ' + task.sla;
      slaBadge.style.cssText = 'background: rgba(255,100,100,0.2); color: #ff6464; font-size: 12px; font-weight: 500; padding: 4px 10px; border-radius: 12px; cursor: pointer;';
      slaBadge.title = 'Click ƒë·ªÉ thay ƒë·ªïi SLA';
      slaBadge.addEventListener('click', function() {
        setSLAForTask(task);
      });
      labelRow.appendChild(slaBadge);
    } else {
      var addSlaBtn = document.createElement('span');
      addSlaBtn.className = 'chip';
      addSlaBtn.textContent = '‚è∞ + SLA';
      addSlaBtn.style.cssText = 'background: rgba(100,150,255,0.15); color: #6495ed; font-size: 12px; font-weight: 500; padding: 4px 10px; border-radius: 12px; cursor: pointer;';
      addSlaBtn.title = 'Click ƒë·ªÉ th√™m SLA cho task n√†y';
      addSlaBtn.addEventListener('click', function() {
        setSLAForTask(task);
      });
      labelRow.appendChild(addSlaBtn);
    }
    
    // Add Info icon (‚ÑπÔ∏è) - ALWAYS SHOW to display task description - IMPROVED DESIGN
      var infoIcon = document.createElement('button');
      infoIcon.className = 'task-info-btn';
      infoIcon.innerHTML = '‚ÑπÔ∏è';
    infoIcon.title = task.info && task.info.trim() !== '' ? 'Xem m√¥ t·∫£ chi ti·∫øt task' : 'Kh√¥ng c√≥ m√¥ t·∫£ cho task n√†y';
    infoIcon.style.cssText = 'background: rgba(59, 130, 246, 0.15); border: none; color: #3b82f6; font-size: 16px; padding: 6px 10px; border-radius: 8px; cursor: pointer; transition: all 0.2s; min-width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center;';
    if (!task.info || task.info.trim() === '') {
      infoIcon.style.opacity = '0.5';
    }
      infoIcon.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
      // Debug: Log task info before showing modal
      console.log('[DEBUG] Showing task info modal for task:', {
        text: task.text,
        info: task.info,
        link: task.link,
        fullTask: task
      });
        showTaskInfoModal(task);
      });
      labelRow.appendChild(infoIcon);
    
    // Add Link button if link exists and is valid URL - IMPROVED DESIGN
    if (task.link && task.link.trim() !== '') {
      var linkValue = String(task.link).trim();
      // Validate URL - must start with http:// or https://
      var isValidUrl = /^https?:\/\/.+/.test(linkValue);
      
      if (isValidUrl) {
      var linkBtn = document.createElement('a');
      linkBtn.className = 'task-link';
        linkBtn.href = linkValue;
      linkBtn.target = '_blank';
      linkBtn.rel = 'noopener noreferrer';
        linkBtn.innerHTML = 'üîó Link';
        linkBtn.title = 'Click ƒë·ªÉ m·ªü link: ' + linkValue;
        linkBtn.style.cssText = 'background: rgba(16, 185, 129, 0.15); color: #10b981; font-size: 13px; font-weight: 500; padding: 6px 12px; border-radius: 8px; text-decoration: none; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px;';
      linkBtn.addEventListener('click', function(e) {
        e.stopPropagation();
          // Ensure link opens in new tab
          window.open(linkValue, '_blank', 'noopener,noreferrer');
        });
        linkBtn.addEventListener('mouseenter', function() {
          this.style.background = 'rgba(16, 185, 129, 0.25)';
          this.style.transform = 'scale(1.05)';
        });
        linkBtn.addEventListener('mouseleave', function() {
          this.style.background = 'rgba(16, 185, 129, 0.15)';
          this.style.transform = 'scale(1)';
      });
      labelRow.appendChild(linkBtn);
      } else {
        // If link is not a valid URL, don't show anything (hide invalid links)
        // This prevents showing non-URL text like "2025 (H2-ver02) - Daily Truck..."
        // Uncomment below if you want to show invalid links as text info
        /*
        var linkInfo = document.createElement('span');
        linkInfo.className = 'task-link-info';
        linkInfo.innerHTML = 'üìé ' + (linkValue.length > 30 ? linkValue.substring(0, 30) + '...' : linkValue);
        linkInfo.title = 'Link: ' + linkValue;
        linkInfo.style.cssText = 'background: rgba(156, 163, 175, 0.15); color: #9ca3af; font-size: 11px; padding: 4px 8px; border-radius: 6px; display: inline-block;';
        labelRow.appendChild(linkInfo);
        */
      }
    }
    
    // Add Note button (üìù) - NEW FEATURE for task notes
    var noteBtn = document.createElement('button');
    noteBtn.className = 'task-note-btn';
    noteBtn.innerHTML = 'üìù';
    noteBtn.title = 'Ghi ch√∫ s·ª± v·ª• c√≥ li√™n quan';
    noteBtn.style.cssText = 'background: rgba(245, 158, 11, 0.15); border: none; color: #f59e0b; font-size: 16px; padding: 6px 10px; border-radius: 8px; cursor: pointer; transition: all 0.2s; min-width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center;';
    noteBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      showTaskNoteModal(task);
    });
    noteBtn.addEventListener('mouseenter', function() {
      this.style.background = 'rgba(245, 158, 11, 0.25)';
      this.style.transform = 'scale(1.1)';
    });
    noteBtn.addEventListener('mouseleave', function() {
      this.style.background = 'rgba(245, 158, 11, 0.15)';
      this.style.transform = 'scale(1)';
    });
    labelRow.appendChild(noteBtn);
    
    content.appendChild(labelRow);
    
    item.appendChild(checkbox);
    item.appendChild(content);
    
    return item;
  }
  
  function showSkeleton(selector) {
    var container = selector ? document.querySelector(selector) : document.getElementById('vRows');
    if (!container) return;
    container.innerHTML = '';
    for (var i = 0; i < 6; i++) {
      var skeleton = document.createElement('div');
      skeleton.className = 'skeleton';
      skeleton.style.margin = '8px 0';
      skeleton.style.height = '48px';
      container.appendChild(skeleton);
    }
  }
  
  function updateKPI() {
    var tasks = tasksData[currentHub] || [];
    var done = tasks.filter(function(t) { return t.completed; }).length;
    var total = tasks.length;
    
    // Fix: Use jQuery .text() method or vanilla JS
    var doneEl = document.getElementById('done');
    var todoEl = document.getElementById('todo');
    if (doneEl) doneEl.textContent = done;
    if (todoEl) todoEl.textContent = total - done;
    
    // Also update the unfinished tile click handler if needed
    var unfinishedCount = total - done;
    var unfinishedTile = document.getElementById('unfinishedTile');
    if (unfinishedTile && unfinishedCount > 0) {
      unfinishedTile.style.cursor = 'pointer';
      unfinishedTile.title = 'Click ƒë·ªÉ xem ' + unfinishedCount + ' tasks ch∆∞a ho√†n th√†nh';
    }
  }
  
  function getTaskPriority(task) {
    if (!task || !task.priority || !PRIORITY_LEVELS[task.priority]) {
      return 'medium';
    }
    return task.priority;
  }
  
  function applyPriority(task, priority) {
    var normalized = (priority || '').toLowerCase().trim();
    if (!PRIORITY_LEVELS[normalized]) {
      toast('ƒê·ªô ∆∞u ti√™n kh√¥ng h·ª£p l·ªá (ch·ªâ high / medium / low)', 'err');
      return false;
    }
    task.priority = normalized;
    renderTasks();
    saveTasks();
    toast('ƒê√£ c·∫≠p nh·∫≠t ƒë·ªô ∆∞u ti√™n: ' + PRIORITY_LEVELS[normalized].label, 'ok');
    return true;
  }
  
  function openPriorityPrompt(task) {
    var current = getTaskPriority(task);
    var input = prompt('Nh·∫≠p ƒë·ªô ∆∞u ti√™n (high / medium / low):', current);
    if (input === null) return;
    applyPriority(task, input);
  }
  
  function setTaskPriority(taskId, priority) {
    var tasks = tasksData[currentHub] || [];
    var found = null;
    for (var i = 0; i < tasks.length; i++) {
      if (tasks[i].id === taskId) {
        found = tasks[i];
        break;
      }
    }
    if (!found) {
      console.warn('setTaskPriority: Task not found for id', taskId);
      return;
    }
    applyPriority(found, priority || 'medium');
  }
  window.setTaskPriority = setTaskPriority;
  
  function setSLAForTask(task) {
    var currentSLA = task.sla || '';
    var newSLA = prompt('Nh·∫≠p SLA (format: HH:MM, v√≠ d·ª•: 14:30):', currentSLA);
    
    if (newSLA === null) return; // User cancelled
    
    // Validate SLA format
    if (newSLA && !/^\d{1,2}:\d{2}$/.test(newSLA)) {
      toast('SLA ph·∫£i c√≥ format HH:MM (v√≠ d·ª•: 14:30)', 'err');
      return;
    }
    
    task.sla = newSLA || null;
    
    // Re-render tasks to show updated SLA
    renderTasks();
    
    // Save tasks
    saveTasks();
    
    // Sync to Google Calendar if SLA is set
    if (task.sla) {
      syncTasksToCalendar();
      toast('ƒê√£ set SLA v√† sync v·ªõi Google Calendar!', 'ok');
    } else {
      toast('ƒê√£ x√≥a SLA', 'ok');
    }
  }
  
  function syncTasksToCalendar() {
    var hub = currentHub;
    var date = $('#date').value || todayStr();
    var tasks = tasksData[hub] || [];
    
    // Only sync tasks with SLA
    var tasksWithSLA = tasks.filter(function(t) { return t.sla; });
    
    if (tasksWithSLA.length === 0) {
      return;
    }
    
    callApi('syncSlaToCalendar', {
      hub: hub,
      date: date,
      tasks: tasksWithSLA
    }).then(function(result) {
      if (result && result.ok) {
        console.log('Calendar sync:', result.created + ' created, ' + result.skipped + ' skipped');
      }
    }).catch(function(error) {
      console.error('Calendar sync failed:', error);
    });
  }
  
  function addAdHocTask() {
    var text = prompt('Nh·∫≠p t√™n task:');
    if (!text || !text.trim()) return;
    
    var tasks = tasksData[currentHub] || [];
    var newTask = {
      id: 'adhoc_' + Date.now(),
      category: 'Trong Ca',
      text: text.trim(),
      isLead: false,
      completed: false,
      adHoc: true,
      sla: null
    };
    
    tasks.push(newTask);
    tasksData[currentHub] = tasks;
    renderTasks();
    updateKPI();
    
    toast('ƒê√£ th√™m task t·ª©c th√¨', 'ok');
  }
  
  /* ====== CHARTS & DASHBOARD SYSTEM ====== */
  
  var ChartLoader = (function() {
    var chartSrc = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
    var dataLabelSrc = 'https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js';
    var registering = false;
    var chartPromise = null;
    
    function registerPlugin() {
      if (typeof Chart !== 'undefined' && typeof window.ChartDataLabels !== 'undefined' && Chart.register && !registering) {
        registering = true;
        try {
          Chart.register(window.ChartDataLabels);
        } catch (e) {
          console.warn('[ChartLoader] Plugin registration failed:', e);
        }
      }
    }
    
    return {
      ensure: function() {
        if (typeof Chart !== 'undefined' && typeof window.ChartDataLabels !== 'undefined') {
          registerPlugin();
          return Promise.resolve();
        }
        
        if (chartPromise) {
          return chartPromise;
        }
        
        chartPromise = loadExternalScript(chartSrc)
          .then(function() {
            return loadExternalScript(dataLabelSrc);
          })
          .then(function() {
            registerPlugin();
          })
          .catch(function(error) {
            console.error('[ChartLoader] Failed to load chart libraries:', error);
            chartPromise = null;
            throw error;
          });
        
        return chartPromise;
      }
    };
  })();
  
  var ChartManager = {
    charts: {},
    
    // Chart color scheme
    colors: {
      primary: '#ff6a00',
      secondary: '#ffb300',
      success: '#10b981',
      warning: '#f59e0b',
      danger: '#ef4444',
      info: '#3b82f6',
      muted: '#64748b',
      background: 'rgba(255, 255, 255, 0.1)'
    },
    
    // Get theme colors
    getThemeColors: function() {
      var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      return {
        text: isDark ? '#f3f4f6' : '#111827',
        grid: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
        background: isDark ? 'rgba(0, 0, 0, 0.2)' : 'rgba(255, 255, 255, 0.5)'
      };
    },
    
    // Destroy chart
    destroy: function(chartId) {
      if (this.charts[chartId]) {
        this.charts[chartId].destroy();
        delete this.charts[chartId];
      }
    },
    
    // Destroy all charts
    destroyAll: function() {
      for (var chartId in this.charts) {
        this.destroy(chartId);
      }
    },
    
    // Task Completion Chart (Doughnut)
    renderCompletionChart: function(canvasId, completed, total) {
      var canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      this.destroy(canvasId);
      
      var pending = total - completed;
      var theme = this.getThemeColors();
      
      var ctx = canvas.getContext('2d');
      this.charts[canvasId] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Ho√†n th√†nh', 'Ch∆∞a ho√†n th√†nh'],
          datasets: [{
            data: [completed, pending],
            backgroundColor: [this.colors.success, this.colors.muted],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: theme.text,
                padding: 15,
                font: { size: 12 }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  var label = context.label || '';
                  var value = context.parsed || 0;
                  var total = context.dataset.data.reduce(function(a, b) { return a + b; }, 0);
                  var percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return label + ': ' + value + ' (' + percentage + '%)';
                }
              }
            },
            datalabels: {
              color: theme.text,
              font: { size: 14, weight: 'bold' },
              formatter: function(value, context) {
                var total = context.dataset.data.reduce(function(a, b) { return a + b; }, 0);
                return total > 0 ? Math.round((value / total) * 100) + '%' : '0%';
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    },
    
    // Tasks by Category Chart (Bar)
    renderCategoryChart: function(canvasId, categoryData) {
      var canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      this.destroy(canvasId);
      
      var theme = this.getThemeColors();
      var labels = categoryData.map(function(c) { return c.category; });
      var completed = categoryData.map(function(c) { return c.completed; });
      var total = categoryData.map(function(c) { return c.total; });
      
      var ctx = canvas.getContext('2d');
      this.charts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Ho√†n th√†nh',
              data: completed,
              backgroundColor: this.colors.success,
              borderColor: this.colors.success,
              borderWidth: 1
            },
            {
              label: 'T·ªïng',
              data: total,
              backgroundColor: this.colors.muted,
              borderColor: this.colors.muted,
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: theme.text,
                stepSize: 1
              },
              grid: {
                color: theme.grid
              }
            },
            x: {
              ticks: {
                color: theme.text
              },
              grid: {
                color: theme.grid
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: theme.text,
                padding: 10
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  var label = context.dataset.label || '';
                  var value = context.parsed.y || 0;
                  return label + ': ' + value;
                }
              }
            }
          }
        }
      });
    },
    
    // Daily Progress Chart (Line)
    renderDailyChart: function(canvasId, dailyData) {
      var canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      this.destroy(canvasId);
      
      var theme = this.getThemeColors();
      var labels = dailyData.map(function(d) { return d.date; });
      var completed = dailyData.map(function(d) { return d.completed; });
      var total = dailyData.map(function(d) { return d.total; });
      
      var ctx = canvas.getContext('2d');
      this.charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Ho√†n th√†nh',
              data: completed,
              borderColor: this.colors.success,
              backgroundColor: this.colors.success + '20',
              tension: 0.4,
              fill: true
            },
            {
              label: 'T·ªïng',
              data: total,
              borderColor: this.colors.primary,
              backgroundColor: this.colors.primary + '20',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: {
            mode: 'index',
            intersect: false
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: theme.text,
                stepSize: 1
              },
              grid: {
                color: theme.grid
              }
            },
            x: {
              ticks: {
                color: theme.text
              },
              grid: {
                color: theme.grid
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: theme.text,
                padding: 10
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          }
        }
      });
    },
    
    // Hub Comparison Chart (Bar)
    renderHubChart: function(canvasId, hubData) {
      var canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      this.destroy(canvasId);
      
      var theme = this.getThemeColors();
      var labels = hubData.map(function(h) { return h.hubId; });
      var completed = hubData.map(function(h) { return h.completed; });
      var total = hubData.map(function(h) { return h.total; });
      
      var ctx = canvas.getContext('2d');
      this.charts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Ho√†n th√†nh',
              data: completed,
              backgroundColor: this.colors.success,
              borderColor: this.colors.success,
              borderWidth: 1
            },
            {
              label: 'T·ªïng',
              data: total,
              backgroundColor: this.colors.muted,
              borderColor: this.colors.muted,
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: theme.text,
                stepSize: 1
              },
              grid: {
                color: theme.grid
              }
            },
            x: {
              ticks: {
                color: theme.text
              },
              grid: {
                color: theme.grid
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: theme.text,
                padding: 10
              }
            }
          }
        }
      });
    },
    
    // Hourly Visits Chart (Line)
    renderHourlyChart: function(canvasId, hourlyData) {
      var canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      this.destroy(canvasId);
      
      var theme = this.getThemeColors();
      var labels = hourlyData.map(function(h) { return h.hour + 'h'; });
      var visits = hourlyData.map(function(h) { return h.count; });
      
      var ctx = canvas.getContext('2d');
      this.charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Truy c·∫≠p',
            data: visits,
            borderColor: this.colors.primary,
            backgroundColor: this.colors.primary + '20',
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: theme.text,
                stepSize: 1
              },
              grid: {
                color: theme.grid
              }
            },
            x: {
              ticks: {
                color: theme.text
              },
              grid: {
                color: theme.grid
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'Truy c·∫≠p: ' + context.parsed.y;
                }
              }
            }
          }
        }
      });
    }
  };
  
  /* ====== REPORT MODULE ====== */
  
  function setupReportHub() {
    var sel = document.getElementById('reportHub');
    if (!sel) return;
    
    sel.innerHTML = '<option value="ALL">üåê T·∫•t c·∫£ Hubs (Multi-Hub Overview)</option>';
    
    var hubs = Object.keys(hubData);
    hubs.forEach(function(hubId) {
      var opt = document.createElement('option');
      opt.value = hubId;
      opt.textContent = hubData[hubId].name;
      sel.appendChild(opt);
    });
    
    sel.value = 'ALL';
  }
  
  function loadReport() {
    var hub = $('#reportHub') ? $('#reportHub').value : currentHub;
    var rangeMode = $('.btn.active[data-r]');
    var mode = rangeMode ? rangeMode.getAttribute('data-r') : 'month';
    
    var range;
    // Handle custom date range
    if (mode === 'custom') {
      var startDate = $('#reportDateStart') ? $('#reportDateStart').value : '';
      var endDate = $('#reportDateEnd') ? $('#reportDateEnd').value : '';
      
      if (!startDate || !endDate) {
        toast('Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c', 'err');
        return;
      }
      
      range = { start: startDate, end: endDate };
    } else {
      var date = $('#reportDate') ? $('#reportDate').value : todayStr();
      range = calculateDateRange(mode, date);
    }
    
    // Hide empty state and show loading
    var emptyState = document.getElementById('reportEmptyState');
    var loadingState = document.getElementById('reportLoadingState');
    var chartsContainer = document.getElementById('reportCharts');
    var dataContainer = document.getElementById('reportDataContainer');
    
    if (emptyState) emptyState.style.display = 'none';
    if (loadingState) loadingState.style.display = 'block';
    if (chartsContainer) chartsContainer.style.display = 'none';
    if (dataContainer) dataContainer.innerHTML = '';
    
    callApi('loadReport', {
      hub: hub,
      start: range.start,
      end: range.end
    }).then(function(data) {
      if (!data || data.error) {
        if (emptyState) emptyState.style.display = 'block';
        if (loadingState) loadingState.style.display = 'none';
        toast('L·ªói: ' + (data ? data.error : 'No data received'), 'err');
        return;
      }
      
      renderReportData(data, hub);
    }).catch(function(error) {
      if (emptyState) emptyState.style.display = 'block';
      if (loadingState) loadingState.style.display = 'none';
      toast('L·ªói: ' + (error.message || error), 'err');
    });
  }
  
  function renderReportData(data, selectedHub) {
    var container = document.getElementById('reportContent');
    if (!container) return;
    
    // Check if multi-hub
    var isMultiHub = selectedHub === 'ALL' && data.hubs;
    
    // Hide empty state and loading, show charts container
    var emptyState = document.getElementById('reportEmptyState');
    var loadingState = document.getElementById('reportLoadingState');
    var chartsContainer = document.getElementById('reportCharts');
    
    if (emptyState) emptyState.style.display = 'none';
    if (loadingState) loadingState.style.display = 'none';
    if (chartsContainer) {
      chartsContainer.style.display = 'block';
    }
    
    // Render KPI Cards - Enhanced with Hub Statistics
    var kpiCards = document.getElementById('reportKPICards');
    if (kpiCards) {
      kpiCards.innerHTML = '';
      
      // Calculate additional metrics
      var activeHubsCount = 0;
      var completed100HubsCount = 0;
      
      if (isMultiHub && data.hubs && data.hubs.length > 0) {
        // Count active hubs (hubs with tasks)
        activeHubsCount = data.hubs.filter(function(hub) {
          return hub.total > 0;
        }).length;
        
        // Count hubs with 100% completion
        completed100HubsCount = data.hubs.filter(function(hub) {
          return hub.total > 0 && hub.completed === hub.total;
        }).length;
      }
      
      var kpis = [
        { title: 'T·ªïng Tasks', value: data.summary.total || 0, icon: 'üìã', color: '#3b82f6', bg: 'rgba(59,130,246,0.1)' },
        { title: 'Ho√†n th√†nh', value: data.summary.completed || 0, icon: '‚úÖ', color: '#10b981', bg: 'rgba(16,185,129,0.1)' },
        { title: 'C√≤n l·∫°i', value: data.summary.pending || 0, icon: '‚è≥', color: '#f59e0b', bg: 'rgba(245,158,11,0.1)' },
        { title: 'SLA Rate', value: (data.summary.onTimeRate || 0) + '%', icon: '‚è∞', color: '#8b5cf6', bg: 'rgba(139,92,246,0.1)' }
      ];
      
      // Add Hub statistics if multi-hub
      if (isMultiHub) {
        kpis.push(
          { title: 'Hub Thao T√°c', value: activeHubsCount, icon: 'üè¢', color: '#06b6d4', bg: 'rgba(6,182,212,0.1)' },
          { title: 'Hub Ho√†n Th√†nh 100%', value: completed100HubsCount, icon: 'üéØ', color: '#14b8a6', bg: 'rgba(20,184,166,0.1)' }
        );
      }
      
      kpis.forEach(function(kpi) {
        var card = document.createElement('div');
        card.className = 'glass';
        var cardColor = kpi.color || '#3b82f6';
        var cardBg = kpi.bg || 'rgba(59,130,246,0.1)';
        card.style.cssText = 'padding:12px;text-align:center;border-radius:10px;transition:transform 0.2s,box-shadow 0.2s;border-left:3px solid ' + cardColor;
        card.style.background = cardBg + ', var(--glass)';
        card.onmouseenter = function() {
          this.style.transform = 'translateY(-2px)';
          this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        };
        card.onmouseleave = function() {
          this.style.transform = 'translateY(0)';
          this.style.boxShadow = 'none';
        };
        card.innerHTML = `
          <div style="font-size:24px;margin-bottom:6px">${kpi.icon}</div>
          <div style="font-size:20px;font-weight:700;color:${cardColor};margin-bottom:3px">${kpi.value}</div>
          <div style="font-size:11px;color:var(--muted);font-weight:500;line-height:1.3">${kpi.title}</div>
        `;
        kpiCards.appendChild(card);
      });
    }
    
    // Render charts (lazy load Chart.js on demand)
    ChartLoader.ensure().then(function() {
      if (typeof Chart === 'undefined' || !ChartManager) return;
      
      // Task Completion Chart
      ChartManager.renderCompletionChart('reportCompletionChart', data.summary.completed, data.summary.total);
      
      // Tasks by Category Chart
      if (data.categories && data.categories.length > 0) {
        ChartManager.renderCategoryChart('reportCategoryChart', data.categories);
      }
      
      // Daily Progress Chart
      if (data.daily && data.daily.length > 0) {
        ChartManager.renderDailyChart('reportDailyChart', data.daily);
      }
      
      // Hub Comparison Chart (if multi-hub)
      if (isMultiHub && data.hubs && data.hubs.length > 0) {
        var hubChartContainer = document.getElementById('reportHubChartContainer');
        if (hubChartContainer) {
          hubChartContainer.style.display = 'block';
        }
        ChartManager.renderHubChart('reportHubChart', data.hubs);
      } else {
        var hubChartContainer = document.getElementById('reportHubChartContainer');
        if (hubChartContainer) {
          hubChartContainer.style.display = 'none';
        }
      }
      
      // Setup download buttons for all charts
      setupChartDownloadButtons();
    }).catch(function(error) {
      console.error('[Report] Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán Chart.js:', error);
      toast('Kh√¥ng th·ªÉ t·∫£i bi·ªÉu ƒë·ªì (Chart.js). Vui l√≤ng th·ª≠ l·∫°i sau.', 'warn');
    });
    
    // Render data tables in separate container
    var dataContainer = document.getElementById('reportDataContainer');
    if (!dataContainer) {
      dataContainer = document.createElement('div');
      dataContainer.id = 'reportDataContainer';
      container.appendChild(dataContainer);
    }
    dataContainer.innerHTML = '';
    
    // Summary section
    var summary = document.createElement('div');
    summary.className = 'section glass';
    summary.innerHTML = `
      <h3>üìä T·ªïng Quan${isMultiHub ? ' - T·∫•t C·∫£ Hubs' : ''}</h3>
      <div class="grid">
        <div class="tile glass">
          <div class="n">${data.summary.total}</div>
          <div class="t">T·ªïng Tasks</div>
        </div>
        <div class="tile glass">
          <div class="n">${data.summary.completed}</div>
          <div class="t">Ho√†n th√†nh</div>
        </div>
        <div class="tile glass">
          <div class="n">${data.summary.pending}</div>
          <div class="t">C√≤n l·∫°i</div>
        </div>
        <div class="tile glass">
          <div class="n">${data.summary.onTimeRate}%</div>
          <div class="t">SLA Rate</div>
        </div>
      </div>
    `;
    
    dataContainer.appendChild(summary);
  }
  
  function exportExcelReport() {
    var hub = $('#reportHub') ? $('#reportHub').value : currentHub;
    var date = $('#reportDate').value || todayStr();
    var rangeMode = $('.btn.active[data-r]');
    var mode = rangeMode ? rangeMode.getAttribute('data-r') : 'month';
    
    var range = calculateDateRange(mode, date);
    
    toast('ƒêang t·∫°o file Excel...', 'ok');
    
    callApi('exportToExcel', {
      hub: hub,
      start: range.start,
      end: range.end
    }).then(function(result) {
      if (!result || result.error) {
        toast('L·ªói: ' + (result ? result.error : 'No data received'), 'err');
        return;
      }
      
      toast('Excel ƒë√£ ƒë∆∞·ª£c t·∫°o! M·ªü link...', 'ok');
      window.open(result.url, '_blank');
    }).catch(function(error) {
      toast('L·ªói: ' + (error.message || error), 'err');
    });
  }
  
  function exportPDFReport() {
    var hub = $('#reportHub') ? $('#reportHub').value : currentHub;
    var date = $('#reportDate').value || todayStr();
    var rangeMode = $('.btn.active[data-r]');
    var mode = rangeMode ? rangeMode.getAttribute('data-r') : 'month';
    
    var range = calculateDateRange(mode, date);
    
    toast('ƒêang t·∫°o file PDF...', 'ok');
    
    callApi('exportToPDF', {
      hub: hub,
      start: range.start,
      end: range.end
    }).then(function(result) {
      if (!result || result.error) {
        toast('L·ªói: ' + (result ? result.error : 'No data received'), 'err');
        return;
      }
      
      toast('PDF ƒë√£ ƒë∆∞·ª£c t·∫°o! M·ªü link...', 'ok');
      window.open(result.url, '_blank');
    }).catch(function(error) {
      toast('L·ªói: ' + (error.message || error), 'err');
    });
  }
  
  /* ====== HIGHLIGHT MODULE ====== */
  
  function loadHighlight() {
    var hub = currentHub;
    var date = $('#hlDate').value || todayStr();
    var rangeMode = $('#hlRange .btn.active');
    var mode = rangeMode ? rangeMode.getAttribute('data-r') : 'today';
    
    var range = calculateDateRange(mode, date);
    
    callApi('getHighlights', {
      hub: hub,
      start: range.start,
      end: range.end
    }).then(function(data) {
      if (!data || data.error) {
        toast('L·ªói: ' + (data ? data.error : 'No data received'), 'err');
        return;
      }
      
      renderHighlightData(data);
    }).catch(function(error) {
      toast('L·ªói: ' + (error.message || error), 'err');
    });
  }
  
  function renderHighlightData(data) {
    var grid = $('#hlGrid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    // KPI cards
    var cards = [
      { title: 'Active Users', value: data.activeUsers, icon: 'üë•' },
      { title: 'Truy c·∫≠p', value: data.visits, icon: 'üîç' },
      { title: 'Thao t√°c', value: data.interactions, icon: '‚ö°' },
      { title: 'Tasks ho√†n th√†nh', value: data.tasksDone, icon: '‚úÖ' },
      { title: 'SLA On-time', value: data.slaOnTime, icon: '‚è∞' },
      { title: 'SLA Rate', value: data.slaRate + '%', icon: 'üìä' }
    ];
    
    cards.forEach(function(card) {
      var tile = document.createElement('div');
      tile.className = 'tile glass';
      tile.innerHTML = `
        <div class="tile-head"><strong>${esc(card.title)}</strong></div>
        <div class="n">${esc(String(card.value))}</div>
      `;
      grid.appendChild(tile);
    });
    
    // Hourly chart with Chart.js
    var chartTile = document.createElement('div');
    chartTile.className = 'tile glass';
    chartTile.style.gridColumn = 'span 2';
    chartTile.style.padding = '20px';
    
    var chartTitle = document.createElement('div');
    chartTitle.className = 'tile-head';
    chartTitle.innerHTML = '<strong>Truy c·∫≠p theo gi·ªù</strong>';
    chartTile.appendChild(chartTitle);
    
    var chartCanvas = document.createElement('canvas');
    chartCanvas.id = 'hlHourlyChart';
    chartCanvas.style.maxHeight = '300px';
    chartTile.appendChild(chartCanvas);
    
    grid.appendChild(chartTile);
    
    // Render hourly chart with Chart.js
    if (typeof Chart !== 'undefined' && ChartManager && data.visitsByHour) {
      ChartManager.renderHourlyChart('hlHourlyChart', data.visitsByHour);
    }
  }
  
  /* ====== CHART DOWNLOAD FUNCTIONALITY ====== */
  
  function setupChartDownloadButtons() {
    // Remove existing event listeners by cloning and replacing buttons
    var downloadButtons = document.querySelectorAll('.btn-download-chart');
    downloadButtons.forEach(function(btn) {
      // Clone button to remove old listeners
      var newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      
      // Add click handler
      newBtn.addEventListener('click', function() {
        var chartId = this.getAttribute('data-chart-id');
        var chartName = this.getAttribute('data-chart-name') || chartId;
        downloadChart(chartId, chartName);
      });
      
      // Add hover effect
      newBtn.addEventListener('mouseenter', function() {
        this.style.background = 'rgba(59,130,246,0.2)';
        this.style.transform = 'scale(1.05)';
      });
      newBtn.addEventListener('mouseleave', function() {
        this.style.background = 'rgba(59,130,246,0.1)';
        this.style.transform = 'scale(1)';
      });
    });
  }
  
  function downloadChart(canvasId, chartName) {
    try {
      var canvas = document.getElementById(canvasId);
      if (!canvas) {
        toast('Kh√¥ng t√¨m th·∫•y chart', 'err');
        return;
      }
      
      // Check if Chart.js chart exists
      if (typeof ChartManager !== 'undefined' && ChartManager.charts && ChartManager.charts[canvasId]) {
        var chart = ChartManager.charts[canvasId];
        // Use Chart.js toBase64Image method
        var url = chart.toBase64Image('image/png', 1);
        downloadImage(url, chartName + '_' + new Date().toISOString().slice(0, 10) + '.png');
      } else {
        // Fallback: use canvas toDataURL
        var url = canvas.toDataURL('image/png');
        downloadImage(url, chartName + '_' + new Date().toISOString().slice(0, 10) + '.png');
      }
      
      toast('ƒê√£ t·∫£i ·∫£nh chart th√†nh c√¥ng!', 'ok');
    } catch (error) {
      console.error('Download chart error:', error);
      toast('L·ªói khi t·∫£i ·∫£nh: ' + error.message, 'err');
    }
  }
  
  function downloadImage(dataUrl, filename) {
    try {
      var link = document.createElement('a');
      link.download = filename;
      link.href = dataUrl;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (error) {
      console.error('Download image error:', error);
      toast('L·ªói khi t·∫£i file: ' + error.message, 'err');
    }
  }
  
  /* ====== ACCESS LOG MODULE ====== */
  
  function setupAccessFilters() {
    callApi('getAllUsers', {}).then(function(users) {
      var sel = document.getElementById('accessUser');
      if (!sel) return;
      
      sel.innerHTML = '<option value="">üßë T·∫•t c·∫£ Users</option>';
      
      // Fix: Check if users is valid array
      if (!users || !Array.isArray(users) || users.length === 0) {
        console.warn('No users data received or invalid format');
        return;
      }
      
      users.forEach(function(user) {
        var opt = document.createElement('option');
        opt.value = user.email;
        opt.textContent = user.displayName || user.email;
        sel.appendChild(opt);
      });
    }).catch(function(e) {
      console.error('Failed to load users for filter:', e);
    });
  }
  
  function loadAccessLog() {
    var filterUser = $('#accessUser') ? $('#accessUser').value : '';
    var filterAction = $('#accessActionType') ? $('#accessActionType').value : '';
    var startDate = $('#accessDateStart') ? $('#accessDateStart').value : '';
    var endDate = $('#accessDateEnd') ? $('#accessDateEnd').value : '';
    
    // Show loading skeleton
    var container = document.getElementById('accessList');
    if (container) {
      container.innerHTML = '';
      // Create skeleton table
      var skeletonTable = document.createElement('div');
      skeletonTable.className = 'glass';
      skeletonTable.style.padding = '20px';
      skeletonTable.style.borderRadius = '12px';
      for (var i = 0; i < 5; i++) {
        var skeletonRow = document.createElement('div');
        skeletonRow.className = 'skeleton';
        skeletonRow.style.height = '50px';
        skeletonRow.style.marginBottom = '12px';
        skeletonTable.appendChild(skeletonRow);
      }
      container.appendChild(skeletonTable);
    }
    
    callApi('getAuditLog', {
      email: filterUser,
      action: filterAction,
      hub: currentHub,
      startDate: startDate,
      endDate: endDate,
      limit: 200
    }).then(function(logs) {
      // getAuditLog returns an array, not an object with error property
      if (!Array.isArray(logs)) {
        if (container) {
          container.innerHTML = '<p class="hint" style="padding:40px;text-align:center">L·ªói: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá</p>';
        }
        toast('L·ªói: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá', 'err');
        return;
      }
      
      // Empty array is valid - just means no logs found
      renderAccessLog(logs);
      renderAccessStats(logs);
    }).catch(function(error) {
      console.error('[Access Log] Error:', error);
      if (container) {
        container.innerHTML = '<p class="hint" style="padding:40px;text-align:center">L·ªói: ' + (error.message || error) + '</p>';
      }
      toast('L·ªói: ' + (error.message || error), 'err');
    });
  }
  
  function renderAccessStats(logs) {
    var statsContainer = document.getElementById('accessStats');
    if (!statsContainer || !logs || logs.length === 0) return;
    
    // Calculate stats
    var totalLogs = logs.length;
    var uniqueUsers = new Set(logs.map(function(log) { return log.email; })).size;
    var loginCount = logs.filter(function(log) { return log.action === 'LOGIN'; }).length;
    var actionTypes = {};
    logs.forEach(function(log) {
      actionTypes[log.action] = (actionTypes[log.action] || 0) + 1;
    });
    var topAction = Object.keys(actionTypes).reduce(function(a, b) {
      return actionTypes[a] > actionTypes[b] ? a : b;
    }, '');
    
    statsContainer.innerHTML = `
      <div class="glass" style="padding:16px;text-align:center;border-radius:12px">
        <div style="font-size:24px;font-weight:700;color:#3b82f6;margin-bottom:4px">${totalLogs}</div>
        <div style="font-size:12px;color:var(--muted)">T·ªïng Logs</div>
      </div>
      <div class="glass" style="padding:16px;text-align:center;border-radius:12px">
        <div style="font-size:24px;font-weight:700;color:#10b981;margin-bottom:4px">${uniqueUsers}</div>
        <div style="font-size:12px;color:var(--muted)">Users</div>
      </div>
      <div class="glass" style="padding:16px;text-align:center;border-radius:12px">
        <div style="font-size:24px;font-weight:700;color:#f59e0b;margin-bottom:4px">${loginCount}</div>
        <div style="font-size:12px;color:var(--muted)">Logins</div>
      </div>
      <div class="glass" style="padding:16px;text-align:center;border-radius:12px">
        <div style="font-size:20px;font-weight:700;color:#8b5cf6;margin-bottom:4px">${topAction}</div>
        <div style="font-size:12px;color:var(--muted)">Top Action</div>
      </div>
    `;
  }
  
  function clearAccessFilter() {
    if ($('#accessUser')) $('#accessUser').value = '';
    if ($('#accessActionType')) $('#accessActionType').value = '';
    var startDate = $('#accessDateStart');
    var endDate = $('#accessDateEnd');
    if (startDate) {
      var today = new Date();
      var lastWeek = new Date(today);
      lastWeek.setDate(today.getDate() - 7);
      startDate.value = lastWeek.toISOString().slice(0, 10);
    }
    if (endDate) {
      endDate.value = new Date().toISOString().slice(0, 10);
    }
    loadAccessLog();
  }
  
  function viewAccessDetail(log) {
    var timestamp = new Date(log.timestamp).toLocaleString(lang === 'en' ? 'en-US' : 'vi-VN');
    var details = log.details ? JSON.stringify(log.details, null, 2) : 'N/A';
    var session = log.sessionInfo ? JSON.stringify(log.sessionInfo, null, 2) : 'N/A';
    
    var html = `
      <div style="padding:20px">
        <h3>üìã Chi Ti·∫øt Access Log</h3>
        <div class="group" style="margin-top:16px">
          <div><strong>Email:</strong> ${esc(log.email)}</div>
          <div><strong>Action:</strong> ${esc(log.action)}</div>
          <div><strong>Hub:</strong> ${esc(log.hub || '-')}</div>
          <div><strong>Timestamp:</strong> ${timestamp}</div>
        </div>
        <div class="group" style="margin-top:16px">
          <div><strong>Details:</strong></div>
          <pre style="background:var(--bg);padding:12px;border-radius:8px;overflow:auto;max-height:200px">${esc(details)}</pre>
        </div>
        <div class="group" style="margin-top:16px">
          <div><strong>Session Info:</strong></div>
          <pre style="background:var(--bg);padding:12px;border-radius:8px;overflow:auto;max-height:200px">${esc(session)}</pre>
        </div>
        <div style="margin-top:20px;text-align:center">
          <button onclick="this.closest('.modal').remove()" class="btn btn-primary">ƒê√≥ng</button>
        </div>
      </div>
    `;
    
    showModal(html);
  }
  
  function exportAccessLogData() {
    var filterUser = $('#accessUser') ? $('#accessUser').value : '';
    var filterAction = $('#accessActionType') ? $('#accessActionType').value : '';
    
    toast('ƒêang t·∫°o Excel...', 'ok');
    
    callApi('exportAccessLog', {
      email: filterUser,
      action: filterAction,
      hub: currentHub
    }).then(function(result) {
      if (!result || result.error) {
        toast('L·ªói: ' + (result ? result.error : 'Failed'), 'err');
        return;
      }
      
      toast('Excel ƒë√£ t·∫°o! M·ªü link...', 'ok');
      window.open(result.url, '_blank');
    }).catch(function(error) {
      toast('L·ªói: ' + (error.message || error), 'err');
    });
  }
  
  function renderAccessLog(logs) {
    var container = document.getElementById('accessList');
    if (!container) return;
    container.innerHTML = '';
    
    if (!logs || logs.length === 0) {
      var emptyState = createEmptyState({
        icon: 'üîç',
        title: 'Kh√¥ng c√≥ log n√†o',
        description: 'Kh√¥ng t√¨m th·∫•y log n√†o trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn. H√£y th·ª≠ ƒëi·ªÅu ch·ªânh b·ªô l·ªçc.',
        actionLabel: 'üîÑ Reset b·ªô l·ªçc',
        onAction: clearAccessFilter
      });
      container.innerHTML = '';
      container.appendChild(emptyState);
      return;
    }
    
    // Create table for better display
    var table = document.createElement('table');
    table.className = 'table';
    table.style.cssText = 'width:100%;border-collapse:collapse';
    table.innerHTML = `
      <thead>
        <tr style="background:rgba(0,0,0,0.03);border-bottom:2px solid var(--stroke);position:sticky;top:0;z-index:10">
          <th style="padding:12px;text-align:left;font-weight:600;font-size:13px;color:var(--ink)">Th·ªùi gian</th>
          <th style="padding:12px;text-align:left;font-weight:600;font-size:13px;color:var(--ink)">User</th>
          <th style="padding:12px;text-align:left;font-weight:600;font-size:13px;color:var(--ink)">Action</th>
          <th style="padding:12px;text-align:left;font-weight:600;font-size:13px;color:var(--ink)">Hub</th>
          <th style="padding:12px;text-align:center;font-weight:600;font-size:13px;color:var(--ink)">Chi ti·∫øt</th>
        </tr>
      </thead>
      <tbody id="accessLogBody"></tbody>
    `;
    
    var tbody = table.querySelector('tbody');
    
    logs.forEach(function(log) {
      var tr = document.createElement('tr');
      tr.style.cssText = 'border-bottom:1px solid var(--stroke);transition:background 0.2s;cursor:pointer';
      tr.onmouseenter = function() { this.style.background = 'rgba(0,0,0,0.02)'; };
      tr.onmouseleave = function() { this.style.background = 'transparent'; };
      
      var timestamp = new Date(log.timestamp);
      var timeStr = timestamp.toLocaleString(lang === 'en' ? 'en-US' : 'vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      var actionIcon = {
        'LOGIN': 'üîê',
        'SAVE_TASKS': 'üíæ',
        'TAB_SWITCH': 'üìë',
        'SEND_CHAT_MESSAGE': 'üí¨',
        'ANSWER_QUESTION': '‚ùì',
        'LOAD_REPORT': 'üìä',
        'EXPORT': 'üìó'
      }[log.action] || 'üìù';
      
      tr.innerHTML = `
        <td style="padding:12px;font-size:13px;color:var(--muted);white-space:nowrap">${timeStr}</td>
        <td style="padding:12px;font-weight:500;color:var(--ink)">${esc(log.email)}</td>
        <td style="padding:12px">
          <span class="chip" style="background:rgba(59,130,246,0.1);color:#3b82f6;font-size:12px">${actionIcon} ${esc(log.action)}</span>
        </td>
        <td style="padding:12px;color:var(--ink)">${esc(log.hub || '-')}</td>
        <td style="padding:12px;text-align:center">
          <button class="btn btn-soft btn-sm view-log-btn" style="padding:6px 12px;font-size:12px">üëÅÔ∏è Xem</button>
        </td>
      `;
      
      tr.addEventListener('click', function() {
        viewAccessDetail(log);
      });
      
      var viewBtn = tr.querySelector('.view-log-btn');
      if (viewBtn) {
        viewBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          viewAccessDetail(log);
        });
      }
      
      tbody.appendChild(tr);
    });
    
    container.appendChild(table);
    
    // Make viewAccessDetail available globally
    window.viewAccessDetail = viewAccessDetail;
    
    // End performance monitoring
    if (perfLabel) {
      var duration = PerformanceMonitor.end(perfLabel);
      PerformanceMonitor.checkPerformance('render-access-log', duration);
    }
  }
  
  function showModal(html) {
    var modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:grid;place-items:center;z-index:9999;';
    
    var box = document.createElement('div');
    box.className = 'glass';
    box.style.cssText = 'max-width:600px;width:90%;max-height:80vh;overflow:auto;border-radius:16px;';
    box.innerHTML = html;
    
    modal.appendChild(box);
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
      if (e.target === modal) modal.remove();
    });
    
    // Return box element so we can access it
    return box;
  }
  
  // Removed duplicate showTaskInfoModal - using the one at line 932 instead
  
  /* ====== ADMIN MODULE ====== */
  
  function loadUsers() {
    if (currentUser.role !== 'admin') {
      toast('B·∫°n kh√¥ng c√≥ quy·ªÅn admin', 'err');
      return;
    }
    
    // Show loading skeleton
    var tbody = $('#usersTableBody');
    if (tbody) {
      var skeletonRow = document.createElement('tr');
      skeletonRow.innerHTML = '<td colspan="7" style="padding:40px">';
      var skeletonContainer = document.createElement('div');
      skeletonContainer.style.display = 'grid';
      skeletonContainer.style.gridTemplateColumns = 'repeat(7, 1fr)';
      skeletonContainer.style.gap = '12px';
      for (var i = 0; i < 7; i++) {
        var skeleton = document.createElement('div');
        skeleton.className = 'skeleton skeleton-text';
        skeleton.style.height = '20px';
        skeletonContainer.appendChild(skeleton);
      }
      skeletonRow.querySelector('td').appendChild(skeletonContainer);
      tbody.innerHTML = '';
      tbody.appendChild(skeletonRow);
    }
    
    callApi('getAllUsers').then(function(users) {
      // getAllUsers returns an array, not an object with error property
      if (!Array.isArray(users)) {
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px">L·ªói: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá</td></tr>';
        }
        toast('L·ªói: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá', 'err');
        return;
      }
      
      // Empty array is valid - just means no users found
      renderUsersTable(users);
    }).catch(function(error) {
      console.error('[Admin] Load users error:', error);
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px">L·ªói: ' + (error.message || error) + '</td></tr>';
      }
      toast('L·ªói: ' + (error.message || error), 'err');
    });
  }
  
  var allUsersData = []; // Store all users for filtering
  
  function renderUsersTable(users) {
    allUsersData = users || [];
    var tbody = $('#usersTableBody');
    tbody.innerHTML = '';
    
    if (!users || users.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px">';
      var emptyState = createEmptyState({
        icon: 'üë•',
        title: 'Ch∆∞a c√≥ user n√†o',
        description: 'B·∫Øt ƒë·∫ßu b·∫±ng c√°ch th√™m user m·ªõi v√†o h·ªá th·ªëng.',
        actionLabel: '+ Th√™m User',
        onAction: function() {
          var addBtn = document.getElementById('addUser');
          if (addBtn) addBtn.click();
        }
      });
      var emptyCell = document.createElement('td');
      emptyCell.colSpan = 7;
      emptyCell.style.padding = '0';
      emptyCell.appendChild(emptyState);
      var emptyRow = document.createElement('tr');
      emptyRow.appendChild(emptyCell);
      tbody.appendChild(emptyRow);
      renderUserStats([]);
      return;
    }
    
    renderUserStats(users);
    filterUsersTable(''); // Render all users initially
  }
  
  function renderUserStats(users) {
    var statsContainer = document.getElementById('adminUserStats');
    if (!statsContainer) return;
    
    var totalUsers = users.length;
    var activeUsers = users.filter(function(u) { return u.active; }).length;
    var adminUsers = users.filter(function(u) { return u.role === 'admin'; }).length;
    var regularUsers = users.filter(function(u) { return u.role === 'user'; }).length;
    
    statsContainer.innerHTML = `
      <div class="glass" style="padding:16px;text-align:center;border-radius:12px">
        <div style="font-size:24px;font-weight:700;color:#3b82f6;margin-bottom:4px">${totalUsers}</div>
        <div style="font-size:12px;color:var(--muted)">T·ªïng Users</div>
      </div>
      <div class="glass" style="padding:16px;text-align:center;border-radius:12px">
        <div style="font-size:24px;font-weight:700;color:#10b981;margin-bottom:4px">${activeUsers}</div>
        <div style="font-size:12px;color:var(--muted)">Active</div>
      </div>
      <div class="glass" style="padding:16px;text-align:center;border-radius:12px">
        <div style="font-size:24px;font-weight:700;color:#8b5cf6;margin-bottom:4px">${adminUsers}</div>
        <div style="font-size:12px;color:var(--muted)">Admins</div>
      </div>
      <div class="glass" style="padding:16px;text-align:center;border-radius:12px">
        <div style="font-size:24px;font-weight:700;color:#f59e0b;margin-bottom:4px">${regularUsers}</div>
        <div style="font-size:12px;color:var(--muted)">Users</div>
      </div>
    `;
  }
  
  function filterUsersTable(searchTerm) {
    var tbody = $('#usersTableBody');
    if (!tbody) return;
    
    var filtered = allUsersData;
    if (searchTerm && searchTerm.trim() !== '') {
      var term = searchTerm.toLowerCase();
      filtered = allUsersData.filter(function(user) {
        return (user.email && user.email.toLowerCase().indexOf(term) !== -1) ||
               (user.displayName && user.displayName.toLowerCase().indexOf(term) !== -1) ||
               (user.hub && user.hub.toLowerCase().indexOf(term) !== -1);
      });
    }
    
    tbody.innerHTML = '';
    
    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px">Kh√¥ng t√¨m th·∫•y user n√†o</td></tr>';
      return;
    }
    
    filtered.forEach(function(user) {
      var tr = document.createElement('tr');
      tr.style.cssText = 'border-bottom:1px solid var(--stroke);transition:background 0.2s';
      tr.onmouseenter = function() { this.style.background = 'rgba(0,0,0,0.02)'; };
      tr.onmouseleave = function() { this.style.background = 'transparent'; };
      
      var lastAccess = user.lastAccess ? new Date(user.lastAccess).toLocaleString(lang === 'en' ? 'en-US' : 'vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      }) : 'Ch∆∞a c√≥';
      
      var roleColor = user.role === 'admin' ? '#8b5cf6' : '#3b82f6';
      var roleBg = user.role === 'admin' ? 'rgba(139,92,246,0.1)' : 'rgba(59,130,246,0.1)';
      
      tr.innerHTML = `
        <td style="padding:12px;font-weight:500;color:var(--ink)">${esc(user.email)}</td>
        <td style="padding:12px;color:var(--ink)">${esc(user.displayName || '-')}</td>
        <td style="padding:12px;color:var(--ink)">${esc(user.hub || '-')}</td>
        <td style="padding:12px;text-align:center">
          <span class="chip" style="background:${roleBg};color:${roleColor};font-size:12px">${esc(user.role || 'user')}</span>
        </td>
        <td style="padding:12px;text-align:center">
          ${user.active ? '<span class="chip" style="background:#10b981;color:#fff;font-size:12px">‚úÖ Active</span>' : '<span class="chip" style="background:rgba(239,68,68,0.1);color:#ef4444;font-size:12px">‚ùå Inactive</span>'}
        </td>
        <td style="padding:12px;text-align:center;font-size:12px;color:var(--muted)">${lastAccess}</td>
        <td style="padding:12px;text-align:center">
          <div style="display:flex;gap:6px;justify-content:center">
            <button class="btn btn-soft btn-sm" onclick="editUser('${esc(user.email)}')" style="padding:6px 12px;font-size:12px">‚úèÔ∏è Edit</button>
            <button class="btn btn-soft btn-sm" onclick="deleteUserConfirm('${esc(user.email)}')" style="padding:6px 12px;font-size:12px;background:rgba(239,68,68,0.1);color:#ef4444">üóëÔ∏è Delete</button>
          </div>
        </td>
      `;
      
      tbody.appendChild(tr);
    });
  }
  
  function getUserByEmail(email, users) {
    if (!users || !email) return null;
    for (var i = 0; i < users.length; i++) {
      if (String(users[i].email).toLowerCase() === String(email).toLowerCase()) {
        return users[i];
      }
    }
    return null;
  }
  
  function showUserDialog(userData, isEdit) {
    var title = isEdit ? '‚úèÔ∏è Ch·ªânh S·ª≠a User' : '‚ûï Th√™m User M·ªõi';
    var emailValue = userData ? esc(userData.email) : '';
    var hubValue = userData ? esc(userData.hub) : '';
    var roleValue = userData ? esc(userData.role) : 'user';
    var activeValue = userData ? (userData.active ? 'true' : 'false') : 'true';
    var displayNameValue = userData ? esc(userData.displayName || '') : '';
    var photoUrlValue = userData ? esc(userData.photoUrl || '') : '';
    var emailDisabled = isEdit ? 'readonly style="background:var(--hover);cursor:not-allowed"' : '';
    
    var html = '<div style="padding:24px">';
    html += '<h3 style="margin:0 0 20px;font-size:20px;color:var(--fg)">' + title + '</h3>';
    
    // Form fields
    html += '<form id="userForm" onsubmit="return false;">';
    
    // Email field
    html += '<div class="group" style="margin-bottom:16px">';
    html += '<div class="label">Email <span style="color:#ef4444">*</span></div>';
    html += '<div class="control">';
    html += '<input type="email" id="userEmail" value="' + emailValue + '" ' + emailDisabled + ' required placeholder="user@spx.vn" style="width:100%"/>';
    html += '</div>';
    html += '</div>';
    
    // Hub field
    html += '<div class="group" style="margin-bottom:16px">';
    html += '<div class="label">Hub <span style="color:#ef4444">*</span></div>';
    html += '<div class="control">';
    html += '<input type="text" id="userHub" value="' + hubValue + '" required placeholder="80TVH01 ho·∫∑c 80TVH01,80TVH02 ho·∫∑c ALL" style="width:100%"/>';
    html += '<small style="color:var(--muted);font-size:12px;display:block;margin-top:4px">C√≥ th·ªÉ g√°n nhi·ªÅu hub b·∫±ng d·∫•u ph·∫©y (,) ho·∫∑c ALL cho admin</small>';
    html += '</div>';
    html += '</div>';
    
    // Role field
    html += '<div class="group" style="margin-bottom:16px">';
    html += '<div class="label">Role <span style="color:#ef4444">*</span></div>';
    html += '<div class="control">';
    html += '<select id="userRole" required style="width:100%">';
    html += '<option value="user"' + (roleValue === 'user' ? ' selected' : '') + '>User</option>';
    html += '<option value="admin"' + (roleValue === 'admin' ? ' selected' : '') + '>Admin</option>';
    html += '</select>';
    html += '</div>';
    html += '</div>';
    
    // Active field
    html += '<div class="group" style="margin-bottom:16px">';
    html += '<div class="label">Tr·∫°ng th√°i <span style="color:#ef4444">*</span></div>';
    html += '<div class="control">';
    html += '<select id="userActive" required style="width:100%">';
    html += '<option value="true"' + (activeValue === 'true' ? ' selected' : '') + '>Active</option>';
    html += '<option value="false"' + (activeValue === 'false' ? ' selected' : '') + '>Inactive</option>';
    html += '</select>';
    html += '</div>';
    html += '</div>';
    
    // Display Name field
    html += '<div class="group" style="margin-bottom:16px">';
    html += '<div class="label">T√™n hi·ªÉn th·ªã</div>';
    html += '<div class="control">';
    html += '<input type="text" id="userDisplayName" value="' + displayNameValue + '" placeholder="T√™n ng∆∞·ªùi d√πng" style="width:100%"/>';
    html += '</div>';
    html += '</div>';
    
    // Photo URL field
    html += '<div class="group" style="margin-bottom:20px">';
    html += '<div class="label">Photo URL</div>';
    html += '<div class="control">';
    html += '<input type="url" id="userPhotoUrl" value="' + photoUrlValue + '" placeholder="https://..." style="width:100%"/>';
    html += '<small style="color:var(--muted);font-size:12px;display:block;margin-top:4px">URL ·∫£nh ƒë·∫°i di·ªán (t√πy ch·ªçn)</small>';
    html += '</div>';
    html += '</div>';
    
    // Buttons
    html += '<div style="display:flex;gap:8px;justify-content:flex-end">';
    html += '<button type="button" class="btn btn-soft" onclick="this.closest(\'.modal\').remove()">H·ªßy</button>';
    html += '<button type="submit" class="btn btn-primary">üíæ ' + (isEdit ? 'C·∫≠p nh·∫≠t' : 'Th√™m') + '</button>';
    html += '</div>';
    
    html += '</form>';
    html += '</div>';
    
    // Show modal and get box element
    var modalBox = showModal(html);
    
    // Setup form submit handler - form is already in the box
    var form = modalBox.querySelector('#userForm');
    if (form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        saveUserFromForm(isEdit, modalBox);
      });
    }
  }
  
  function saveUserFromForm(isEdit, modalBox) {
    // Get form elements from modal box or document
    var container = modalBox || document;
    var emailEl = container.querySelector('#userEmail');
    var hubEl = container.querySelector('#userHub');
    var roleEl = container.querySelector('#userRole');
    var activeEl = container.querySelector('#userActive');
    var displayNameEl = container.querySelector('#userDisplayName');
    var photoUrlEl = container.querySelector('#userPhotoUrl');
    
    // Safety check: ensure all required elements exist
    if (!emailEl || !hubEl || !roleEl || !activeEl || !displayNameEl || !photoUrlEl) {
      toast('L·ªói: Kh√¥ng t√¨m th·∫•y c√°c tr∆∞·ªùng form c·∫ßn thi·∫øt', 'err');
      return;
    }
    
    var email = emailEl.value.trim();
    var hub = hubEl.value.trim();
    var role = roleEl.value;
    var active = activeEl.value === 'true';
    var displayName = displayNameEl.value.trim();
    var photoUrl = photoUrlEl.value.trim();
    
    // Validation
    if (!email) {
      toast('Email kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng', 'err');
      return;
    }
    
    if (!hub) {
      toast('Hub kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng', 'err');
      return;
    }
    
    // Email validation
    var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      toast('Email kh√¥ng h·ª£p l·ªá', 'err');
      return;
    }
    
    // Prepare user data
    var userData = {
      email: email,
      hub: hub,
      role: role,
      active: active,
      displayName: displayName,
      photoUrl: photoUrl
    };
    
    // Show loading
    var submitBtn = container.querySelector('#userForm button[type="submit"]');
    var originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '‚è≥ ƒêang l∆∞u...';
    submitBtn.disabled = true;
    
    // Call API
    callApi('saveUser', userData).then(function(result) {
      if (result.status === 'ok') {
        toast(isEdit ? 'ƒê√£ c·∫≠p nh·∫≠t user th√†nh c√¥ng' : 'ƒê√£ th√™m user th√†nh c√¥ng', 'ok');
        
        // Close modal
        var modal = document.querySelector('.modal');
        if (modal) modal.remove();
        
        // Reload users table
        loadUsers();
      } else {
        toast('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ l∆∞u user'), 'err');
        if (submitBtn) {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }
    }).catch(function(error) {
      toast('L·ªói: ' + error.message, 'err');
      if (submitBtn) {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });
  }
  
  function showAddUserDialog() {
    showUserDialog(null, false);
  }
  
  window.editUser = function(email) {
    // Load users to get user data
    callApi('getAllUsers').then(function(users) {
      if (!users || users.error) {
        toast('L·ªói: Kh√¥ng th·ªÉ t·∫£i danh s√°ch users', 'err');
        return;
      }
      
      var user = getUserByEmail(email, users);
      if (!user) {
        toast('Kh√¥ng t√¨m th·∫•y user: ' + email, 'err');
        return;
      }
      
      // Show edit dialog with user data
      showUserDialog(user, true);
    }).catch(function(error) {
      toast('L·ªói: ' + error.message, 'err');
    });
  };
  
  window.deleteUserConfirm = function(email) {
    if (!confirm('X√≥a user ' + email + '?')) return;
    
    callApi('deleteUser', { email: email }).then(function(result) {
      if (result.status === 'ok') {
        toast('ƒê√£ x√≥a user', 'ok');
        loadUsers();
      } else {
        toast('L·ªói: ' + result.message, 'err');
      }
    }).catch(function(error) {
      toast('L·ªói: ' + error.message, 'err');
    });
  };
  
  /* ====== DATE RANGE HELPERS ====== */
  
  function calculateDateRange(mode, baseDate) {
    var base = new Date(baseDate);
    var start, end;
    
    switch(mode) {
      case 'today':
        start = end = baseDate;
        break;
      
      case 'week':
        var dayOfWeek = base.getDay();
        var monday = new Date(base);
        monday.setDate(base.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        
        var sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        
        start = monday.toISOString().slice(0, 10);
        end = sunday.toISOString().slice(0, 10);
        break;
      
      case 'month':
        start = baseDate.slice(0, 8) + '01';
        var lastDay = new Date(base.getFullYear(), base.getMonth() + 1, 0);
        end = lastDay.toISOString().slice(0, 10);
        break;
      
      default:
        start = end = baseDate;
    }
    
    return { start: start, end: end };
  }
  
  /* ====== TAB SWITCHING ====== */
  
  function setupTabs() {
    $$('.tab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        var tabName = tab.getAttribute('data-tab');
        
        // Update active states
        $$('.tab').forEach(function(t) { t.classList.remove('active'); });
        $$('.content').forEach(function(c) { c.classList.remove('active'); });
        
        tab.classList.add('active');
        var content = document.querySelector('[data-content="' + tabName + '"]');
        if (content) content.classList.add('active');
        
        // Load data for specific tabs
        switch(tabName) {
          case 'admin':
            if (currentUser.role === 'admin') {
            loadUsers();
              // Setup search
              setTimeout(function() {
                var searchInput = document.getElementById('adminSearchUser');
                if (searchInput) {
                  searchInput.addEventListener('input', function() {
                    filterUsersTable(this.value);
                  });
                }
              }, 300);
            } else {
              toast('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p m√¥ ƒëun Admin', 'err');
            }
            break;
          case 'qa':
            setupQA();
            // Auto-load questions
            setTimeout(function() {
              loadQA();
            }, 300);
            break;
          case 'unfinished':
            loadUnfinished();
            break;
          case 'report':
            setupReportHub();
            // Auto-load report when switching to report tab
            setTimeout(function() {
              if (document.getElementById('reportContent')) {
                loadReport();
              }
            }, 300);
            break;
        }
        
        // Log tab switch
        callApi('logEvent', {
          action: 'TAB_SWITCH',
          hub: currentHub,
          details: { tab: tabName }
        });
      });
    });
  }
  
  /* ====== THEME & LANGUAGE ====== */
  
  var currentGradient = localStorage.getItem('spx_gradient') || '';
  
  function setupTheme() {
    document.documentElement.setAttribute('data-theme', theme);
    
    // Apply saved gradient theme
    if (currentGradient) {
      document.documentElement.setAttribute('data-gradient', currentGradient);
    }
    
    function toggleTheme() {
      theme = theme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('spx_theme', theme);
    }
    
    function setupGradientSelector() {
      var gradientBtn = document.getElementById('gradientThemeBtn');
      var gradientMenu = document.getElementById('gradientThemeMenu');
      var coverGradientBtn = document.getElementById('coverGradientThemeBtn');
      var coverGradientMenu = document.getElementById('coverGradientThemeMenu');
      
      function toggleGradientMenu(menu) {
        var isVisible = menu.style.display === 'block';
        // Close all menus first
        var allMenus = document.querySelectorAll('#gradientThemeMenu, #coverGradientThemeMenu');
        allMenus.forEach(function(m) { m.style.display = 'none'; });
        // Toggle current menu
        if (!isVisible) {
          menu.style.display = 'block';
        }
      }
      
      function applyGradient(gradientName) {
        currentGradient = gradientName;
        if (gradientName) {
          document.documentElement.setAttribute('data-gradient', gradientName);
        } else {
          document.documentElement.removeAttribute('data-gradient');
        }
        localStorage.setItem('spx_gradient', gradientName);
        
        // Close menus
        if (gradientMenu) gradientMenu.style.display = 'none';
        if (coverGradientMenu) coverGradientMenu.style.display = 'none';
        
        toast('Gradient theme ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng!', 'ok');
      }
      
      if (gradientBtn && gradientMenu) {
        gradientBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          toggleGradientMenu(gradientMenu);
        });
      }
      
      if (coverGradientBtn && coverGradientMenu) {
        coverGradientBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          toggleGradientMenu(coverGradientMenu);
        });
      }
      
      // Handle gradient option clicks
      var gradientOptions = document.querySelectorAll('.gradient-option');
      gradientOptions.forEach(function(option) {
        option.addEventListener('click', function() {
          var gradientName = this.getAttribute('data-gradient') || '';
          applyGradient(gradientName);
        });
      });
      
      // Close menu when clicking outside
      document.addEventListener('click', function(e) {
        if (gradientMenu && !gradientMenu.contains(e.target) && !gradientBtn.contains(e.target)) {
          gradientMenu.style.display = 'none';
        }
        if (coverGradientMenu && !coverGradientMenu.contains(e.target) && !coverGradientBtn.contains(e.target)) {
          coverGradientMenu.style.display = 'none';
        }
      });
    }
    
    setupGradientSelector();
    
    var themeToggle = document.getElementById('themeToggle');
    var coverTheme = document.getElementById('coverTheme');
    
    if (themeToggle) themeToggle.addEventListener('click', toggleTheme);
    if (coverTheme) coverTheme.addEventListener('click', toggleTheme);
  }
  
  function setupLanguage() {
    // i18n translations
    var translations = {
      vi: {
        'langToggle': 'VI/EN',
        'langToggle2': 'VI/EN',
        'i18n-back': 'Trang b√¨a',
        'i18n-cover-title': 'Qu·∫£n L√Ω Checklist H√†ng Ng√†y',
        'i18n-cover-sub': 'Theo d√µi ti·∫øn ƒë·ªô c√¥ng vi·ªác, qu·∫£n l√Ω hub, v√† c·ªông t√°c nh√≥m theo th·ªùi gian th·ª±c v·ªõi ph√¢n quy·ªÅn b·∫£o m·∫≠t.',
        'i18n-hub-label': 'ƒêang xem ti·∫øn ƒë·ªô Hub',
        'i18n-date-label': 'Ng√†y checklist',
        'i18n-filter-label': 'T√¨m ki·∫øm & L·ªçc',
        'i18n-online': 'Online'
      },
      en: {
        'langToggle': 'EN/VI',
        'langToggle2': 'EN/VI',
        'i18n-back': 'Cover Page',
        'i18n-cover-title': 'Daily Checklist Management',
        'i18n-cover-sub': 'Track work progress, manage hubs, and collaborate in real-time with secure role-based access.',
        'i18n-hub-label': 'Viewing Hub Progress',
        'i18n-date-label': 'Checklist Date',
        'i18n-filter-label': 'Search & Filter',
        'i18n-online': 'Online'
      }
    };
    
    function applyLanguage(newLang) {
      var dict = translations[newLang] || translations.vi;
      Object.keys(dict).forEach(function(key) {
        var el = document.getElementById(key);
        if (el) {
          if (el.tagName === 'BUTTON' || el.tagName === 'SPAN') {
            el.textContent = dict[key];
          } else {
            el.textContent = dict[key];
          }
        }
      });
      lang = newLang;
      localStorage.setItem('spx_lang', newLang);
    }
    
    function toggleLang() {
      var newLang = lang === 'vi' ? 'en' : 'vi';
      applyLanguage(newLang);
      toast('Language switched to ' + newLang.toUpperCase(), 'ok');
    }
    
    // Apply saved language on load
    var savedLang = localStorage.getItem('spx_lang') || 'vi';
    applyLanguage(savedLang);
    
    var langToggle = document.getElementById('langToggle');
    var langToggle2 = document.getElementById('langToggle2');
    if (langToggle) langToggle.addEventListener('click', toggleLang);
    if (langToggle2) langToggle2.addEventListener('click', toggleLang);
  }
  
  /* ====== VIETNAM HOLIDAYS GREETING ====== */
  
  function checkVietnamHolidays() {
    var today = new Date();
    var month = today.getMonth() + 1; // 1-12
    var day = today.getDate();
    
    var holidays = {
      '1-1': 'üéâ Ch√∫c M·ª´ng NƒÉm M·ªõi!',
      '2-14': 'üíù Ch√∫c M·ª´ng Ng√†y Valentine!',
      '3-8': 'üå∏ Ch√∫c M·ª´ng Ng√†y Qu·ªëc T·∫ø Ph·ª• N·ªØ 8/3!',
      '4-30': 'üáªüá≥ Ch√∫c M·ª´ng Ng√†y Gi·∫£i Ph√≥ng Mi·ªÅn Nam 30/4!',
      '5-1': 'üéä Ch√∫c M·ª´ng Ng√†y Qu·ªëc T·∫ø Lao ƒê·ªông 1/5!',
      '9-2': 'üáªüá≥ Ch√∫c M·ª´ng Ng√†y Qu·ªëc Kh√°nh 2/9!',
      '10-20': 'üå∏ Ch√∫c M·ª´ng Ng√†y Ph·ª• N·ªØ Vi·ªát Nam 20/10!',
      '11-20': 'üë®‚Äçüè´ Ch√∫c M·ª´ng Ng√†y Nh√† Gi√°o Vi·ªát Nam 20/11!',
      '12-24': 'üéÑ Ch√∫c M·ª´ng Gi√°ng Sinh!',
      '12-25': 'üéÖ Ch√∫c M·ª´ng L·ªÖ Noel!'
    };
    
    var key = month + '-' + day;
    var greeting = holidays[key];
    
    var greetingEl = document.getElementById('holidayGreeting');
    if (greeting && greetingEl) {
      greetingEl.textContent = greeting;
      greetingEl.style.display = 'block';
    } else if (greetingEl) {
      greetingEl.style.display = 'none';
    }
  }
  
  /* ====== INITIALIZATION ====== */
  
  function initUI() {
    // Setup bulk operations buttons
    var bulkSelectBtn = document.getElementById('bulkSelectBtn');
    var bulkEditBtn = document.getElementById('bulkEditBtn');
    var bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    var bulkExportBtn = document.getElementById('bulkExportBtn');
    var bulkCancelBtn = document.getElementById('bulkCancelBtn');
    
    if (bulkSelectBtn) {
      bulkSelectBtn.addEventListener('click', function() {
        BulkOperations.toggleSelectionMode();
      });
    }
    
    if (bulkEditBtn) {
      bulkEditBtn.addEventListener('click', function() {
        BulkOperations.bulkEdit();
      });
    }
    
    if (bulkDeleteBtn) {
      bulkDeleteBtn.addEventListener('click', function() {
        BulkOperations.bulkDelete();
      });
    }
    
    if (bulkExportBtn) {
      bulkExportBtn.addEventListener('click', function() {
        BulkOperations.bulkExport();
      });
    }
    
    if (bulkCancelBtn) {
      bulkCancelBtn.addEventListener('click', function() {
        BulkOperations.toggleSelectionMode();
      });
    }
    
    // Initialize bulk operations UI
    if (bulkSelectBtn) bulkSelectBtn.style.display = 'inline-block';
    if (bulkEditBtn) bulkEditBtn.style.display = 'none';
    if (bulkDeleteBtn) bulkDeleteBtn.style.display = 'none';
    if (bulkExportBtn) bulkExportBtn.style.display = 'none';
    if (bulkCancelBtn) bulkCancelBtn.style.display = 'none';
    
    // Setup date inputs
    var dateEl = document.querySelector('#date');
    var reportDateEl = document.querySelector('#reportDate');
    var hlDateEl = document.querySelector('#hlDate');
    
    if (dateEl) dateEl.value = todayStr();
    if (reportDateEl) reportDateEl.value = todayStr();
    if (hlDateEl) hlDateEl.value = todayStr();
    
    // Event listeners - Main
    var enterBtn = document.querySelector('#enterAppBtn');
    var backBtn = document.querySelector('#backCover');
    var saveBtn = document.querySelector('#saveBtn');
    var addAdHocBtn = document.querySelector('#addAdHoc');
    
    if (enterBtn) enterBtn.addEventListener('click', enterApp);
    if (backBtn) backBtn.addEventListener('click', showCover);
    if (saveBtn) saveBtn.addEventListener('click', saveTasks);
    if (addAdHocBtn) addAdHocBtn.addEventListener('click', addAdHocTask);
    
    // Hub change
    var hubSelect = document.querySelector('#hub');
    if (hubSelect) {
      hubSelect.addEventListener('change', function() {
        currentHub = this.value;
        localStorage.setItem('currentHubId', currentHub);
        loadTasks();
      });
    }
    
    // Date change
    if (dateEl) dateEl.addEventListener('change', loadTasks);
    
    // Report module  
    var refreshReportBtn = document.querySelector('#refreshReport');
    var quickLoadReportBtn = document.querySelector('#quickLoadReport');
    var exportExcelBtn = document.querySelector('#exportExcel');
    var exportPDFBtn = document.querySelector('#exportPDF');
    
    if (refreshReportBtn) refreshReportBtn.addEventListener('click', loadReport);
    if (quickLoadReportBtn) quickLoadReportBtn.addEventListener('click', loadReport);
    if (exportExcelBtn) exportExcelBtn.addEventListener('click', exportExcelReport);
    if (exportPDFBtn) exportPDFBtn.addEventListener('click', exportPDFReport);
    
    // Report date pickers and range buttons
    var reportDateEl = document.querySelector('#reportDate');
    var reportDateStartEl = document.querySelector('#reportDateStart');
    var reportDateEndEl = document.querySelector('#reportDateEnd');
    var reportDateDefault = document.getElementById('reportDateDefault');
    var reportDateCustom = document.getElementById('reportDateCustom');
    var reportRangeEl = document.querySelector('#reportRange');
    
    function updateReportDateDisplay() {
      try {
        var activeBtn = reportRangeEl ? reportRangeEl.querySelector('.btn.active[data-r]') : null;
        var mode = activeBtn ? activeBtn.getAttribute('data-r') : 'month';
        
        if (mode === 'custom') {
          if (reportDateDefault) reportDateDefault.style.display = 'none';
          if (reportDateCustom) {
            reportDateCustom.style.display = 'flex';
            // Set default dates if not set
            if (reportDateStartEl && !reportDateStartEl.value) {
              var today = new Date();
              var firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
              reportDateStartEl.value = firstDay.toISOString().slice(0, 10);
            }
            if (reportDateEndEl && !reportDateEndEl.value) {
              reportDateEndEl.value = todayStr();
            }
          }
        } else {
          if (reportDateDefault) reportDateDefault.style.display = 'block';
          if (reportDateCustom) reportDateCustom.style.display = 'none';
        }
      } catch (e) {
        console.error('Error in updateReportDateDisplay:', e);
      }
    }
    
    if (reportDateEl) reportDateEl.addEventListener('change', loadReport);
    if (reportDateStartEl) reportDateStartEl.addEventListener('change', loadReport);
    if (reportDateEndEl) reportDateEndEl.addEventListener('change', loadReport);
    
    // Report range buttons
    if (reportRangeEl) {
      // Initial display update
      updateReportDateDisplay();
      
      reportRangeEl.addEventListener('click', function(e) {
        if (e.target && e.target.tagName === 'BUTTON') {
          var btns = document.querySelectorAll('#reportRange .btn');
          btns.forEach(function(btn) { btn.classList.remove('active'); });
          e.target.classList.add('active');
          updateReportDateDisplay();
          // Only auto-load if not custom mode (custom requires user to select dates)
          var mode = e.target.getAttribute('data-r');
          if (mode !== 'custom') {
          loadReport();
          }
        }
      });
    }
    
    // Highlight module
    var refreshHlBtn = document.querySelector('#refreshHl');
    if (refreshHlBtn) refreshHlBtn.addEventListener('click', loadHighlight);
    if (hlDateEl) hlDateEl.addEventListener('change', loadHighlight);
    
    // Highlight range buttons
    var hlRangeEl = document.querySelector('#hlRange');
    if (hlRangeEl) {
      hlRangeEl.addEventListener('click', function(e) {
        if (e.target && e.target.tagName === 'BUTTON') {
          var btns = document.querySelectorAll('#hlRange .btn');
          btns.forEach(function(btn) { btn.classList.remove('active'); });
          e.target.classList.add('active');
          loadHighlight();
        }
      });
    }
    
    // Access log module
    var filterAccessBtn = document.querySelector('#filterAccess');
    var clearAccessBtn = document.querySelector('#clearAccessFilter');
    var exportAccessBtn = document.querySelector('#exportAccessLog');
    if (filterAccessBtn) filterAccessBtn.addEventListener('click', loadAccessLog);
    if (clearAccessBtn) clearAccessBtn.addEventListener('click', clearAccessFilter);
    if (exportAccessBtn) exportAccessBtn.addEventListener('click', exportAccessLogData);
    
    // Admin module
    var addUserBtn = document.querySelector('#addUser');
    var refreshUsersBtn = document.querySelector('#refreshUsers');
    if (addUserBtn) addUserBtn.addEventListener('click', showAddUserDialog);
    if (refreshUsersBtn) refreshUsersBtn.addEventListener('click', loadUsers);
    
    // Notes module
    var noteAddBtn = document.querySelector('#noteAdd');
    var noteSaveBtn = document.querySelector('#noteSave');
    if (noteAddBtn) noteAddBtn.addEventListener('click', addNote);
    if (noteSaveBtn) noteSaveBtn.addEventListener('click', saveNotesData);
    
    // Setup new modules
    setupUnfinished();
    setupReportHub();
    // Setup floating chat
    setupFloatingChat();
    
    // Setup tabs
    setupTabs();
    
    // Setup theme & language
    setupTheme();
    setupLanguage();
    
    // Check Vietnam holidays
    checkVietnamHolidays();
    
    // Update clock every second
    setInterval(updateClock, 1000);
    updateClock();
  }
  
  /* ====== NOTES MODULE ====== */
  
  function loadNotesData() {
    var hub = currentHub;
    var dateEl = $('#date');
    var date = (dateEl && dateEl.value) ? dateEl.value : todayStr();
    var key = 'notes_' + hub + '_' + date;
    
    callApi('loadNotes', { storageKey: key }).then(function(notes) {
      renderNotes(notes || []);
    }).catch(function(error) {
      console.error('Load notes error:', error);
    });
  }
  
  function renderNotes(notes) {
    var container = document.getElementById('noteList');
    if (!container) return;
    container.innerHTML = '';
    
    if (!notes || notes.length === 0) {
      container.innerHTML = '<div class="hint">Ch∆∞a c√≥ ghi ch√∫ n√†o</div>';
      return;
    }
    
    notes.forEach(function(note) {
      var item = document.createElement('div');
      item.className = 'item';
      
      var timestamp = new Date(note.at).toLocaleString(lang === 'en' ? 'en-US' : 'vi-VN');
      
      item.innerHTML = `
        <div style="flex:1">
          <div style="font-weight:700">${esc(note.author || 'User')}</div>
          <div class="t">${timestamp}</div>
          <div style="margin-top:6px;white-space:pre-wrap">${esc(note.text)}</div>
        </div>
      `;
      
      container.appendChild(item);
    });
  }
  
  function addNote() {
    var input = $('#noteInput');
    var text = input.value.trim();
    
    if (!text) {
      toast('Vui l√≤ng nh·∫≠p n·ªôi dung ghi ch√∫', 'warn');
      return;
    }
    
    var hub = currentHub;
    var dateEl = $('#date');
    var date = (dateEl && dateEl.value) ? dateEl.value : todayStr();
    var key = 'notes_' + hub + '_' + date;
    
    // Get current notes
    callApi('loadNotes', { storageKey: key }).then(function(notes) {
      notes = notes || [];
      
      // Add new note
      var newNote = {
        id: 'note_' + Date.now(),
        text: text,
        at: new Date().toISOString(),
        author: currentUser.displayName || currentUser.email
      };
      
      notes.push(newNote);
      
      // Save
      return callApi('saveNotes', { storageKey: key, notes: notes });
    }).then(function(result) {
      if (result.status === 'ok') {
        toast('ƒê√£ th√™m ghi ch√∫', 'ok');
        input.value = '';
        loadNotesData();
      } else {
        toast('L·ªói: ' + result.message, 'err');
      }
    }).catch(function(error) {
      toast('L·ªói: ' + error.message, 'err');
    });
  }
  
  function saveNotesData() {
    toast('Ghi ch√∫ ƒë∆∞·ª£c l∆∞u t·ª± ƒë·ªông', 'ok');
  }
  
  /* ====== Q&A MODULE ====== */
  
  var currentQAFilter = 'all';
  
  function setupQA() {
    var submitBtn = $('#qaSubmit');
    var refreshBtn = $('#qaRefresh');
    
    if (submitBtn) {
      submitBtn.addEventListener('click', submitQA);
    }
    
    if (refreshBtn) {
      refreshBtn.addEventListener('click', loadQA);
    }
    
    // Filter buttons
    var filterBtns = document.querySelectorAll('[data-qa-filter]');
    filterBtns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        filterBtns.forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        currentQAFilter = btn.getAttribute('data-qa-filter');
        loadQA();
      });
    });
    
    // Load on tab switch
    loadQA();
  }
  
  function submitQA() {
    var category = $('#qaCategory').value;
    var question = $('#qaQuestion').value;
    
    if (!question.trim()) {
      toast('Vui l√≤ng nh·∫≠p c√¢u h·ªèi', 'err');
      return;
    }
    
    callApi('submitQuestion', { category: category, question: question.trim() })
      .then(function(result) {
        if (result && result.status === 'ok') {
          toast('ƒê√£ g·ª≠i c√¢u h·ªèi th√†nh c√¥ng!', 'ok');
          $('#qaQuestion').value = '';
          loadQA();
        } else {
          toast('L·ªói: ' + (result.message || 'Unknown error'), 'err');
        }
      })
      .catch(function(error) {
        toast('L·ªói: ' + error.message, 'err');
      });
  }
  
  function loadQA() {
    var args = {};
    if (currentQAFilter !== 'all') {
      if (currentQAFilter === 'pending') {
        args.status = 'Pending';
      } else if (currentQAFilter === 'answered') {
        args.status = 'Answered';
      } else {
        args.category = currentQAFilter;
      }
    }
    
    var list = $('#qaList');
    if (list) {
      list.innerHTML = '';
      // Create skeleton cards
      for (var i = 0; i < 3; i++) {
        var skeletonCard = document.createElement('div');
        skeletonCard.className = 'skeleton skeleton-card';
        skeletonCard.style.marginBottom = '12px';
        skeletonCard.innerHTML = '<div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text"></div>';
        list.appendChild(skeletonCard);
      }
    }
    
    console.log('[QA] Loading questions with filters:', args);
    var perfLabel = PerformanceMonitor.start('api-getQuestions');
    
    callApi('getQuestions', args)
      .then(function(result) {
        PerformanceMonitor.end('api-getQuestions');
        
        // Handle both array and object response
        var questions = [];
        if (Array.isArray(result)) {
          questions = result;
        } else if (result && Array.isArray(result.data)) {
          questions = result.data;
        } else if (result && result.status === 'ok' && Array.isArray(result.questions)) {
          questions = result.questions;
        } else if (result && result.status === 'error') {
          console.error('[QA] API error:', result.message);
          if (list) {
            list.innerHTML = '<div class="glass" style="padding:40px;text-align:center;margin:20px 0">' +
              '<p style="color:var(--error);font-size:16px;font-weight:600;margin-bottom:8px">‚ùå L·ªói t·∫£i c√¢u h·ªèi</p>' +
              '<p style="color:var(--muted);font-size:14px">' + esc(result.message || 'Unknown error') + '</p>' +
              '<button class="btn btn-primary" onclick="loadQA()" style="margin-top:16px">üîÑ Th·ª≠ l·∫°i</button>' +
              '</div>';
          }
          return;
        }
        
        console.log('[QA] Loaded ' + questions.length + ' questions from sheet');
        
        if (questions.length === 0) {
          console.log('[QA] No questions found. Filters:', args);
        } else {
          console.log('[QA] First question:', questions[0]);
        }
        
        renderQA(questions);
      })
      .catch(function(error) {
        PerformanceMonitor.end('api-getQuestions');
        console.error('[QA] Load QA error:', error);
        console.error('[QA] Error details:', JSON.stringify(error));
        
        if (list) {
          list.innerHTML = '<div class="glass" style="padding:40px;text-align:center;margin:20px 0">' +
            '<p style="color:var(--error);font-size:16px;font-weight:600;margin-bottom:8px">‚ùå L·ªói t·∫£i c√¢u h·ªèi</p>' +
            '<p style="color:var(--muted);font-size:14px;margin-bottom:8px">' + esc(error.message || error.toString() || 'Unknown error') + '</p>' +
            '<p style="color:var(--muted);font-size:12px;margin-top:12px">Vui l√≤ng ki·ªÉm tra:</p>' +
            '<ul style="color:var(--muted);font-size:12px;text-align:left;display:inline-block;margin-top:8px">' +
            '<li>Sheet Q&A c√≥ t·ªìn t·∫°i trong Google Sheets</li>' +
            '<li>Sheet c√≥ header row ƒë√∫ng ƒë·ªãnh d·∫°ng</li>' +
            '<li>Sheet c√≥ d·ªØ li·ªáu c√¢u h·ªèi</li>' +
            '<li>Quy·ªÅn truy c·∫≠p v√†o Google Sheets</li>' +
            '</ul>' +
            '<button class="btn btn-primary" onclick="loadQA()" style="margin-top:16px">üîÑ Th·ª≠ l·∫°i</button>' +
            '<button class="btn btn-soft" onclick="console.log(\'QA Debug Info:\', arguments)" style="margin-top:8px;margin-left:8px">üîç Debug</button>' +
            '</div>';
        }
      });
  }
  
  function renderQA(questions) {
    var list = $('#qaList');
    if (!list) {
      console.error('[QA] QA list element not found');
      return;
    }
    
    console.log('[QA] Rendering ' + questions.length + ' questions');
    
    if (!Array.isArray(questions)) {
      console.error('[QA] Questions is not an array:', questions);
      list.innerHTML = '<div class="glass" style="padding:40px;text-align:center;margin:20px 0">' +
        '<p style="color:var(--error);font-size:16px;font-weight:600">‚ùå D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá</p>' +
        '<p style="color:var(--muted);font-size:14px">Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá admin</p>' +
        '</div>';
      return;
    }
    
    if (questions.length === 0) {
      console.log('[QA] No questions to render, showing empty state');
      var emptyState = createEmptyState({
        icon: '‚ùì',
        title: 'Ch∆∞a c√≥ c√¢u h·ªèi n√†o',
        description: 'H√£y ƒë·∫∑t c√¢u h·ªèi ƒë·∫ßu ti√™n c·ªßa b·∫°n ·ªü form ph√≠a tr√™n.',
        actionLabel: 'üí¨ ƒê·∫∑t c√¢u h·ªèi',
        onAction: function() {
          var questionInput = document.getElementById('qaQuestion');
          if (questionInput) {
            questionInput.focus();
            questionInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      });
      list.innerHTML = '';
      list.appendChild(emptyState);
      return;
    }
    
    list.innerHTML = '';
    var renderedCount = 0;
    questions.forEach(function(q, index) {
      try {
        // Validate question data
        if (!q || !q.Question) {
          console.warn('[QA] Invalid question at index ' + index + ':', q);
          return;
        }
        
        renderedCount++;
        console.log('[QA] Rendering question ' + renderedCount + ':', q.ID, q.Question.substring(0, 50) + '...');
        
        var card = document.createElement('div');
        card.className = 'glass';
        card.style.cssText = 'padding:16px;margin-bottom:12px;border-radius:12px;transition:transform 0.2s,box-shadow 0.2s';
        card.onmouseenter = function() {
          this.style.transform = 'translateY(-2px)';
          this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        };
        card.onmouseleave = function() {
          this.style.transform = 'translateY(0)';
          this.style.boxShadow = 'none';
        };
        
        var statusColor = q.Status === 'Answered' || q.Status === 'answered' ? '#10b981' : '#f59e0b';
        var statusBg = q.Status === 'Answered' || q.Status === 'answered' ? 'rgba(16,185,129,0.1)' : 'rgba(245,158,11,0.1)';
        var statusText = q.Status === 'Answered' || q.Status === 'answered' ? '‚úÖ ƒê√£ tr·∫£ l·ªùi' : '‚è≥ Ch·ªù tr·∫£ l·ªùi';
        
        var categoryIcon = {
          'Thao t√°c': 'üîß',
          'Giao di·ªán': 'üé®',
          'N·ªôi dung': 'üìù',
          'Kh√°c': '‚ùì'
        }[q.Category] || '‚ùì';
        
        var html = '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">';
        html += '<div style="display:flex;gap:8px;flex-wrap:wrap">';
        html += '<span class="chip" style="background:rgba(59,130,246,0.1);color:#3b82f6;font-size:12px">' + categoryIcon + ' ' + esc(q.Category) + '</span>';
        html += '<span class="chip" style="background:' + statusBg + ';color:' + statusColor + ';font-size:12px">' + statusText + '</span>';
        html += '</div>';
        html += '<small style="color:var(--muted);font-size:12px">' + (q.CreatedAt || '') + '</small></div>';
        html += '<p style="margin:0 0 12px;font-weight:600;font-size:15px;line-height:1.5">‚ùì ' + esc(q.Question) + '</p>';
        
        if (q.Answer && q.Answer.trim() !== '') {
          html += '<div style="margin-top:12px;padding:14px;background:rgba(16,185,129,0.08);border-left:4px solid #10b981;border-radius:8px">';
          html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px">';
          html += '<small style="color:#10b981;font-weight:600;font-size:12px">‚úÖ Tr·∫£ l·ªùi b·ªüi ' + esc(q.AnsweredBy || 'Admin') + '</small>';
          html += '<small style="color:var(--muted);font-size:11px">‚Ä¢ ' + (q.AnsweredAt || '') + '</small>';
          html += '</div>';
          html += '<p style="margin:0;color:var(--ink);line-height:1.6;white-space:pre-wrap">' + esc(q.Answer) + '</p>';
          html += '</div>';
        } else if (currentUser && currentUser.role === 'admin') {
          html += '<div style="margin-top:12px;padding:12px;background:rgba(245,158,11,0.05);border-left:4px solid #f59e0b;border-radius:8px">';
          html += '<textarea id="answer_' + q.ID + '" rows="3" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..." class="control" style="width:100%;margin-bottom:8px;resize:vertical"></textarea>';
          html += '<button class="btn btn-primary" onclick="answerQA(\'' + q.ID + '\')" style="padding:8px 16px;font-size:13px">üí¨ Tr·∫£ l·ªùi</button>';
          html += '</div>';
        } else {
          html += '<div style="margin-top:12px;padding:12px;background:rgba(0,0,0,0.02);border-radius:8px;text-align:center">';
          html += '<small style="color:var(--muted)">‚è≥ ƒêang ch·ªù admin tr·∫£ l·ªùi...</small>';
          html += '</div>';
        }
        
        card.innerHTML = html;
        list.appendChild(card);
      } catch (renderError) {
        console.error('[QA] Error rendering question at index ' + index + ':', renderError);
        console.error('[QA] Question data:', q);
      }
    });
    
    console.log('[QA] Rendered ' + renderedCount + ' questions successfully');
  }
  
  window.answerQA = function(id) {
    var answerInput = document.getElementById('answer_' + id);
    var answer = answerInput ? answerInput.value : '';
    
    if (!answer.trim()) {
      toast('Vui l√≤ng nh·∫≠p c√¢u tr·∫£ l·ªùi', 'err');
      return;
    }
    
    callApi('answerQuestion', { id: id, answer: answer.trim() })
      .then(function(result) {
        if (result && result.status === 'ok') {
          toast('ƒê√£ tr·∫£ l·ªùi c√¢u h·ªèi!', 'ok');
          loadQA();
        } else {
          toast('L·ªói: ' + (result.message || 'Unknown error'), 'err');
        }
      })
      .catch(function(error) {
        toast('L·ªói: ' + error.message, 'err');
      });
  };
  
  /* ====== UNFINISHED TASKS MODULE ====== */
  
  function setupUnfinished() {
    var refreshBtn = document.getElementById('unfinishedRefresh');
    var exportBtn = document.getElementById('unfinishedExport');
    var showBtn = document.getElementById('showUnfinishedBtn');
    var tile = document.getElementById('unfinishedTile');
    var dateInput = document.getElementById('unfinishedDate');
    
    // Set default date to today (D0)
    if (dateInput) {
      var today = new Date();
      dateInput.value = today.toISOString().slice(0, 10);
      updateUnfinishedDateDisplay();
      
      // Load when date changes
      dateInput.addEventListener('change', function() {
        updateUnfinishedDateDisplay();
        loadUnfinished();
      });
    }
    
    if (refreshBtn) refreshBtn.addEventListener('click', loadUnfinished);
    if (exportBtn) exportBtn.addEventListener('click', exportUnfinished);
    if (showBtn) showBtn.addEventListener('click', showUnfinishedTab);
    if (tile) tile.addEventListener('click', showUnfinishedTab);
  }
  
  function updateUnfinishedDateDisplay() {
    var dateInput = document.getElementById('unfinishedDate');
    var displayEl = document.getElementById('unfinishedDateDisplay');
    if (!dateInput || !displayEl) return;
    
    var selectedDate = dateInput.value;
    var today = new Date().toISOString().slice(0, 10);
    
    if (selectedDate === today) {
      displayEl.textContent = 'ƒêang hi·ªÉn th·ªã tasks ch∆∞a ho√†n th√†nh c·ªßa ng√†y h√¥m nay (D0)';
    } else {
      var dateObj = new Date(selectedDate + 'T00:00:00');
      var dateStr = dateObj.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
      displayEl.textContent = 'ƒêang hi·ªÉn th·ªã tasks ch∆∞a ho√†n th√†nh c·ªßa ng√†y ' + dateStr;
    }
  }
  
  function showUnfinishedTab() {
    // Switch to unfinished tab
    var tabs = document.querySelectorAll('.tab');
    var contents = document.querySelectorAll('.content');
    
    tabs.forEach(function(t) { t.classList.remove('active'); });
    contents.forEach(function(c) { c.classList.remove('active'); });
    
    var unfinishedTab = document.querySelector('[data-tab="unfinished"]');
    var unfinishedContent = document.querySelector('[data-content="unfinished"]');
    
    if (unfinishedTab) unfinishedTab.classList.add('active');
    if (unfinishedContent) unfinishedContent.classList.add('active');
    
    loadUnfinished();
  }
  
  function loadUnfinished() {
    var hub = currentHub;
    var dateInput = document.getElementById('unfinishedDate');
    var selectedDate = dateInput ? dateInput.value : new Date().toISOString().slice(0, 10);
    
    // If no date selected, default to today (D0)
    if (!selectedDate) {
      selectedDate = new Date().toISOString().slice(0, 10);
      if (dateInput) dateInput.value = selectedDate;
    }
    
    callApi('loadUnfinishedTasks', { hub: hub, date: selectedDate })
      .then(function(tasks) {
        renderUnfinished(tasks || []);
      })
      .catch(function(error) {
        console.error('Load unfinished error:', error);
        toast('L·ªói khi t·∫£i tasks ch∆∞a ho√†n th√†nh', 'err');
      });
  }
  
  function renderUnfinished(tasks) {
    var list = document.getElementById('unfinishedList');
    if (!list) return;
    
    currentUnfinishedTasks = tasks; // Store for note function
    
    if (tasks.length === 0) {
      list.innerHTML = '<p class="hint">üéâ Kh√¥ng c√≥ tasks ch∆∞a ho√†n th√†nh!</p>';
      return;
    }
    
    list.innerHTML = '';
    tasks.forEach(function(task, idx) {
      var card = document.createElement('div');
      card.className = 'section glass';
      card.style.marginBottom = '12px';
      
      var html = '<div style="display:flex;justify-content:space-between;align-items:start;gap:12px">';
      html += '<div style="flex:1">';
      html += '<div><span class="chip">' + esc(task.hub || task.Hub || '') + '</span> <span class="chip">' + esc(task.date || task.Date || '') + '</span> <span class="chip">' + esc(task.category || task.Category || '') + '</span></div>';
      html += '<p style="margin:8px 0;font-weight:600">' + esc(task.text || task.Text || '') + '</p>';
      if (task.sla || task.SLA) {
        html += '<small style="color:var(--orange)">‚è∞ SLA: ' + esc(task.sla || task.SLA) + '</small>';
      }
      html += '</div>';
      html += '<div style="display:flex;gap:8px;align-items:start">';
      html += '<button class="btn btn-soft btn-sm" onclick="showUnfinishedNote(' + idx + ')">üìù Note</button>';
      html += '</div>';
      html += '</div>';
      
      card.innerHTML = html;
      list.appendChild(card);
    });
  }
  
  var currentUnfinishedTasks = []; // Store tasks for note function
  
  function showUnfinishedNote(taskIdx) {
    if (!currentUnfinishedTasks[taskIdx]) {
      toast('Kh√¥ng t√¨m th·∫•y task', 'err');
      return;
    }
    
    var task = currentUnfinishedTasks[taskIdx];
    var noteInput = prompt('Nh·∫≠p ghi ch√∫ s·ª± v·ª• cho task: "' + (task.text || task.Text) + '"', '');
    
    if (!noteInput || !noteInput.trim()) return;
    
    callApi('saveTaskNote', {
      hub: task.hub || task.Hub || currentHub,
      date: task.date || task.Date || todayStr(),
      taskText: task.text || task.Text || '',
      note: noteInput.trim()
    }).then(function(result) {
      if (result && result.status === 'ok') {
        toast('‚úÖ Ghi ch√∫ ƒë√£ l∆∞u!', 'ok');
      } else {
        toast('L·ªói: ' + (result ? result.message : 'Failed'), 'err');
      }
    }).catch(function(error) {
      toast('L·ªói: ' + (error.message || error), 'err');
    });
  }
  
  function exportUnfinished() {
    toast('Xu·∫•t file Excel...', 'ok');
    // Implement export logic
  }
  
  /* ====== CHAT MODULE ====== */
  
  var chatMessages = [];
  var chatPollInterval = null;
  
  /* ====== FLOATING CHAT BUTTON & WIDGET ====== */
  
  function setupFloatingChat() {
    var chatButton = document.getElementById('floatingChatButton');
    var chatWidget = document.getElementById('chatWidget');
    var chatClose = document.getElementById('chatWidgetClose');
    var chatSend = document.getElementById('chatWidgetSend');
    var chatInput = document.getElementById('chatWidgetInput');
    
    if (!chatButton || !chatWidget) return;
    
    // Toggle chat widget
    chatButton.addEventListener('click', function() {
      var isVisible = chatWidget.style.display === 'flex';
      chatWidget.style.display = isVisible ? 'none' : 'flex';
      chatButton.style.transform = isVisible ? 'scale(1)' : 'scale(0.9)';
      
      if (!isVisible) {
        // Load messages and users when opening
        loadChatWidgetMessages();
        loadChatWidgetOnlineUsers();
        
        // Start polling
        if (chatPollInterval) clearInterval(chatPollInterval);
        chatPollInterval = setInterval(function() {
          loadChatWidgetMessages();
          loadChatWidgetOnlineUsers();
        }, 3000);
      } else {
        // Stop polling when closed
        if (chatPollInterval) clearInterval(chatPollInterval);
      }
    });
    
    // Close button
    if (chatClose) {
      chatClose.addEventListener('click', function() {
        chatWidget.style.display = 'none';
        chatButton.style.transform = 'scale(1)';
        if (chatPollInterval) clearInterval(chatPollInterval);
      });
    }
    
    // Send message
    if (chatSend) {
      chatSend.addEventListener('click', function() {
        sendChatWidgetMessage();
      });
    }
    
    // Enter key to send
    if (chatInput) {
      chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendChatWidgetMessage();
        }
      });
    }
    
    // Hover effect for button
    chatButton.addEventListener('mouseenter', function() {
      this.style.transform = 'scale(1.1)';
    });
    chatButton.addEventListener('mouseleave', function() {
      if (chatWidget.style.display !== 'flex') {
        this.style.transform = 'scale(1)';
      }
    });
  }
  
  function loadChatWidgetMessages() {
    callApi('getChatMessages', { limit: 50 })
      .then(function(messages) {
        if (!Array.isArray(messages)) messages = [];
        renderChatWidgetMessages(messages);
      })
      .catch(function(error) {
        console.error('[Chat Widget] Load messages error:', error);
      });
  }
  
  function renderChatWidgetMessages(messages) {
    var container = document.getElementById('chatWidgetMessages');
    if (!container) return;
    
    if (!messages || messages.length === 0) {
      container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">Ch∆∞a c√≥ tin nh·∫Øn. H√£y b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán!</div>';
      return;
    }
    
    container.innerHTML = '';
    messages.forEach(function(msg) {
      var isOwn = msg.email === currentUser.email;
      var bubble = document.createElement('div');
      bubble.style.cssText = 'margin-bottom:12px;display:flex;' + (isOwn ? 'justify-content:flex-end' : 'justify-content:flex-start');
      
      var content = document.createElement('div');
      content.style.cssText = 'max-width:75%;padding:10px 14px;border-radius:16px;' + 
        (isOwn ? 'background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff' : 
                 'background:var(--glass);color:var(--ink);border:1px solid var(--stroke)');
      
      var name = document.createElement('div');
      name.style.cssText = 'font-size:11px;font-weight:600;margin-bottom:4px;opacity:0.8';
      name.textContent = isOwn ? 'B·∫°n' : (msg.displayName || msg.email.split('@')[0] || 'Unknown');
      content.appendChild(name);
      
      var text = document.createElement('div');
      text.style.cssText = 'font-size:14px;line-height:1.5;word-wrap:break-word';
      text.textContent = msg.message || '';
      content.appendChild(text);
      
      var time = document.createElement('div');
      time.style.cssText = 'font-size:10px;margin-top:4px;opacity:0.7';
      time.textContent = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) : '';
      content.appendChild(time);
      
      bubble.appendChild(content);
      container.appendChild(bubble);
    });
    
    // Auto-scroll to bottom
    container.scrollTop = container.scrollHeight;
  }
  
  function sendChatWidgetMessage() {
    var input = document.getElementById('chatWidgetInput');
    var message = input ? input.value.trim() : '';
    
    if (!message) return;
    
    callApi('sendChatMessage', { message: message })
      .then(function(result) {
        if (result && result.status === 'ok') {
          input.value = '';
          loadChatWidgetMessages();
        } else {
          toast('L·ªói g·ª≠i tin nh·∫Øn', 'err');
        }
      })
      .catch(function(error) {
        toast('L·ªói: ' + error.message, 'err');
      });
  }
  
  function loadChatWidgetOnlineUsers() {
    callApi('getOnlineUsers', {})
      .then(function(users) {
        if (!Array.isArray(users)) users = [];
        renderChatWidgetOnlineUsers(users);
      })
      .catch(function(error) {
        console.error('[Chat Widget] Load online users error:', error);
        renderChatWidgetOnlineUsers([]);
      });
  }
  
  function renderChatWidgetOnlineUsers(users) {
    var countEl = document.getElementById('chatWidgetOnlineCount');
    var container = document.getElementById('chatWidgetOnlineUsers');
    
    if (countEl) {
      countEl.textContent = users.length || 0;
    }
    
    if (!container) return;
    
    if (!users || users.length === 0) {
      container.innerHTML = '<span style="color:var(--muted);font-size:11px">Kh√¥ng c√≥ ai online</span>';
      return;
    }
    
    container.innerHTML = '';
    users.forEach(function(user) {
      var chip = document.createElement('span');
      chip.className = 'chip';
      chip.style.cssText = 'background:rgba(16,185,129,0.1);color:#10b981;font-size:11px;padding:4px 8px;border-radius:6px';
      var displayText = user.displayName || (user.email ? user.email.split('@')[0] : 'Unknown');
      chip.textContent = displayText;
      container.appendChild(chip);
    });
    
    // Update badge count
    var badge = document.getElementById('chatBadge');
    if (badge && users.length > 0) {
      badge.textContent = users.length > 9 ? '9+' : users.length;
      badge.style.display = 'flex';
    } else if (badge) {
      badge.style.display = 'none';
    }
  }
  
  function loadOnlineUsers() {
    callApi('getOnlineUsers', {})
      .then(function(users) {
        // getOnlineUsers returns an array
        if (!Array.isArray(users)) {
          users = [];
        }
        renderOnlineUsers(users);
      })
      .catch(function(error) {
        console.error('[Chat] Load online users error:', error);
        renderOnlineUsers([]);
      });
  }
  
  function renderOnlineUsers(users) {
    var container = document.getElementById('chatOnlineUsers');
    var countEl = document.getElementById('chatOnlineCount');
    
    if (countEl) {
      countEl.textContent = users.length || 0;
    }
    
    if (!container) return;
    
    if (!users || users.length === 0) {
      container.innerHTML = '<span style="color:var(--muted);font-size:13px">Kh√¥ng c√≥ ai online</span>';
      return;
    }
    
    container.innerHTML = '';
    users.forEach(function(user) {
      var chip = document.createElement('span');
      chip.className = 'chip';
      chip.style.cssText = 'background:rgba(16,185,129,0.1);color:#10b981;font-size:12px;padding:6px 12px';
      // getOnlineUsers returns userId, not email/displayName directly
      var displayText = user.userId || user.email || user.displayName || 'Unknown';
      // Try to get display name from user permissions if available
      if (displayText && displayText.indexOf('@') !== -1) {
        displayText = displayText.split('@')[0];
      }
      chip.textContent = displayText;
      container.appendChild(chip);
    });
  }
  
  function sendChatMessage() {
    var input = $('#chatInput');
    var message = input ? input.value.trim() : '';
    
    if (!message) return;
    
    callApi('sendChatMessage', { message: message })
      .then(function(result) {
        if (result && result.status === 'ok') {
          input.value = '';
          loadChatMessages();
        } else {
          toast('L·ªói g·ª≠i tin nh·∫Øn', 'err');
        }
      })
      .catch(function(error) {
        toast('L·ªói: ' + error.message, 'err');
      });
  }
  
  function loadChatMessages() {
    callApi('getChatMessages', {})
      .then(function(messages) {
        // getChatMessages returns an array
        if (!Array.isArray(messages)) {
          messages = [];
        }
        console.log('[Chat] Received messages:', messages.length);
        renderChatMessages(messages);
      })
      .catch(function(error) {
        console.error('[Chat] Load error:', error);
        renderChatMessages([]);
      });
  }
  
  function renderChatMessages(messages) {
    var container = document.getElementById('chatMessages');
    
    if (!container) {
      console.error('[Chat] Container not found!');
      return;
    }
    
    if (!messages || messages.length === 0) {
      var emptyState = createEmptyState({
        icon: 'üí¨',
        title: 'Ch∆∞a c√≥ tin nh·∫Øn',
        description: 'H√£y b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán v·ªõi team c·ªßa b·∫°n!',
        actionLabel: '‚úçÔ∏è G·ª≠i tin nh·∫Øn',
        onAction: function() {
          var chatInput = document.getElementById('chatInput');
          if (chatInput) {
            chatInput.focus();
            chatInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      });
      container.innerHTML = '';
      container.appendChild(emptyState);
      return;
    }
    
    container.innerHTML = '';
    var isCurrentUser = currentUser && currentUser.email;
      
    messages.forEach(function(msg, idx) {
      var isMe = currentUser && msg.Email && msg.Email.toLowerCase() === currentUser.email.toLowerCase();
      var msgDiv = document.createElement('div');
      msgDiv.style.cssText = 'margin-bottom:16px;display:flex;flex-direction:column;align-items:' + (isMe ? 'flex-end' : 'flex-start');
      
      var timeStr = msg.CreatedAt || '';
      var displayName = msg.DisplayName || (msg.Email ? msg.Email.split('@')[0] : 'Unknown');
      
      var bubble = document.createElement('div');
      bubble.style.cssText = 'max-width:70%;padding:12px 16px;border-radius:12px;word-wrap:break-word;position:relative';
      bubble.style.background = isMe ? 'linear-gradient(135deg, #3b82f6, #2563eb)' : 'var(--glass)';
      bubble.style.color = isMe ? '#fff' : 'var(--ink)';
      bubble.style.border = isMe ? 'none' : '1px solid var(--stroke)';
      
      bubble.innerHTML = `
        <div style="font-weight:600;font-size:13px;margin-bottom:6px;opacity:0.9">${esc(displayName)}</div>
        <div style="line-height:1.5;white-space:pre-wrap">${esc(msg.Message || '')}</div>
        <div style="font-size:11px;opacity:0.7;margin-top:6px;text-align:right">${timeStr}</div>
      `;
      
      msgDiv.appendChild(bubble);
      container.appendChild(msgDiv);
    });
    
    // Auto-scroll to bottom
    container.scrollTop = container.scrollHeight;
  }
  
  /* ====== LOAD BRANDING CONFIG ====== */
  
  function loadBrandingConfig() {
    // Default config (fallback n·∫øu kh√¥ng c√≥ file app-config.js)
    var config = {
      appTitle: '[SPX] DAILY CHECKLIST',
      appVersion: 'v2.5',
      logoUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üìã</text></svg>',
      faviconUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üìã</text></svg>'
    };
    
    // Ki·ªÉm tra xem c√≥ APP_CONFIG global kh√¥ng (t·ª´ file app-config.js)
    if (typeof APP_CONFIG !== 'undefined') {
      config = APP_CONFIG;
    }
    
    // Load logo via Apps Script proxy endpoint (avoids CORS issues)
    // This fetches logo from external URL and serves it through Apps Script
    function loadLogoFromProxy() {
      try {
        // Check if google.script.url.getLocation is available
        if (typeof google === 'undefined' || !google.script || !google.script.url || !google.script.url.getLocation) {
          if (window.logger) logger.log('[Branding] google.script.url.getLocation not available, using direct URL');
          applyDirectLogo();
          return;
        }
        
        google.script.url.getLocation(function(location) {
          if (location && location.scriptUrl) {
            var scriptUrl = location.scriptUrl;
            var logoEndpoint = scriptUrl + '?action=logo';
            
            // Fetch logo as JSON (base64 data URL) from Apps Script proxy
            fetch(logoEndpoint)
              .then(function(response) {
                if (!response.ok) {
                  throw new Error('HTTP ' + response.status);
                }
                return response.json();
              })
              .then(function(data) {
                if (data.status === 'ok' && data.dataUrl) {
                  // Update logo URLs with base64 data URL
                  var topbarLogo = document.getElementById('topbarLogo');
                  var coverLogo = document.getElementById('coverLogo');
                  
                  if (topbarLogo) {
                    topbarLogo.src = data.dataUrl;
                    topbarLogo.onload = function() {
                      if (window.logger) logger.log('[Branding] Topbar logo loaded successfully via proxy');
                    };
                    topbarLogo.onerror = function() {
                      if (window.logger) logger.error('[Branding] Failed to decode topbar logo');
                    };
                  }
                  
                  if (coverLogo) {
                    coverLogo.src = data.dataUrl;
                    coverLogo.onload = function() {
                      if (window.logger) logger.log('[Branding] Cover logo loaded successfully via proxy');
                    };
                    coverLogo.onerror = function() {
                      if (window.logger) logger.error('[Branding] Failed to decode cover logo');
                    };
                  }
                  
                  if (window.logger) logger.log('[Branding] Logo loaded successfully from external URL via Apps Script proxy');
                } else {
                  if (window.logger) logger.warn('[Branding] Logo endpoint returned error:', data.message);
                  // Fallback to direct URL
                  applyDirectLogo();
                }
              })
              .catch(function(error) {
                console.error('[Branding] Failed to fetch logo from proxy:', error);
                // Fallback to direct URL
                applyDirectLogo();
              });
          } else {
            if (window.logger) logger.warn('[Branding] Could not get script URL, using direct URL');
            applyDirectLogo();
          }
        });
      } catch (e) {
        if (window.logger) logger.warn('[Branding] Error getting script URL:', e);
        applyDirectLogo();
      }
    }
    
    // Fallback: try to load logo directly from URL
    function applyDirectLogo() {
      var topbarLogo = document.getElementById('topbarLogo');
      var coverLogo = document.getElementById('coverLogo');
      
      if (config.logoUrl) {
        if (topbarLogo) {
          topbarLogo.src = config.logoUrl;
          topbarLogo.onload = function() {
            if (window.logger) logger.log('[Branding] Topbar logo loaded directly from:', config.logoUrl);
          };
          topbarLogo.onerror = function() {
            if (window.logger) logger.error('[Branding] Failed to load topbar logo directly (CORS may be blocking)');
          };
        }
        
        if (coverLogo) {
          coverLogo.src = config.logoUrl;
          coverLogo.onload = function() {
            if (window.logger) logger.log('[Branding] Cover logo loaded directly from:', config.logoUrl);
          };
          coverLogo.onerror = function() {
            if (window.logger) logger.error('[Branding] Failed to load cover logo directly (CORS may be blocking)');
          };
        }
      }
    }
    
    // Apply configured logo immediately, then try proxy for cached version
    applyDirectLogo();
    loadLogoFromProxy();
    
    // Apply favicon
    var favicon = document.getElementById('appFavicon');
    if (favicon && config.faviconUrl) {
      favicon.href = config.faviconUrl;
    }
    
    // Apply title
    var title = document.getElementById('appTitle');
    if (title && config.appTitle) {
      title.textContent = config.appTitle;
    }
    
    // Apply topbar title
    var topbarTitle = document.getElementById('topbarTitle');
    if (topbarTitle && config.appTitle) {
      topbarTitle.textContent = config.appTitle;
    }
    
    // Note: Logo URLs are applied in the async callback above to use Apps Script endpoint
    
    // Apply cover title
    var coverTitle = document.getElementById('coverTitle');
    if (coverTitle && config.appTitle && config.appVersion) {
      coverTitle.textContent = config.appTitle + ' ' + config.appVersion;
    }
    
    if (window.logger) {
      logger.log('[Branding] Config loaded:', config.appTitle);
      logger.log('[Branding] Logo URL:', config.logoUrl);
      logger.log('[Branding] Favicon URL:', config.faviconUrl);
    }
  }
  
  /* ====== START APPLICATION ====== */
  
  document.addEventListener('DOMContentLoaded', function() {
    loadBrandingConfig();
    checkAuth();
  });
  
})();
</script>

      // Debounced search
      var debouncedSearch = debounce(function(query) {
        this.performSearch(query);
      }.bind(this), 300);
      
      // Search on input
      searchInput.addEventListener('input', function(e) {
        ensureDataLoaded();
        var query = e.target.value.trim();
        if (query.length >= 2) {
          debouncedSearch(query);
        } else {
          searchResults.style.display = 'none';
        }
      });
      
      searchInput.addEventListener('focus', ensureDataLoaded);
      
      // Keyboard shortcuts
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          searchResults.style.display = 'none';
          searchInput.blur();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          var query = searchInput.value.trim();
          if (query) {
            this.performSearch(query, true);
          }
        }
      }.bind(this));
      
      // Click outside to close
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#globalSearchContainer')) {
          searchResults.style.display = 'none';
        }
      });
      
      // Focus search with Ctrl+K or Cmd+K
      document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          ensureDataLoaded();
          searchInput.focus();
        }
      });
    },
    
    // Perform search
    performSearch: function(query, showFullResults) {
      if (!query || query.length < 2) return;
      
      var results = {
        tasks: [],
        users: [],
        questions: [],
        notes: [],
        accessLog: []
      };
      
      // Search in tasks
      if (this.searchData.tasks.length > 0) {
        results.tasks = this.searchData.tasks.filter(function(task) {
          return this.matchTask(task, query);
        }.bind(this));
      }
      
      // Search in users
      if (this.searchData.users.length > 0) {
        results.users = this.searchData.users.filter(function(user) {
          return this.matchUser(user, query);
        }.bind(this));
      }
      
      // Search in questions
      if (this.searchData.questions.length > 0) {
        results.questions = this.searchData.questions.filter(function(q) {
          return this.matchQuestion(q, query);
        }.bind(this));
      }
      
      // Search in notes
      if (this.searchData.notes.length > 0) {
        results.notes = this.searchData.notes.filter(function(note) {
          return this.matchNote(note, query);
        }.bind(this));
      }
      
      // Search in access log
      if (this.searchData.accessLog.length > 0) {
        results.accessLog = this.searchData.accessLog.filter(function(log) {
          return this.matchLog(log, query);
        }.bind(this));
      }
      
      // Display results
      this.displayResults(results, query);
      
      // Save to history
      if (query.length >= 3) {
        this.addToHistory(query);
      }
    },
    
    // Match task
    matchTask: function(task, query) {
      var q = query.toLowerCase();
      return (
        (task.text && task.text.toLowerCase().indexOf(q) !== -1) ||
        (task.category && task.category.toLowerCase().indexOf(q) !== -1) ||
        (task.info && task.info.toLowerCase().indexOf(q) !== -1)
      );
    },
    
    // Match user
    matchUser: function(user, query) {
      var q = query.toLowerCase();
      return (
        (user.email && user.email.toLowerCase().indexOf(q) !== -1) ||
        (user.displayName && user.displayName.toLowerCase().indexOf(q) !== -1) ||
        (user.hub && user.hub.toLowerCase().indexOf(q) !== -1)
      );
    },
    
    // Match question
    matchQuestion: function(question, query) {
      var q = query.toLowerCase();
      return (
        (question.question && question.question.toLowerCase().indexOf(q) !== -1) ||
        (question.answer && question.answer.toLowerCase().indexOf(q) !== -1) ||
        (question.category && question.category.toLowerCase().indexOf(q) !== -1)
      );
    },
    
    // Match note
    matchNote: function(note, query) {
      var q = query.toLowerCase();
      return (
        (note.content && note.content.toLowerCase().indexOf(q) !== -1) ||
        (note.hub && note.hub.toLowerCase().indexOf(q) !== -1)
      );
    },
    
    // Match log
    matchLog: function(log, query) {
      var q = query.toLowerCase();
      return (
        (log.email && log.email.toLowerCase().indexOf(q) !== -1) ||
        (log.action && log.action.toLowerCase().indexOf(q) !== -1) ||
        (log.hub && log.hub.toLowerCase().indexOf(q) !== -1)
      );
    },
    
    // Display results
    displayResults: function(results, query) {
      var searchResults = document.getElementById('globalSearchResults');
      if (!searchResults) return;
      
      var totalResults = results.tasks.length + results.users.length + 
                        results.questions.length + results.notes.length + 
                        results.accessLog.length;
      
      if (totalResults === 0) {
        searchResults.innerHTML = `
          <div style="padding:20px;text-align:center;color:var(--muted)">
            <div style="font-size:32px;margin-bottom:8px">üîç</div>
            <div>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ cho "<strong>${esc(query)}</strong>"</div>
          </div>
        `;
        searchResults.style.display = 'block';
        return;
      }
      
      var html = '<div style="max-height:400px;overflow-y:auto">';
      
      // Tasks results
      if (results.tasks.length > 0) {
        html += '<div style="margin-bottom:12px">';
        html += '<div style="font-weight:700;padding:8px;border-bottom:1px solid var(--stroke);margin-bottom:8px">üìã Tasks (' + results.tasks.length + ')</div>';
        results.tasks.slice(0, 5).forEach(function(task) {
          html += '<div class="search-result-item" data-type="task" data-id="' + esc(task.id) + '" style="padding:8px;cursor:pointer;border-radius:8px;margin-bottom:4px;transition:background 0.2s" onmouseover="this.style.background=\'var(--hover)\'" onmouseout="this.style.background=\'\'">';
          html += '<div style="font-weight:600">' + esc(task.text) + '</div>';
          html += '<div style="font-size:12px;color:var(--muted);margin-top:4px">' + esc(task.category || '') + '</div>';
          html += '</div>';
        });
        if (results.tasks.length > 5) {
          html += '<div style="padding:8px;text-align:center;color:var(--muted);font-size:12px">+ ' + (results.tasks.length - 5) + ' k·∫øt qu·∫£ kh√°c</div>';
        }
        html += '</div>';
      }
      
      // Users results
      if (results.users.length > 0) {
        html += '<div style="margin-bottom:12px">';
        html += '<div style="font-weight:700;padding:8px;border-bottom:1px solid var(--stroke);margin-bottom:8px">üë• Users (' + results.users.length + ')</div>';
        results.users.slice(0, 5).forEach(function(user) {
          html += '<div class="search-result-item" data-type="user" data-email="' + esc(user.email) + '" style="padding:8px;cursor:pointer;border-radius:8px;margin-bottom:4px;transition:background 0.2s" onmouseover="this.style.background=\'var(--hover)\'" onmouseout="this.style.background=\'\'">';
          html += '<div style="font-weight:600">' + esc(user.displayName || user.email) + '</div>';
          html += '<div style="font-size:12px;color:var(--muted);margin-top:4px">' + esc(user.email) + ' ‚Ä¢ ' + esc(user.hub || '') + '</div>';
          html += '</div>';
        });
        if (results.users.length > 5) {
          html += '<div style="padding:8px;text-align:center;color:var(--muted);font-size:12px">+ ' + (results.users.length - 5) + ' k·∫øt qu·∫£ kh√°c</div>';
        }
        html += '</div>';
      }
      
      // Questions results
      if (results.questions.length > 0) {
        html += '<div style="margin-bottom:12px">';
        html += '<div style="font-weight:700;padding:8px;border-bottom:1px solid var(--stroke);margin-bottom:8px">‚ùì Questions (' + results.questions.length + ')</div>';
        results.questions.slice(0, 3).forEach(function(question) {
          html += '<div class="search-result-item" data-type="question" data-id="' + esc(question.id) + '" style="padding:8px;cursor:pointer;border-radius:8px;margin-bottom:4px;transition:background 0.2s" onmouseover="this.style.background=\'var(--hover)\'" onmouseout="this.style.background=\'\'">';
          html += '<div style="font-weight:600">' + esc(question.question) + '</div>';
          html += '<div style="font-size:12px;color:var(--muted);margin-top:4px">' + esc(question.category || '') + '</div>';
          html += '</div>';
        });
        html += '</div>';
      }
      
      html += '</div>';
      
      searchResults.innerHTML = html;
      searchResults.style.display = 'block';
      
      // Setup click handlers
      searchResults.querySelectorAll('.search-result-item').forEach(function(item) {
        item.addEventListener('click', function() {
          var type = item.getAttribute('data-type');
          var id = item.getAttribute('data-id') || item.getAttribute('data-email');
          this.handleResultClick(type, id);
        }.bind(this));
      }.bind(this));
    },
    
    // Handle result click
    handleResultClick: function(type, id) {
      var searchResults = document.getElementById('globalSearchResults');
      var searchInput = document.getElementById('globalSearch');
      
      if (searchResults) searchResults.style.display = 'none';
      if (searchInput) searchInput.blur();
      
      switch(type) {
        case 'task':
          // Switch to checklist tab and highlight task
          this.switchToTab('check');
          // Scroll to task (will be implemented)
          break;
        case 'user':
          // Switch to admin tab and show user
          if (currentUser.role === 'admin') {
            this.switchToTab('admin');
            // Edit user (will be implemented)
            setTimeout(function() {
              if (typeof editUser === 'function') {
                editUser(id);
              }
            }, 500);
          }
          break;
        case 'question':
          // Switch to Q&A tab
          this.switchToTab('qa');
          break;
      }
    },
    
    // Switch to tab
    switchToTab: function(tabName) {
      // Hide cover if showing
      if (document.getElementById('cover').style.display !== 'none') {
        enterApp();
      }
      
      // Switch to tab
      var tab = document.querySelector('[data-tab="' + tabName + '"]');
      if (tab) {
        tab.click();
      }
    },
    
    // Add to history
    addToHistory: function(query) {
      // Remove if already exists
      this.searchHistory = this.searchHistory.filter(function(h) {
        return h !== query;
      });
      
      // Add to beginning
      this.searchHistory.unshift(query);
      
      // Limit history size
      if (this.searchHistory.length > this.maxHistory) {
        this.searchHistory = this.searchHistory.slice(0, this.maxHistory);
      }
      
      // Save to localStorage
      try {
        localStorage.setItem('spx_search_history', JSON.stringify(this.searchHistory));
      } catch (e) {
        console.warn('Search history save error:', e);
      }
    },
    
    // Load search data
    loadSearchData: function(options) {
      var forceRemote = options && options.forceRemote;
      this.searchData.tasks = tasksData[currentHub] || [];
      
      if (this.loadingPromise && !forceRemote) {
        return this.loadingPromise;
      }
      
      var fetches = [];
      var shouldFetchRemote = !this.remoteDataLoaded || forceRemote;
      
      if (shouldFetchRemote) {
        if (currentUser && currentUser.role === 'admin') {
          fetches.push(
            callApi('getAllUsers')
              .then(function(users) {
                if (users && !users.error) {
                  this.searchData.users = users;
                }
              }.bind(this))
              .catch(function(e) {
                console.warn('Failed to load users for search:', e);
              })
          );
        }
        
        fetches.push(
          callApi('getQuestions', {})
            .then(function(questions) {
              if (questions && !questions.error) {
                this.searchData.questions = questions;
              }
            }.bind(this))
            .catch(function(e) {
              console.warn('Failed to load questions for search:', e);
            })
        );
      }
      
      if (fetches.length === 0) {
        this.dataLoaded = true;
        return Promise.resolve();
      }
      
      var self = this;
      this.loadingPromise = Promise.all(fetches).then(function() {
        self.remoteDataLoaded = true;
        self.dataLoaded = true;
      }).catch(function(e) {
        console.warn('Failed to load search data:', e);
        self.remoteDataLoaded = false;
      }).finally(function() {
        self.loadingPromise = null;
      });
      
      return this.loadingPromise;
    },
    
    ensureDataLoaded: function() {
      if (!this.dataLoaded) {
        return this.loadSearchData();
      }
      this.searchData.tasks = tasksData[currentHub] || [];
      return Promise.resolve();
    },
    
    // Refresh search data
    refresh: function() {
      this.searchData.tasks = tasksData[currentHub] || [];
    }
  };
  
  /* ====== BULK OPERATIONS SYSTEM ====== */
  
  var BulkOperations = {
    // Selection mode
    selectionMode: false,
    selectedTasks: [],
    
    // Toggle selection mode
    toggleSelectionMode: function() {
      this.selectionMode = !this.selectionMode;
      this.selectedTasks = [];
      
      // Update UI
      var bulkSelectBtn = document.getElementById('bulkSelectBtn');
      var bulkEditBtn = document.getElementById('bulkEditBtn');
      var bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
      var bulkExportBtn = document.getElementById('bulkExportBtn');
      var bulkCancelBtn = document.getElementById('bulkCancelBtn');
      
      if (this.selectionMode) {
        if (bulkSelectBtn) bulkSelectBtn.style.display = 'none';
        if (bulkEditBtn) bulkEditBtn.style.display = 'inline-block';
        if (bulkDeleteBtn) bulkDeleteBtn.style.display = 'inline-block';
        if (bulkExportBtn) bulkExportBtn.style.display = 'inline-block';
        if (bulkCancelBtn) bulkCancelBtn.style.display = 'inline-block';
        
        // Re-render tasks with selection checkboxes
        renderTasks();
        toast('Ch·∫ø ƒë·ªô ch·ªçn nhi·ªÅu ƒë√£ b·∫≠t. Ch·ªçn tasks ƒë·ªÉ thao t√°c h√†ng lo·∫°t.', 'info');
      } else {
        if (bulkSelectBtn) bulkSelectBtn.style.display = 'inline-block';
        if (bulkEditBtn) bulkEditBtn.style.display = 'none';
        if (bulkDeleteBtn) bulkDeleteBtn.style.display = 'none';
        if (bulkExportBtn) bulkExportBtn.style.display = 'none';
        if (bulkCancelBtn) bulkCancelBtn.style.display = 'none';
        
        // Re-render tasks normally
        renderTasks();
      }
    },
    
    // Toggle task selection
    toggleTaskSelection: function(taskId) {
      var index = this.selectedTasks.indexOf(taskId);
      if (index === -1) {
        this.selectedTasks.push(taskId);
      } else {
        this.selectedTasks.splice(index, 1);
      }
      
      // Update UI
      this.updateBulkButtons();
    },
    
    // Select all tasks
    selectAll: function() {
      var tasks = tasksData[currentHub] || [];
      this.selectedTasks = tasks.map(function(t) { return t.id; });
      this.updateBulkButtons();
      
      // Update checkboxes
      document.querySelectorAll('.bulk-select-checkbox').forEach(function(checkbox) {
        checkbox.checked = true;
      });
    },
    
    // Deselect all tasks
    deselectAll: function() {
      this.selectedTasks = [];
      this.updateBulkButtons();
      
      // Update checkboxes
      document.querySelectorAll('.bulk-select-checkbox').forEach(function(checkbox) {
        checkbox.checked = false;
      });
    },
    
    // Update bulk buttons
    updateBulkButtons: function() {
      var count = this.selectedTasks.length;
      var bulkEditBtn = document.getElementById('bulkEditBtn');
      var bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
      var bulkExportBtn = document.getElementById('bulkExportBtn');
      
      if (bulkEditBtn) {
        bulkEditBtn.textContent = '‚úèÔ∏è S·ª≠a h√†ng lo·∫°t (' + count + ')';
        bulkEditBtn.disabled = count === 0;
      }
      
      if (bulkDeleteBtn) {
        bulkDeleteBtn.textContent = 'üóëÔ∏è X√≥a h√†ng lo·∫°t (' + count + ')';
        bulkDeleteBtn.disabled = count === 0;
      }
      
      if (bulkExportBtn) {
        bulkExportBtn.textContent = 'üìó Export (' + count + ')';
        bulkExportBtn.disabled = count === 0;
      }
    },
    
    // Bulk edit
    bulkEdit: function() {
      if (this.selectedTasks.length === 0) {
        toast('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt task', 'warn');
        return;
      }
      
      var tasks = tasksData[currentHub] || [];
      var selectedTasks = tasks.filter(function(t) {
        return this.selectedTasks.indexOf(t.id) !== -1;
      }.bind(this));
      
      this.showBulkEditDialog(selectedTasks);
    },
    
    // Show bulk edit dialog
    showBulkEditDialog: function(tasks) {
      var html = '<div style="padding:24px">';
      html += '<h3 style="margin:0 0 20px;font-size:20px;color:var(--fg)">‚úèÔ∏è S·ª≠a H√†ng Lo·∫°t (' + tasks.length + ' tasks)</h3>';
      html += '<form id="bulkEditForm" onsubmit="return false;">';
      
      // Category
      html += '<div class="group" style="margin-bottom:16px">';
      html += '<div class="label">Danh m·ª•c</div>';
      html += '<div class="control">';
      html += '<select id="bulkEditCategory" style="width:100%">';
      html += '<option value="">Gi·ªØ nguy√™n</option>';
      html += '<option value="ƒê·∫ßu Ca">ƒê·∫ßu Ca</option>';
      html += '<option value="Trong Ca">Trong Ca</option>';
      html += '<option value="Cu·ªëi Ca">Cu·ªëi Ca</option>';
      html += '<option value="H√†ng Tu·∫ßn">H√†ng Tu·∫ßn</option>';
      html += '</select>';
      html += '</div>';
      html += '</div>';
      
      // SLA
      html += '<div class="group" style="margin-bottom:16px">';
      html += '<div class="label">SLA Deadline</div>';
      html += '<div class="control">';
      html += '<input type="time" id="bulkEditSLA" style="width:100%"/>';
      html += '<small style="color:var(--muted);font-size:12px;display:block;margin-top:4px">ƒê·ªÉ tr·ªëng ƒë·ªÉ gi·ªØ nguy√™n, nh·∫≠p th·ªùi gian ƒë·ªÉ thay ƒë·ªïi</small>';
      html += '</div>';
      html += '</div>';
      
      // Is Lead
      html += '<div class="group" style="margin-bottom:16px">';
      html += '<div class="label">Ph√¢n c√¥ng LEAD</div>';
      html += '<div class="control">';
      html += '<select id="bulkEditIsLead" style="width:100%">';
      html += '<option value="">Gi·ªØ nguy√™n</option>';
      html += '<option value="true">C√≥ (LEAD)</option>';
      html += '<option value="false">Kh√¥ng</option>';
      html += '</select>';
      html += '</div>';
      html += '</div>';
      
      // Completed
      html += '<div class="group" style="margin-bottom:20px">';
      html += '<div class="label">Tr·∫°ng th√°i ho√†n th√†nh</div>';
      html += '<div class="control">';
      html += '<select id="bulkEditCompleted" style="width:100%">';
      html += '<option value="">Gi·ªØ nguy√™n</option>';
      html += '<option value="true">ƒê√£ ho√†n th√†nh</option>';
      html += '<option value="false">Ch∆∞a ho√†n th√†nh</option>';
      html += '</select>';
      html += '</div>';
      html += '</div>';
      
      // Buttons
      html += '<div style="display:flex;gap:8px;justify-content:flex-end">';
      html += '<button type="button" class="btn btn-soft" onclick="this.closest(\'.modal\').remove()">H·ªßy</button>';
      html += '<button type="submit" class="btn btn-primary">üíæ √Åp d·ª•ng</button>';
      html += '</div>';
      
      html += '</form>';
      html += '</div>';
      
      var modalBox = showModal(html);
      
      // Setup form submit
      var form = modalBox.querySelector('#bulkEditForm');
      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          this.applyBulkEdit(tasks, modalBox);
        }.bind(this));
      }
    },
    
    // Apply bulk edit
    applyBulkEdit: function(tasks, modalBox) {
      var categoryEl = modalBox.querySelector('#bulkEditCategory');
      var slaEl = modalBox.querySelector('#bulkEditSLA');
      var isLeadEl = modalBox.querySelector('#bulkEditIsLead');
      var completedEl = modalBox.querySelector('#bulkEditCompleted');
      
      // Safety check: ensure all elements exist
      if (!categoryEl || !slaEl || !isLeadEl || !completedEl) {
        toast('L·ªói: Kh√¥ng t√¨m th·∫•y c√°c tr∆∞·ªùng form c·∫ßn thi·∫øt', 'err');
        return;
      }
      
      var category = categoryEl.value;
      var sla = slaEl.value;
      var isLead = isLeadEl.value;
      var completed = completedEl.value;
      
      var allTasks = tasksData[currentHub] || [];
      var updated = 0;
      
      tasks.forEach(function(task) {
        var taskIndex = allTasks.findIndex(function(t) { return t.id === task.id; });
        if (taskIndex === -1) return;
        
        if (category) {
          allTasks[taskIndex].category = category;
        }
        
        if (sla) {
          allTasks[taskIndex].sla = sla;
        } else if (sla === '' && slaEl && slaEl.value === '') {
          // Clear SLA if empty
          allTasks[taskIndex].sla = null;
        }
        
        if (isLead !== '') {
          allTasks[taskIndex].isLead = isLead === 'true';
        }
        
        if (completed !== '') {
          allTasks[taskIndex].completed = completed === 'true';
          if (completed === 'true') {
            allTasks[taskIndex].doneAt = new Date().toISOString();
          } else {
            allTasks[taskIndex].doneAt = null;
          }
        }
        
        updated++;
      });
      
      tasksData[currentHub] = allTasks;
      
      // Save tasks
      var hub = currentHub;
      var dateEl = $('#date');
      var date = (dateEl && dateEl.value) ? dateEl.value : todayStr();
      var key = storageKey(hub, date);
      
      callApi('saveTasks', { storageKey: key, tasks: allTasks }).then(function(result) {
        if (result.status === 'ok') {
          toast('ƒê√£ c·∫≠p nh·∫≠t ' + updated + ' tasks', 'ok');
          
          // Close modal
          var modal = document.querySelector('.modal');
          if (modal) modal.remove();
          
          // Exit selection mode
          this.toggleSelectionMode();
          
          // Re-render tasks
          renderTasks();
        } else {
          toast('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ l∆∞u'), 'err');
        }
      }.bind(this)).catch(function(error) {
        toast('L·ªói: ' + error.message, 'err');
      });
    },
    
    // Bulk delete
    bulkDelete: function() {
      if (this.selectedTasks.length === 0) {
        toast('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt task', 'warn');
        return;
      }
      
      if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ' + this.selectedTasks.length + ' tasks ƒë√£ ch·ªçn?')) {
        return;
      }
      
      var allTasks = tasksData[currentHub] || [];
      var beforeCount = allTasks.length;
      
      // Remove selected tasks
      allTasks = allTasks.filter(function(t) {
        return this.selectedTasks.indexOf(t.id) === -1;
      }.bind(this));
      
      tasksData[currentHub] = allTasks;
      var deletedCount = beforeCount - allTasks.length;
      
      // Save tasks
      var hub = currentHub;
      var dateEl = $('#date');
      var date = (dateEl && dateEl.value) ? dateEl.value : todayStr();
      var key = storageKey(hub, date);
      
      callApi('saveTasks', { storageKey: key, tasks: allTasks }).then(function(result) {
        if (result.status === 'ok') {
          toast('ƒê√£ x√≥a ' + deletedCount + ' tasks', 'ok');
          
          // Exit selection mode
          this.toggleSelectionMode();
          
          // Re-render tasks
          renderTasks();
        } else {
          toast('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ l∆∞u'), 'err');
        }
      }.bind(this)).catch(function(error) {
        toast('L·ªói: ' + error.message, 'err');
      });
    },
    
    // Bulk export
    bulkExport: function() {
      if (this.selectedTasks.length === 0) {
        toast('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt task', 'warn');
        return;
      }
      
      var tasks = tasksData[currentHub] || [];
      var selectedTasks = tasks.filter(function(t) {
        return this.selectedTasks.indexOf(t.id) !== -1;
      }.bind(this));
      
      // Export to CSV
      var csv = 'Task Text,Category,SLA,Is Lead,Completed,Done At\n';
      selectedTasks.forEach(function(task) {
        csv += '"' + (task.text || '').replace(/"/g, '""') + '",';
        csv += '"' + (task.category || '') + '",';
        csv += '"' + (task.sla || '') + '",';
        csv += '"' + (task.isLead ? 'Yes' : 'No') + '",';
        csv += '"' + (task.completed ? 'Yes' : 'No') + '",';
        csv += '"' + (task.doneAt || '') + '"\n';
      });
      
      // Download CSV
      var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      var url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'tasks_' + currentHub + '_' + todayStr() + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      toast('ƒê√£ export ' + selectedTasks.length + ' tasks', 'ok');
    }
  };
  
  /* ====== COVER PAGE ====== */
  
  function showCover() {
    var cover = document.getElementById('cover');
    var mainContent = document.getElementById('main-content');
    var topbar = document.getElementById('topbar');
    if (cover) cover.style.display = 'grid';
    if (mainContent) mainContent.style.display = 'none';
    if (topbar) topbar.style.display = 'none';
  }
  
  function enterApp() {
    var cover = document.getElementById('cover');
    var mainContent = document.getElementById('main-content');
    var topbar = document.getElementById('topbar');
    if (cover) cover.style.display = 'none';
    if (mainContent) mainContent.style.display = 'flex';
    if (topbar) topbar.style.display = 'flex';
    
    // Load initial data
    loadTasks();
  }
  
  /* ====== TASK MANAGEMENT ====== */
  
  function loadTasks() {
    var hub = currentHub;
    var dateEl = $('#date');
    var date = (dateEl && dateEl.value) ? dateEl.value : todayStr();
    var key = storageKey(hub, date);
    var cacheHit = false;
    
    var cached = getCachedTasks(key);
    if (cached) {
      cacheHit = true;
      tasksData[hub] = cached;
      renderTasks();
      updateKPI();
      if (typeof GlobalSearch !== 'undefined' && GlobalSearch.refresh) {
        GlobalSearch.refresh();
      }
    } else {
      showSkeleton();
    }
    
    callApi('loadTasks', { storageKey: key }).then(function(tasks) {
      tasksData[hub] = tasks || [];
      
      // Debug: Log first task to check info and link fields
      if (tasks && tasks.length > 0) {
        console.log('[DEBUG] First task loaded:', {
          text: tasks[0].text,
          info: tasks[0].info,
          link: tasks[0].link,
          category: tasks[0].category
        });
      }
      
      renderTasks();
      updateKPI();
      saveTasksToCache(key, tasks || []);
      
      // Refresh search data
      if (typeof GlobalSearch !== 'undefined' && GlobalSearch.refresh) {
        GlobalSearch.refresh();
      }
      
      // Log event
      callApi('logEvent', {
        action: 'LOAD_TASKS',
        hub: hub,
        details: { date: date, count: tasks ? tasks.length : 0 }
      });
    }).catch(function(error) {
      console.error('Load tasks error:', error);
      if (cacheHit) {
        toast('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi. ƒêang d√πng d·ªØ li·ªáu g·∫ßn nh·∫•t.', 'warn');
      } else {
        toast('Failed to load tasks: ' + (error.message || error), 'err');
        var container = document.getElementById('vRows');
        if (container) {
          container.innerHTML = '<div class="hint" style="padding:20px;text-align:center">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</div>';
        }
      }
    });
  }
  
  function saveTasks(justCompleted) {
    var hub = currentHub;
    var dateEl = $('#date');
    var date = (dateEl && dateEl.value) ? dateEl.value : todayStr();
    var key = storageKey(hub, date);
    var tasks = tasksData[hub] || [];
    
    var btn = $('#saveBtn');
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'ƒêang l∆∞u...';
    }
    
    callApi('saveTasks', { storageKey: key, tasks: tasks }).then(function(result) {
      if (result.status === 'ok') {
        // Show different message based on whether task was just completed
        if (justCompleted === true) {
          // Task was just ticked/completed - show encouraging message
          toast('Gi·ªèi qu√°!', 'ok');
        } else if (justCompleted === false) {
          // Task was unchecked - silent save (no toast)
          // Don't show toast when unchecking to reduce noise
        } else {
          // Default save (not from checkbox toggle) - show success message
          toast('ƒê√£ l∆∞u th√†nh c√¥ng!', 'ok');
        }
        saveTasksToCache(key, tasks);
        
        // Log event
        callApi('logEvent', {
          action: 'SAVE_TASKS',
          hub: hub,
          details: { date: date, count: tasks.length }
        });
      } else {
        toast('L∆∞u th·∫•t b·∫°i: ' + result.message, 'err');
      }
    }).catch(function(error) {
      toast('L·ªói: ' + error.message, 'err');
    }).finally(function() {
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'üíæ L∆∞u';
      }
    });
  }
  
  function renderTasks() {
    var perfLabel = PerformanceMonitor.start('render-tasks');
    var tasks = tasksData[currentHub] || [];
    var container = document.getElementById('vRows');
    if (!container) return;
    container.innerHTML = '';
    
    if (tasks.length === 0) {
      container.innerHTML = '<div class="hint" style="padding:20px;text-align:center">Kh√¥ng c√≥ task n√†o. Nh·∫•n "+ Task t·ª©c th√¨" ƒë·ªÉ th√™m.</div>';
      if (perfLabel) PerformanceMonitor.end(perfLabel);
      return;
    }
    
    // Group by category - normalize category names to prevent mismatches
    var groups = {
      'ƒê·∫ßu Ca': [],
      'Trong Ca': [],
      'Cu·ªëi Ca': [],
      'H√†ng Tu·∫ßn': []
    };
    
    // Normalize category function
    function normalizeCategory(cat) {
      if (!cat) return 'ƒê·∫ßu Ca';
      var normalized = String(cat).trim();
      // Map common variations
      if (normalized.toLowerCase() === 'ƒë·∫ßu ca' || normalized.toLowerCase() === 'dau ca') return 'ƒê·∫ßu Ca';
      if (normalized.toLowerCase() === 'trong ca') return 'Trong Ca';
      if (normalized.toLowerCase() === 'cu·ªëi ca' || normalized.toLowerCase() === 'cuoi ca') return 'Cu·ªëi Ca';
      if (normalized.toLowerCase() === 'h√†ng tu·∫ßn' || normalized.toLowerCase() === 'hang tuan') return 'H√†ng Tu·∫ßn';
      // If exact match, return as is
      if (groups[normalized]) return normalized;
      // Default fallback
      return 'ƒê·∫ßu Ca';
    }
    
    tasks.forEach(function(task) {
      // Normalize category before grouping
      task.category = normalizeCategory(task.category);
      var cat = task.category;
      groups[cat].push(task);
    });
    
    // Calculate completion stats
    var totalDone = tasks.filter(function(t) { return t.completed; }).length;
    var totalTasks = tasks.length;
    
    // Render each group with collapsible headers
    var categoryOrder = ['ƒê·∫ßu Ca', 'Trong Ca', 'Cu·ªëi Ca', 'H√†ng Tu·∫ßn'];
    
    categoryOrder.forEach(function(category) {
      var categoryTasks = groups[category];
      
      // End performance monitoring after render
      if (category === categoryOrder[categoryOrder.length - 1] && perfLabel) {
        var duration = PerformanceMonitor.end(perfLabel);
        PerformanceMonitor.checkPerformance('render-tasks', duration);
      }
      if (!categoryTasks || categoryTasks.length === 0) return;
      
      var doneTasks = categoryTasks.filter(function(t) { return t.completed; }).length;
      var isComplete = doneTasks === categoryTasks.length;
      
      var section = document.createElement('div');
      section.className = 'section glass';
      section.style.marginBottom = '16px';
      
      // Collapsible header - Improved layout to prevent overlap
      var header = document.createElement('div');
      header.className = 'category-header';
      header.style.cssText = 'cursor: pointer; padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; user-select: none; border-bottom: 1px solid rgba(255,255,255,0.1); gap: 12px; position: relative;';
      
      var headerLeft = document.createElement('div');
      headerLeft.style.cssText = 'display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0;';
      
      // Arrow icon - positioned to not overlap title
      var arrow = document.createElement('span');
      arrow.textContent = '‚ñº';
      arrow.style.cssText = 'font-size: 14px; transition: transform 0.2s; color: var(--muted); flex-shrink: 0; width: 20px; text-align: center;';
      
      // Title container with proper spacing
      var titleContainer = document.createElement('div');
      titleContainer.style.cssText = 'display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0;';
      
      var title = document.createElement('strong');
      title.textContent = category;
      title.style.cssText = 'font-size: 17px; font-weight: 600; color: var(--ink); white-space: nowrap;';
      
      var status = document.createElement('span');
      status.textContent = isComplete ? 'ƒê√£ ho√†n th√†nh' : 'Ch∆∞a ho√†n th√†nh';
      status.style.cssText = 'font-size: 12px; color: ' + (isComplete ? 'var(--brand-2)' : 'var(--fg2)') + '; padding: 3px 8px; background: ' + (isComplete ? 'rgba(16,185,129,0.1)' : 'rgba(156,163,175,0.1)') + '; border-radius: 6px; white-space: nowrap;';
      
      titleContainer.appendChild(title);
      titleContainer.appendChild(status);
      
      headerLeft.appendChild(arrow);
      headerLeft.appendChild(titleContainer);
      
      // Count badge on the right
      var headerRight = document.createElement('div');
      headerRight.textContent = doneTasks + '/' + categoryTasks.length;
      headerRight.style.cssText = 'font-size: 14px; font-weight: 600; color: var(--ink); background: var(--glass); padding: 6px 12px; border-radius: 8px; white-space: nowrap; flex-shrink: 0;';
      
      header.appendChild(headerLeft);
      header.appendChild(headerRight);
      
      // Task body (collapsible)
      var body = document.createElement('div');
      body.className = 'category-body';
      body.style.cssText = 'padding: 8px; transition: max-height 0.3s ease;';
      
      categoryTasks.forEach(function(task) {
        var item = createTaskItem(task);
        body.appendChild(item);
      });
      
      // Toggle collapse
      header.addEventListener('click', function() {
        var isCollapsed = body.style.display === 'none';
        body.style.display = isCollapsed ? 'block' : 'none';
        arrow.style.transform = isCollapsed ? 'rotate(0deg)' : 'rotate(-90deg)';
      });
      
      section.appendChild(header);
      section.appendChild(body);
      container.appendChild(section);
    });
  }
  
  var PRIORITY_LEVELS = {
    high: { label: 'üî¥ Cao', bg: 'rgba(239,68,68,0.12)', color: '#ef4444' },
    medium: { label: 'üü° Trung b√¨nh', bg: 'rgba(245,158,11,0.15)', color: '#d97706' },
    low: { label: 'üü¢ Th·∫•p', bg: 'rgba(16,185,129,0.15)', color: '#059669' }
  };
  
  function createTaskItem(task) {
    var item = document.createElement('div');
    item.className = 'item' + (task.completed ? ' done' : '');
    item.setAttribute('data-task-id', task.id);
    item.style.cssText = 'display: flex; align-items: flex-start; gap: 12px; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);';
    
    // Bulk selection checkbox (if in selection mode)
    if (BulkOperations && BulkOperations.selectionMode) {
      var bulkCheckbox = document.createElement('input');
      bulkCheckbox.type = 'checkbox';
      bulkCheckbox.className = 'bulk-select-checkbox';
      bulkCheckbox.checked = BulkOperations.selectedTasks.indexOf(task.id) !== -1;
      bulkCheckbox.style.cssText = 'margin-top: 4px; cursor: pointer; width:18px;height:18px;';
      bulkCheckbox.addEventListener('change', function(e) {
        e.stopPropagation();
        BulkOperations.toggleTaskSelection(task.id);
      });
      item.appendChild(bulkCheckbox);
    }
    
    // Task completion checkbox
    var checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = task.completed;
    checkbox.style.cssText = 'margin-top: 4px; cursor: pointer;';
    checkbox.disabled = (BulkOperations && BulkOperations.selectionMode);
    
    // Create label element early so it can be referenced in the event listener
    var label = document.createElement('span');
    label.textContent = task.text;
    label.style.cssText = 'font-size: 16px; font-weight: 500; line-height: 1.5;' + (task.completed ? ' text-decoration: line-through; opacity: 0.7;' : '');
    
    checkbox.addEventListener('change', function(e) {
      if (BulkOperations && BulkOperations.selectionMode) {
        e.stopPropagation();
        return;
      }
      task.completed = checkbox.checked;
      task.doneAt = checkbox.checked ? new Date().toISOString() : null;
      item.classList.toggle('done', checkbox.checked);
      
      // Update text strikethrough
      if (label) {
        label.style.textDecoration = checkbox.checked ? 'line-through' : 'none';
        label.style.opacity = checkbox.checked ? '0.7' : '1';
      }
      
      // Update category completion status without full re-render
      var categorySection = item.closest('.section');
      if (categorySection) {
        var allTasks = tasksData[currentHub] || [];
        var categoryTasks = allTasks.filter(function(t) { return t.category === task.category; });
        var doneTasks = categoryTasks.filter(function(t) { return t.completed; }).length;
        var totalCatTasks = categoryTasks.length;
        var isComplete = doneTasks === totalCatTasks;
        
        // Update status span (now inside titleContainer)
        var titleContainer = categorySection.querySelector('.category-header > div:first-child > div:last-child');
        if (titleContainer) {
          var statusSpan = titleContainer.querySelector('span');
          if (statusSpan) {
            statusSpan.textContent = isComplete ? 'ƒê√£ ho√†n th√†nh' : 'Ch∆∞a ho√†n th√†nh';
            statusSpan.style.color = isComplete ? 'var(--brand-2)' : 'var(--fg2)';
            statusSpan.style.background = isComplete ? 'rgba(16,185,129,0.1)' : 'rgba(156,163,175,0.1)';
          }
        }
        
        // Update count badge
        var countSpan = categorySection.querySelector('.category-header > div:last-child');
        if (countSpan) {
          countSpan.textContent = doneTasks + '/' + totalCatTasks;
        }
      }
      
      updateKPI();
      
      // Auto save after check
      var wasCompleted = checkbox.checked;
      saveTasks(wasCompleted); // Pass completion status to show appropriate message
    });
    
    var content = document.createElement('div');
    content.style.cssText = 'flex: 1; display: flex; flex-direction: column; gap: 6px;';
    
    var labelRow = document.createElement('div');
    labelRow.style.cssText = 'display: flex; align-items: center; gap: 8px; flex-wrap: wrap;';
    
    // Label was already created above, just append it
    labelRow.appendChild(label);
    
    // Priority badge
    var priorityKey = getTaskPriority(task);
    var priorityConf = PRIORITY_LEVELS[priorityKey];
    // Safety check: fallback to medium if priorityConf is undefined
    if (!priorityConf) {
      priorityConf = PRIORITY_LEVELS['medium'] || { label: 'üü° Trung b√¨nh', bg: 'rgba(245,158,11,0.15)', color: '#d97706' };
    }
    var priorityBadge = document.createElement('span');
    priorityBadge.className = 'chip priority-chip';
    priorityBadge.textContent = priorityConf.label;
    priorityBadge.style.cssText = 'background: ' + priorityConf.bg + '; color: ' + priorityConf.color + '; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 12px; cursor: pointer;';
    priorityBadge.title = 'Click ƒë·ªÉ ƒë·∫∑t ƒë·ªô ∆∞u ti√™n';
    priorityBadge.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      openPriorityPrompt(task);
    });
    labelRow.appendChild(priorityBadge);
    
    // Badges
    if (task.isLead) {
      var leadBadge = document.createElement('span');
      leadBadge.className = 'chip';
      leadBadge.textContent = 'üëî LEAD';
      leadBadge.style.cssText = 'background: var(--brand-2); color: #111; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 12px;';
      labelRow.appendChild(leadBadge);
    }
    
    if (task.sla) {
      var slaBadge = document.createElement('span');
      slaBadge.className = 'chip';
      slaBadge.textContent = '‚è∞ SLA: ' + task.sla;
      slaBadge.style.cssText = 'background: rgba(255,100,100,0.2); color: #ff6464; font-size: 12px; font-weight: 500; padding: 4px 10px; border-radius: 12px; cursor: pointer;';
      slaBadge.title = 'Click ƒë·ªÉ thay ƒë·ªïi SLA';
      slaBadge.addEventListener('click', function() {
        setSLAForTask(task);
      });
      labelRow.appendChild(slaBadge);
    } else {
      var addSlaBtn = document.createElement('span');
      addSlaBtn.className = 'chip';
      addSlaBtn.textContent = '‚è∞ + SLA';
      addSlaBtn.style.cssText = 'background: rgba(100,150,255,0.15); color: #6495ed; font-size: 12px; font-weight: 500; padding: 4px 10px; border-radius: 12px; cursor: pointer;';
      addSlaBtn.title = 'Click ƒë·ªÉ th√™m SLA cho task n√†y';
      addSlaBtn.addEventListener('click', function() {
        setSLAForTask(task);
      });
      labelRow.appendChild(addSlaBtn);
    }
    
    // Add Info icon (‚ÑπÔ∏è) - ALWAYS SHOW to display task description - IMPROVED DESIGN
      var infoIcon = document.createElement('button');
      infoIcon.className = 'task-info-btn';
      infoIcon.innerHTML = '‚ÑπÔ∏è';
    infoIcon.title = task.info && task.info.trim() !== '' ? 'Xem m√¥ t·∫£ chi ti·∫øt task' : 'Kh√¥ng c√≥ m√¥ t·∫£ cho task n√†y';
    infoIcon.style.cssText = 'background: rgba(59, 130, 246, 0.15); border: none; color: #3b82f6; font-size: 16px; padding: 6px 10px; border-radius: 8px; cursor: pointer; transition: all 0.2s; min-width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center;';
    if (!task.info || task.info.trim() === '') {
      infoIcon.style.opacity = '0.5';
    }
      infoIcon.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
      // Debug: Log task info before showing modal
      console.log('[DEBUG] Showing task info modal for task:', {
        text: task.text,
        info: task.info,
        link: task.link,
        fullTask: task
      });
        showTaskInfoModal(task);
      });
      labelRow.appendChild(infoIcon);
    
    // Add Link button if link exists and is valid URL - IMPROVED DESIGN
    if (task.link && task.link.trim() !== '') {
      var linkValue = String(task.link).trim();
      // Validate URL - must start with http:// or https://
      var isValidUrl = /^https?:\/\/.+/.test(linkValue);
      
      if (isValidUrl) {
      var linkBtn = document.createElement('a');
      linkBtn.className = 'task-link';
        linkBtn.href = linkValue;
      linkBtn.target = '_blank';
      linkBtn.rel = 'noopener noreferrer';
        linkBtn.innerHTML = 'üîó Link';
        linkBtn.title = 'Click ƒë·ªÉ m·ªü link: ' + linkValue;
        linkBtn.style.cssText = 'background: rgba(16, 185, 129, 0.15); color: #10b981; font-size: 13px; font-weight: 500; padding: 6px 12px; border-radius: 8px; text-decoration: none; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px;';
      linkBtn.addEventListener('click', function(e) {
        e.stopPropagation();
          // Ensure link opens in new tab
          window.open(linkValue, '_blank', 'noopener,noreferrer');
        });
        linkBtn.addEventListener('mouseenter', function() {
          this.style.background = 'rgba(16, 185, 129, 0.25)';
          this.style.transform = 'scale(1.05)';
        });
        linkBtn.addEventListener('mouseleave', function() {
          this.style.background = 'rgba(16, 185, 129, 0.15)';
          this.style.transform = 'scale(1)';
      });
      labelRow.appendChild(linkBtn);
      } else {
        // If link is not a valid URL, don't show anything (hide invalid links)
        // This prevents showing non-URL text like "2025 (H2-ver02) - Daily Truck..."
        // Uncomment below if you want to show invalid links as text info
        /*
        var linkInfo = document.createElement('span');
        linkInfo.className = 'task-link-info';
        linkInfo.innerHTML = 'üìé ' + (linkValue.length > 30 ? linkValue.substring(0, 30) + '...' : linkValue);
        linkInfo.title = 'Link: ' + linkValue;
        linkInfo.style.cssText = 'background: rgba(156, 163, 175, 0.15); color: #9ca3af; font-size: 11px; padding: 4px 8px; border-radius: 6px; display: inline-block;';
        labelRow.appendChild(linkInfo);
        */
      }
    }
    
    // Add Note button (üìù) - NEW FEATURE for task notes
    var noteBtn = document.createElement('button');
    noteBtn.className = 'task-note-btn';
    noteBtn.innerHTML = 'üìù';
    noteBtn.title = 'Ghi ch√∫ s·ª± v·ª• c√≥ li√™n quan';
    noteBtn.style.cssText = 'background: rgba(245, 158, 11, 0.15); border: none; color: #f59e0b; font-size: 16px; padding: 6px 10px; border-radius: 8px; cursor: pointer; transition: all 0.2s; min-width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center;';
    noteBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      showTaskNoteModal(task);
    });
    noteBtn.addEventListener('mouseenter', function() {
      this.style.background = 'rgba(245, 158, 11, 0.25)';
      this.style.transform = 'scale(1.1)';
    });
    noteBtn.addEventListener('mouseleave', function() {
      this.style.background = 'rgba(245, 158, 11, 0.15)';
      this.style.transform = 'scale(1)';
    });
    labelRow.appendChild(noteBtn);
    
    content.appendChild(labelRow);
    
    item.appendChild(checkbox);
    item.appendChild(content);
    
    return item;
  }
  
  function showSkeleton(selector) {
    var container = selector ? document.querySelector(selector) : document.getElementById('vRows');
    if (!container) return;
    container.innerHTML = '';
    for (var i = 0; i < 6; i++) {
      var skeleton = document.createElement('div');
      skeleton.className = 'skeleton';
      skeleton.style.margin = '8px 0';
      skeleton.style.height = '48px';
      container.appendChild(skeleton);
    }
  }
  
  function updateKPI() {
    var tasks = tasksData[currentHub] || [];
    var done = tasks.filter(function(t) { return t.completed; }).length;
    var total = tasks.length;
    
    // Fix: Use jQuery .text() method or vanilla JS
    var doneEl = document.getElementById('done');
    var todoEl = document.getElementById('todo');
    if (doneEl) doneEl.textContent = done;
    if (todoEl) todoEl.textContent = total - done;
    
    // Also update the unfinished tile click handler if needed
    var unfinishedCount = total - done;
    var unfinishedTile = document.getElementById('unfinishedTile');
    if (unfinishedTile && unfinishedCount > 0) {
      unfinishedTile.style.cursor = 'pointer';
      unfinishedTile.title = 'Click ƒë·ªÉ xem ' + unfinishedCount + ' tasks ch∆∞a ho√†n th√†nh';
    }
  }
  
  function getTaskPriority(task) {
    if (!task || !task.priority || !PRIORITY_LEVELS[task.priority]) {
      return 'medium';
    }
    return task.priority;
  }
  
  function applyPriority(task, priority) {
    var normalized = (priority || '').toLowerCase().trim();
    if (!PRIORITY_LEVELS[normalized]) {
      toast('ƒê·ªô ∆∞u ti√™n kh√¥ng h·ª£p l·ªá (ch·ªâ high / medium / low)', 'err');
      return false;
    }
    task.priority = normalized;
    renderTasks();
    saveTasks();
    toast('ƒê√£ c·∫≠p nh·∫≠t ƒë·ªô ∆∞u ti√™n: ' + PRIORITY_LEVELS[normalized].label, 'ok');
    return true;
  }
  
  function openPriorityPrompt(task) {
    var current = getTaskPriority(task);
    var input = prompt('Nh·∫≠p ƒë·ªô ∆∞u ti√™n (high / medium / low):', current);
    if (input === null) return;
    applyPriority(task, input);
  }
  
  function setTaskPriority(taskId, priority) {
    var tasks = tasksData[currentHub] || [];
    var found = null;
    for (var i = 0; i < tasks.length; i++) {
      if (tasks[i].id === taskId) {
        found = tasks[i];
        break;
      }
    }
    if (!found) {
      console.warn('setTaskPriority: Task not found for id', taskId);
      return;
    }
    applyPriority(found, priority || 'medium');
  }
  window.setTaskPriority = setTaskPriority;
  
  function setSLAForTask(task) {
    var currentSLA = task.sla || '';
    var newSLA = prompt('Nh·∫≠p SLA (format: HH:MM, v√≠ d·ª•: 14:30):', currentSLA);
    
    if (newSLA === null) return; // User cancelled
    
    // Validate SLA format
    if (newSLA && !/^\d{1,2}:\d{2}$/.test(newSLA)) {
      toast('SLA ph·∫£i c√≥ format HH:MM (v√≠ d·ª•: 14:30)', 'err');
      return;
    }
    
    task.sla = newSLA || null;
    
    // Re-render tasks to show updated SLA
    renderTasks();
    
    // Save tasks
    saveTasks();
    
    // Sync to Google Calendar if SLA is set
    if (task.sla) {
      syncTasksToCalendar();
      toast('ƒê√£ set SLA v√† sync v·ªõi Google Calendar!', 'ok');
    } else {
      toast('ƒê√£ x√≥a SLA', 'ok');
    }
  }
  
  function syncTasksToCalendar() {
    var hub = currentHub;
    var date = $('#date').value || todayStr();
    var tasks = tasksData[hub] || [];
    
    // Only sync tasks with SLA
    var tasksWithSLA = tasks.filter(function(t) { return t.sla; });
    
    if (tasksWithSLA.length === 0) {
      return;
    }
    
    callApi('syncSlaToCalendar', {
      hub: hub,
      date: date,
      tasks: tasksWithSLA
    }).then(function(result) {
      if (result && result.ok) {
        console.log('Calendar sync:', result.created + ' created, ' + result.skipped + ' skipped');
      }
    }).catch(function(error) {
      console.error('Calendar sync failed:', error);
    });
  }
  
  function addAdHocTask() {
    var text = prompt('Nh·∫≠p t√™n task:');
    if (!text || !text.trim()) return;
    
    var tasks = tasksData[currentHub] || [];
    var newTask = {
      id: 'adhoc_' + Date.now(),
      category: 'Trong Ca',
      text: text.trim(),
      isLead: false,
      completed: false,
      adHoc: true,
      sla: null
    };
    
    tasks.push(newTask);
    tasksData[currentHub] = tasks;
    renderTasks();
    updateKPI();
    
    toast('ƒê√£ th√™m task t·ª©c th√¨', 'ok');
  }
  
  /* ====== CHARTS & DASHBOARD SYSTEM ====== */
  
  var ChartLoader = (function() {
    var chartSrc = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
    var dataLabelSrc = 'https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js';
    var registering = false;
    var chartPromise = null;
    
    function registerPlugin() {
      if (typeof Chart !== 'undefined' && typeof window.ChartDataLabels !== 'undefined' && Chart.register && !registering) {
        registering = true;
        try {
          Chart.register(window.ChartDataLabels);
        } catch (e) {
          console.warn('[ChartLoader] Plugin registration failed:', e);
        }
      }
    }
    
    return {
      ensure: function() {
        if (typeof Chart !== 'undefined' && typeof window.ChartDataLabels !== 'undefined') {
          registerPlugin();
          return Promise.resolve();
        }
        
        if (chartPromise) {
          return chartPromise;
        }
        
        chartPromise = loadExternalScript(chartSrc)
          .then(function() {
            return loadExternalScript(dataLabelSrc);
          })
          .then(function() {
            registerPlugin();
          })
          .catch(function(error) {
            console.error('[ChartLoader] Failed to load chart libraries:', error);
            chartPromise = null;
            throw error;
          });
        
        return chartPromise;
      }
    };
  })();
  
  var ChartManager = {
    charts: {},
    
    // Chart color scheme
    colors: {
      primary: '#ff6a00',
      secondary: '#ffb300',
      success: '#10b981',
      warning: '#f59e0b',
      danger: '#ef4444',
      info: '#3b82f6',
      muted: '#64748b',
      background: 'rgba(255, 255, 255, 0.1)'
    },
    
    // Get theme colors
    getThemeColors: function() {
      var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      return {
        text: isDark ? '#f3f4f6' : '#111827',
        grid: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
        background: isDark ? 'rgba(0, 0, 0, 0.2)' : 'rgba(255, 255, 255, 0.5)'
      };
    },
    
    // Destroy chart
    destroy: function(chartId) {
      if (this.charts[chartId]) {
        this.charts[chartId].destroy();
        delete this.charts[chartId];
      }
    },
    
    // Destroy all charts
    destroyAll: function() {
      for (var chartId in this.charts) {
        this.destroy(chartId);
      }
    },
    
    // Task Completion Chart (Doughnut)
    renderCompletionChart: function(canvasId, completed, total) {
      var canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      this.destroy(canvasId);
      
      var pending = total - completed;
      var theme = this.getThemeColors();
      
      var ctx = canvas.getContext('2d');
      this.charts[canvasId] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Ho√†n th√†nh', 'Ch∆∞a ho√†n th√†nh'],
          datasets: [{
            data: [completed, pending],
            backgroundColor: [this.colors.success, this.colors.muted],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: theme.text,
                padding: 15,
                font: { size: 12 }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  var label = context.label || '';
                  var value = context.parsed || 0;
                  var total = context.dataset.data.reduce(function(a, b) { return a + b; }, 0);
                  var percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return label + ': ' + value + ' (' + percentage + '%)';
                }
              }
            },
            datalabels: {
              color: theme.text,
              font: { size: 14, weight: 'bold' },
              formatter: function(value, context) {
                var total = context.dataset.data.reduce(function(a, b) { return a + b; }, 0);
                return total > 0 ? Math.round((value / total) * 100) + '%' : '0%';
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    },
    
    // Tasks by Category Chart (Bar)
    renderCategoryChart: function(canvasId, categoryData) {
      var canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      this.destroy(canvasId);
      
      var theme = this.getThemeColors();
      var labels = categoryData.map(function(c) { return c.category; });
      var completed = categoryData.map(function(c) { return c.completed; });
      var total = categoryData.map(function(c) { return c.total; });
      
      var ctx = canvas.getContext('2d');
      this.charts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Ho√†n th√†nh',
              data: completed,
              backgroundColor: this.colors.success,
              borderColor: this.colors.success,
              borderWidth: 1
            },
            {
              label: 'T·ªïng',
              data: total,
              backgroundColor: this.colors.muted,
              borderColor: this.colors.muted,
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: theme.text,
                stepSize: 1
              },
              grid: {
                color: theme.grid
              }
            },
            x: {
              ticks: {
                color: theme.text
              },
              grid: {
                color: theme.grid
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: theme.text,
                padding: 10
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  var label = context.dataset.label || '';
                  var value = context.parsed.y || 0;
                  return label + ': ' + value;
                }
              }
            }
          }
        }
      });
    },
    
    // Daily Progress Chart (Line)
    renderDailyChart: function(canvasId, dailyData) {
      var canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      this.destroy(canvasId);
      
      var theme = this.getThemeColors();
      var labels = dailyData.map(function(d) { return d.date; });
      var completed = dailyData.map(function(d) { return d.completed; });
      var total = dailyData.map(function(d) { return d.total; });
      
      var ctx = canvas.getContext('2d');
      this.charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Ho√†n th√†nh',
              data: completed,
              borderColor: this.colors.success,
              backgroundColor: this.colors.success + '20',
              tension: 0.4,
              fill: true
            },
            {
              label: 'T·ªïng',
              data: total,
              borderColor: this.colors.primary,
              backgroundColor: this.colors.primary + '20',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: {
            mode: 'index',
            intersect: false
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: theme.text,
                stepSize: 1
              },
              grid: {
                color: theme.grid
              }
            },
            x: {
              ticks: {
                color: theme.text
              },
              grid: {
                color: theme.grid
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: theme.text,
                padding: 10
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          }
        }
      });
    },
    
    // Hub Comparison Chart (Bar)
    renderHubChart: function(canvasId, hubData) {
      var canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      this.destroy(canvasId);
      
      var theme = this.getThemeColors();
      var labels = hubData.map(function(h) { return h.hubId; });
      var completed = hubData.map(function(h) { return h.completed; });
      var total = hubData.map(function(h) { return h.total; });
      
      var ctx = canvas.getContext('2d');
      this.charts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Ho√†n th√†nh',
              data: completed,
              backgroundColor: this.colors.success,
              borderColor: this.colors.success,
              borderWidth: 1
            },
            {
              label: 'T·ªïng',
              data: total,
              backgroundColor: this.colors.muted,
              borderColor: this.colors.muted,
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: theme.text,
                stepSize: 1
              },
              grid: {
                color: theme.grid
              }
            },
            x: {
              ticks: {
                color: theme.text
              },
              grid: {
                color: theme.grid
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: theme.text,
                padding: 10
              }
            }
          }
        }
      });
    },
    
    // Hourly Visits Chart (Line)
    renderHourlyChart: function(canvasId, hourlyData) {
      var canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      this.destroy(canvasId);
      
      var theme = this.getThemeColors();
      var labels = hourlyData.map(function(h) { return h.hour + 'h'; });
      var visits = hourlyData.map(function(h) { return h.count; });
      
      var ctx = canvas.getContext('2d');
      this.charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Truy c·∫≠p',
            data: visits,
            borderColor: this.colors.primary,
            backgroundColor: this.colors.primary + '20',
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: theme.text,
                stepSize: 1
              },
              grid: {
                color: theme.grid
              }
            },
            x: {
              ticks: {
                color: theme.text
              },
              grid: {
                color: theme.grid
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'Truy c·∫≠p: ' + context.parsed.y;
                }
              }
            }
          }
        }
      });
    }
  };
  
  /* ====== REPORT MODULE ====== */
  
  function setupReportHub() {
    var sel = document.getElementById('reportHub');
    if (!sel) return;
    
    sel.innerHTML = '<option value="ALL">üåê T·∫•t c·∫£ Hubs (Multi-Hub Overview)</option>';
    
    var hubs = Object.keys(hubData);
    hubs.forEach(function(hubId) {
      var opt = document.createElement('option');
      opt.value = hubId;
      opt.textContent = hubData[hubId].name;
      sel.appendChild(opt);
    });
    
    sel.value = 'ALL';
  }
  
  function loadReport() {
    var hub = $('#reportHub') ? $('#reportHub').value : currentHub;
    var rangeMode = $('.btn.active[data-r]');
    var mode = rangeMode ? rangeMode.getAttribute('data-r') : 'month';
    
    var range;
    // Handle custom date range
    if (mode === 'custom') {
      var startDate = $('#reportDateStart') ? $('#reportDateStart').value : '';
      var endDate = $('#reportDateEnd') ? $('#reportDateEnd').value : '';
      
      if (!startDate || !endDate) {
        toast('Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c', 'err');
        return;
      }
      
      range = { start: startDate, end: endDate };
    } else {
      var date = $('#reportDate') ? $('#reportDate').value : todayStr();
      range = calculateDateRange(mode, date);
    }
    
    // Hide empty state and show loading
    var emptyState = document.getElementById('reportEmptyState');
    var loadingState = document.getElementById('reportLoadingState');
    var chartsContainer = document.getElementById('reportCharts');
    var dataContainer = document.getElementById('reportDataContainer');
    
    if (emptyState) emptyState.style.display = 'none';
    if (loadingState) loadingState.style.display = 'block';
    if (chartsContainer) chartsContainer.style.display = 'none';
    if (dataContainer) dataContainer.innerHTML = '';
    
    callApi('loadReport', {
      hub: hub,
      start: range.start,
      end: range.end
    }).then(function(data) {
      if (!data || data.error) {
        if (emptyState) emptyState.style.display = 'block';
        if (loadingState) loadingState.style.display = 'none';
        toast('L·ªói: ' + (data ? data.error : 'No data received'), 'err');
        return;
      }
      
      renderReportData(data, hub);
    }).catch(function(error) {
      if (emptyState) emptyState.style.display = 'block';
      if (loadingState) loadingState.style.display = 'none';
      toast('L·ªói: ' + (error.message || error), 'err');
    });
  }
  
  function renderReportData(data, selectedHub) {
    var container = document.getElementById('reportContent');
    if (!container) return;
    
    // Check if multi-hub
    var isMultiHub = selectedHub === 'ALL' && data.hubs;
    
    // Hide empty state and loading, show charts container
    var emptyState = document.getElementById('reportEmptyState');
    var loadingState = document.getElementById('reportLoadingState');
    var chartsContainer = document.getElementById('reportCharts');
    
    if (emptyState) emptyState.style.display = 'none';
    if (loadingState) loadingState.style.display = 'none';
    if (chartsContainer) {
      chartsContainer.style.display = 'block';
    }
    
    // Render KPI Cards - Enhanced with Hub Statistics
    var kpiCards = document.getElementById('reportKPICards');
    if (kpiCards) {
      kpiCards.innerHTML = '';
      
      // Calculate additional metrics
      var activeHubsCount = 0;
      var completed100HubsCount = 0;
      
      if (isMultiHub && data.hubs && data.hubs.length > 0) {
        // Count active hubs (hubs with tasks)
        activeHubsCount = data.hubs.filter(function(hub) {
          return hub.total > 0;
        }).length;
        
        // Count hubs with 100% completion
        completed100HubsCount = data.hubs.filter(function(hub) {
          return hub.total > 0 && hub.completed === hub.total;
        }).length;
      }
      
      var kpis = [
        { title: 'T·ªïng Tasks', value: data.summary.total || 0, icon: 'üìã', color: '#3b82f6', bg: 'rgba(59,130,246,0.1)' },
        { title: 'Ho√†n th√†nh', value: data.summary.completed || 0, icon: '‚úÖ', color: '#10b981', bg: 'rgba(16,185,129,0.1)' },
        { title: 'C√≤n l·∫°i', value: data.summary.pending || 0, icon: '‚è≥', color: '#f59e0b', bg: 'rgba(245,158,11,0.1)' },
        { title: 'SLA Rate', value: (data.summary.onTimeRate || 0) + '%', icon: '‚è∞', color: '#8b5cf6', bg: 'rgba(139,92,246,0.1)' }
      ];
      
      // Add Hub statistics if multi-hub
      if (isMultiHub) {
        kpis.push(
          { title: 'Hub Thao T√°c', value: activeHubsCount, icon: 'üè¢', color: '#06b6d4', bg: 'rgba(6,182,212,0.1)' },
          { title: 'Hub Ho√†n Th√†nh 100%', value: completed100HubsCount, icon: 'üéØ', color: '#14b8a6', bg: 'rgba(20,184,166,0.1)' }
        );
      }
      
      kpis.forEach(function(kpi) {
        var card = document.createElement('div');
        card.className = 'glass';
        var cardColor = kpi.color || '#3b82f6';
        var cardBg = kpi.bg || 'rgba(59,130,246,0.1)';
        card.style.cssText = 'padding:12px;text-align:center;border-radius:10px;transition:transform 0.2s,box-shadow 0.2s;border-left:3px solid ' + cardColor;
        card.style.background = cardBg + ', var(--glass)';
        card.onmouseenter = function() {
          this.style.transform = 'translateY(-2px)';
          this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        };
        card.onmouseleave = function() {
          this.style.transform = 'translateY(0)';
          this.style.boxShadow = 'none';
        };
        card.innerHTML = `
          <div style="font-size:24px;margin-bottom:6px">${kpi.icon}</div>
          <div style="font-size:20px;font-weight:700;color:${cardColor};margin-bottom:3px">${kpi.value}</div>
          <div style="font-size:11px;color:var(--muted);font-weight:500;line-height:1.3">${kpi.title}</div>
        `;
        kpiCards.appendChild(card);
      });
    }
    
    // Render charts (lazy load Chart.js on demand)
    ChartLoader.ensure().then(function() {
      if (typeof Chart === 'undefined' || !ChartManager) return;
      
      // Task Completion Chart
      ChartManager.renderCompletionChart('reportCompletionChart', data.summary.completed, data.summary.total);
      
      // Tasks by Category Chart
      if (data.categories && data.categories.length > 0) {
        ChartManager.renderCategoryChart('reportCategoryChart', data.categories);
      }
      
      // Daily Progress Chart
      if (data.daily && data.daily.length > 0) {
        ChartManager.renderDailyChart('reportDailyChart', data.daily);
      }
      
      // Hub Comparison Chart (if multi-hub)
      if (isMultiHub && data.hubs && data.hubs.length > 0) {
        var hubChartContainer = document.getElementById('reportHubChartContainer');
        if (hubChartContainer) {
          hubChartContainer.style.display = 'block';
        }
        ChartManager.renderHubChart('reportHubChart', data.hubs);
      } else {
        var hubChartContainer = document.getElementById('reportHubChartContainer');
        if (hubChartContainer) {
          hubChartContainer.style.display = 'none';
        }
      }
      
      // Setup download buttons for all charts
      setupChartDownloadButtons();
    }).catch(function(error) {
      console.error('[Report] Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán Chart.js:', error);
      toast('Kh√¥ng th·ªÉ t·∫£i bi·ªÉu ƒë·ªì (Chart.js). Vui l√≤ng th·ª≠ l·∫°i sau.', 'warn');
    });
    
    // Render data tables in separate container
    var dataContainer = document.getElementById('reportDataContainer');
    if (!dataContainer) {
      dataContainer = document.createElement('div');
      dataContainer.id = 'reportDataContainer';
      container.appendChild(dataContainer);
    }
    dataContainer.innerHTML = '';
    
    // Summary section
    var summary = document.createElement('div');
    summary.className = 'section glass';
    summary.innerHTML = `
      <h3>üìä T·ªïng Quan${isMultiHub ? ' - T·∫•t C·∫£ Hubs' : ''}</h3>
      <div class="grid">
        <div class="tile glass">
          <div class="n">${data.summary.total}</div>
          <div class="t">T·ªïng Tasks</div>
        </div>
        <div class="tile glass">
          <div class="n">${data.summary.completed}</div>
          <div class="t">Ho√†n th√†nh</div>
        </div>
        <div class="tile glass">
          <div class="n">${data.summary.pending}</div>
          <div class="t">C√≤n l·∫°i</div>
        </div>
        <div class="tile glass">
          <div class="n">${data.summary.onTimeRate}%</div>
          <div class="t">SLA Rate</div>
        </div>
      </div>
    `;
    
    dataContainer.appendChild(summary);
  }
  
  function exportExcelReport() {
    var hub = $('#reportHub') ? $('#reportHub').value : currentHub;
    var date = $('#reportDate').value || todayStr();
    var rangeMode = $('.btn.active[data-r]');
    var mode = rangeMode ? rangeMode.getAttribute('data-r') : 'month';
    
    var range = calculateDateRange(mode, date);
    
    toast('ƒêang t·∫°o file Excel...', 'ok');
    
    callApi('exportToExcel', {
      hub: hub,
      start: range.start,
      end: range.end
    }).then(function(result) {
      if (!result || result.error) {
        toast('L·ªói: ' + (result ? result.error : 'No data received'), 'err');
        return;
      }
      
      toast('Excel ƒë√£ ƒë∆∞·ª£c t·∫°o! M·ªü link...', 'ok');
      window.open(result.url, '_blank');
    }).catch(function(error) {
      toast('L·ªói: ' + (error.message || error), 'err');
    });
  }
  
  function exportPDFReport() {
    var hub = $('#reportHub') ? $('#reportHub').value : currentHub;
    var date = $('#reportDate').value || todayStr();
    var rangeMode = $('.btn.active[data-r]');
    var mode = rangeMode ? rangeMode.getAttribute('data-r') : 'month';
    
    var range = calculateDateRange(mode, date);
    
    toast('ƒêang t·∫°o file PDF...', 'ok');
    
    callApi('exportToPDF', {
      hub: hub,
      start: range.start,
      end: range.end
    }).then(function(result) {
      if (!result || result.error) {
        toast('L·ªói: ' + (result ? result.error : 'No data received'), 'err');
        return;
      }
      
      toast('PDF ƒë√£ ƒë∆∞·ª£c t·∫°o! M·ªü link...', 'ok');
      window.open(result.url, '_blank');
    }).catch(function(error) {
      toast('L·ªói: ' + (error.message || error), 'err');
    });
  }
  
  /* ====== HIGHLIGHT MODULE ====== */
  
  function loadHighlight() {
    var hub = currentHub;
    var date = $('#hlDate').value || todayStr();
    var rangeMode = $('#hlRange .btn.active');
    var mode = rangeMode ? rangeMode.getAttribute('data-r') : 'today';
    
    var range = calculateDateRange(mode, date);
    
    callApi('getHighlights', {
      hub: hub,
      start: range.start,
      end: range.end
    }).then(function(data) {
      if (!data || data.error) {
        toast('L·ªói: ' + (data ? data.error : 'No data received'), 'err');
        return;
      }
      
      renderHighlightData(data);
    }).catch(function(error) {
      toast('L·ªói: ' + (error.message || error), 'err');
    });
  }
  
  function renderHighlightData(data) {
    var grid = $('#hlGrid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    // KPI cards
    var cards = [
      { title: 'Active Users', value: data.activeUsers, icon: 'üë•' },
      { title: 'Truy c·∫≠p', value: data.visits, icon: 'üîç' },
      { title: 'Thao t√°c', value: data.interactions, icon: '‚ö°' },
      { title: 'Tasks ho√†n th√†nh', value: data.tasksDone, icon: '‚úÖ' },
      { title: 'SLA On-time', value: data.slaOnTime, icon: '‚è∞' },
      { title: 'SLA Rate', value: data.slaRate + '%', icon: 'üìä' }
    ];
    
    cards.forEach(function(card) {
      var tile = document.createElement('div');
      tile.className = 'tile glass';
      tile.innerHTML = `
        <div class="tile-head"><strong>${esc(card.title)}</strong></div>
        <div class="n">${esc(String(card.value))}</div>
      `;
      grid.appendChild(tile);
    });
    
    // Hourly chart with Chart.js
    var chartTile = document.createElement('div');
    chartTile.className = 'tile glass';
    chartTile.style.gridColumn = 'span 2';
    chartTile.style.padding = '20px';
    
    var chartTitle = document.createElement('div');
    chartTitle.className = 'tile-head';
    chartTitle.innerHTML = '<strong>Truy c·∫≠p theo gi·ªù</strong>';
    chartTile.appendChild(chartTitle);
    
    var chartCanvas = document.createElement('canvas');
    chartCanvas.id = 'hlHourlyChart';
    chartCanvas.style.maxHeight = '300px';
    chartTile.appendChild(chartCanvas);
    
    grid.appendChild(chartTile);
    
    // Render hourly chart with Chart.js
    if (typeof Chart !== 'undefined' && ChartManager && data.visitsByHour) {
      ChartManager.renderHourlyChart('hlHourlyChart', data.visitsByHour);
    }
  }
  
  /* ====== CHART DOWNLOAD FUNCTIONALITY ====== */
  
  function setupChartDownloadButtons() {
    // Remove existing event listeners by cloning and replacing buttons
    var downloadButtons = document.querySelectorAll('.btn-download-chart');
    downloadButtons.forEach(function(btn) {
      // Clone button to remove old listeners
      var newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      
      // Add click handler
      newBtn.addEventListener('click', function() {
        var chartId = this.getAttribute('data-chart-id');
        var chartName = this.getAttribute('data-chart-name') || chartId;
        downloadChart(chartId, chartName);
      });
      
      // Add hover effect
      newBtn.addEventListener('mouseenter', function() {
        this.style.background = 'rgba(59,130,246,0.2)';
        this.style.transform = 'scale(1.05)';
      });
      newBtn.addEventListener('mouseleave', function() {
        this.style.background = 'rgba(59,130,246,0.1)';
        this.style.transform = 'scale(1)';
      });
    });
  }
  
  function downloadChart(canvasId, chartName) {
    try {
      var canvas = document.getElementById(canvasId);
      if (!canvas) {
        toast('Kh√¥ng t√¨m th·∫•y chart', 'err');
        return;
      }
      
      // Check if Chart.js chart exists
      if (typeof ChartManager !== 'undefined' && ChartManager.charts && ChartManager.charts[canvasId]) {
        var chart = ChartManager.charts[canvasId];
        // Use Chart.js toBase64Image method
        var url = chart.toBase64Image('image/png', 1);
        downloadImage(url, chartName + '_' + new Date().toISOString().slice(0, 10) + '.png');
      } else {
        // Fallback: use canvas toDataURL
        var url = canvas.toDataURL('image/png');
        downloadImage(url, chartName + '_' + new Date().toISOString().slice(0, 10) + '.png');
      }
      
      toast('ƒê√£ t·∫£i ·∫£nh chart th√†nh c√¥ng!', 'ok');
    } catch (error) {
      console.error('Download chart error:', error);
      toast('L·ªói khi t·∫£i ·∫£nh: ' + error.message, 'err');
    }
  }
  
  function downloadImage(dataUrl, filename) {
    try {
      var link = document.createElement('a');
      link.download = filename;
      link.href = dataUrl;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (error) {
      console.error('Download image error:', error);
      toast('L·ªói khi t·∫£i file: ' + error.message, 'err');
    }
  }
  
  /* ====== ACCESS LOG MODULE ====== */
  
  function setupAccessFilters() {
    callApi('getAllUsers', {}).then(function(users) {
      var sel = document.getElementById('accessUser');
      if (!sel) return;
      
      sel.innerHTML = '<option value="">üßë T·∫•t c·∫£ Users</option>';
      
      // Fix: Check if users is valid array
      if (!users || !Array.isArray(users) || users.length === 0) {
        console.warn('No users data received or invalid format');
        return;
      }
      
      users.forEach(function(user) {
        var opt = document.createElement('option');
        opt.value = user.email;
        opt.textContent = user.displayName || user.email;
        sel.appendChild(opt);
      });
    }).catch(function(e) {
      console.error('Failed to load users for filter:', e);
    });
  }
  
  function loadAccessLog() {
    var filterUser = $('#accessUser') ? $('#accessUser').value : '';
    var filterAction = $('#accessActionType') ? $('#accessActionType').value : '';
    var startDate = $('#accessDateStart') ? $('#accessDateStart').value : '';
    var endDate = $('#accessDateEnd') ? $('#accessDateEnd').value : '';
    
    // Show loading skeleton
    var container = document.getElementById('accessList');
    if (container) {
      container.innerHTML = '';
      // Create skeleton table
      var skeletonTable = document.createElement('div');
      skeletonTable.className = 'glass';
      skeletonTable.style.padding = '20px';
      skeletonTable.style.borderRadius = '12px';
      for (var i = 0; i < 5; i++) {
        var skeletonRow = document.createElement('div');
        skeletonRow.className = 'skeleton';
        skeletonRow.style.height = '50px';
        skeletonRow.style.marginBottom = '12px';
        skeletonTable.appendChild(skeletonRow);
      }
      container.appendChild(skeletonTable);
    }
    
    callApi('getAuditLog', {
      email: filterUser,
      action: filterAction,
      hub: currentHub,
      startDate: startDate,
      endDate: endDate,
      limit: 200
    }).then(function(logs) {
      // getAuditLog returns an array, not an object with error property
      if (!Array.isArray(logs)) {
        if (container) {
          container.innerHTML = '<p class="hint" style="padding:40px;text-align:center">L·ªói: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá</p>';
        }
        toast('L·ªói: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá', 'err');
        return;
      }
      
      // Empty array is valid - just means no logs found
      renderAccessLog(logs);
      renderAccessStats(logs);
    }).catch(function(error) {
      console.error('[Access Log] Error:', error);
      if (container) {
        container.innerHTML = '<p class="hint" style="padding:40px;text-align:center">L·ªói: ' + (error.message || error) + '</p>';
      }
      toast('L·ªói: ' + (error.message || error), 'err');
    });
  }
  
  function renderAccessStats(logs) {
    var statsContainer = document.getElementById('accessStats');
    if (!statsContainer || !logs || logs.length === 0) return;
    
    // Calculate stats
    var totalLogs = logs.length;
    var uniqueUsers = new Set(logs.map(function(log) { return log.email; })).size;
    var loginCount = logs.filter(function(log) { return log.action === 'LOGIN'; }).length;
    var actionTypes = {};
    logs.forEach(function(log) {
      actionTypes[log.action] = (actionTypes[log.action] || 0) + 1;
    });
    var topAction = Object.keys(actionTypes).reduce(function(a, b) {
      return actionTypes[a] > actionTypes[b] ? a : b;
    }, '');
    
    statsContainer.innerHTML = `
      <div class="glass" style="padding:16px;text-align:center;border-radius:12px">
        <div style="font-size:24px;font-weight:700;color:#3b82f6;margin-bottom:4px">${totalLogs}</div>
        <div style="font-size:12px;color:var(--muted)">T·ªïng Logs</div>
      </div>
      <div class="glass" style="padding:16px;text-align:center;border-radius:12px">
        <div style="font-size:24px;font-weight:700;color:#10b981;margin-bottom:4px">${uniqueUsers}</div>
        <div style="font-size:12px;color:var(--muted)">Users</div>
      </div>
      <div class="glass" style="padding:16px;text-align:center;border-radius:12px">
        <div style="font-size:24px;font-weight:700;color:#f59e0b;margin-bottom:4px">${loginCount}</div>
        <div style="font-size:12px;color:var(--muted)">Logins</div>
      </div>
      <div class="glass" style="padding:16px;text-align:center;border-radius:12px">
        <div style="font-size:20px;font-weight:700;color:#8b5cf6;margin-bottom:4px">${topAction}</div>
        <div style="font-size:12px;color:var(--muted)">Top Action</div>
      </div>
    `;
  }
  
  function clearAccessFilter() {
    if ($('#accessUser')) $('#accessUser').value = '';
    if ($('#accessActionType')) $('#accessActionType').value = '';
    var startDate = $('#accessDateStart');
    var endDate = $('#accessDateEnd');
    if (startDate) {
      var today = new Date();
      var lastWeek = new Date(today);
      lastWeek.setDate(today.getDate() - 7);
      startDate.value = lastWeek.toISOString().slice(0, 10);
    }
    if (endDate) {
      endDate.value = new Date().toISOString().slice(0, 10);
    }
    loadAccessLog();
  }
  
  function viewAccessDetail(log) {
    var timestamp = new Date(log.timestamp).toLocaleString(lang === 'en' ? 'en-US' : 'vi-VN');
    var details = log.details ? JSON.stringify(log.details, null, 2) : 'N/A';
    var session = log.sessionInfo ? JSON.stringify(log.sessionInfo, null, 2) : 'N/A';
    
    var html = `
      <div style="padding:20px">
        <h3>üìã Chi Ti·∫øt Access Log</h3>
        <div class="group" style="margin-top:16px">
          <div><strong>Email:</strong> ${esc(log.email)}</div>
          <div><strong>Action:</strong> ${esc(log.action)}</div>
          <div><strong>Hub:</strong> ${esc(log.hub || '-')}</div>
          <div><strong>Timestamp:</strong> ${timestamp}</div>
        </div>
        <div class="group" style="margin-top:16px">
          <div><strong>Details:</strong></div>
          <pre style="background:var(--bg);padding:12px;border-radius:8px;overflow:auto;max-height:200px">${esc(details)}</pre>
        </div>
        <div class="group" style="margin-top:16px">
          <div><strong>Session Info:</strong></div>
          <pre style="background:var(--bg);padding:12px;border-radius:8px;overflow:auto;max-height:200px">${esc(session)}</pre>
        </div>
        <div style="margin-top:20px;text-align:center">
          <button onclick="this.closest('.modal').remove()" class="btn btn-primary">ƒê√≥ng</button>
        </div>
      </div>
    `;
    
    showModal(html);
  }
  
  function exportAccessLogData() {
    var filterUser = $('#accessUser') ? $('#accessUser').value : '';
    var filterAction = $('#accessActionType') ? $('#accessActionType').value : '';
    
    toast('ƒêang t·∫°o Excel...', 'ok');
    
    callApi('exportAccessLog', {
      email: filterUser,
      action: filterAction,
      hub: currentHub
    }).then(function(result) {
      if (!result || result.error) {
        toast('L·ªói: ' + (result ? result.error : 'Failed'), 'err');
        return;
      }
      
      toast('Excel ƒë√£ t·∫°o! M·ªü link...', 'ok');
      window.open(result.url, '_blank');
    }).catch(function(error) {
      toast('L·ªói: ' + (error.message || error), 'err');
    });
  }
  
  function renderAccessLog(logs) {
    var container = document.getElementById('accessList');
    if (!container) return;
    container.innerHTML = '';
    
    if (!logs || logs.length === 0) {
      var emptyState = createEmptyState({
        icon: 'üîç',
        title: 'Kh√¥ng c√≥ log n√†o',
        description: 'Kh√¥ng t√¨m th·∫•y log n√†o trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn. H√£y th·ª≠ ƒëi·ªÅu ch·ªânh b·ªô l·ªçc.',
        actionLabel: 'üîÑ Reset b·ªô l·ªçc',
        onAction: clearAccessFilter
      });
      container.innerHTML = '';
      container.appendChild(emptyState);
      return;
    }
    
    // Create table for better display
    var table = document.createElement('table');
    table.className = 'table';
    table.style.cssText = 'width:100%;border-collapse:collapse';
    table.innerHTML = `
      <thead>
        <tr style="background:rgba(0,0,0,0.03);border-bottom:2px solid var(--stroke);position:sticky;top:0;z-index:10">
          <th style="padding:12px;text-align:left;font-weight:600;font-size:13px;color:var(--ink)">Th·ªùi gian</th>
          <th style="padding:12px;text-align:left;font-weight:600;font-size:13px;color:var(--ink)">User</th>
          <th style="padding:12px;text-align:left;font-weight:600;font-size:13px;color:var(--ink)">Action</th>
          <th style="padding:12px;text-align:left;font-weight:600;font-size:13px;color:var(--ink)">Hub</th>
          <th style="padding:12px;text-align:center;font-weight:600;font-size:13px;color:var(--ink)">Chi ti·∫øt</th>
        </tr>
      </thead>
      <tbody id="accessLogBody"></tbody>
    `;
    
    var tbody = table.querySelector('tbody');
    
    logs.forEach(function(log) {
      var tr = document.createElement('tr');
      tr.style.cssText = 'border-bottom:1px solid var(--stroke);transition:background 0.2s;cursor:pointer';
      tr.onmouseenter = function() { this.style.background = 'rgba(0,0,0,0.02)'; };
      tr.onmouseleave = function() { this.style.background = 'transparent'; };
      
      var timestamp = new Date(log.timestamp);
      var timeStr = timestamp.toLocaleString(lang === 'en' ? 'en-US' : 'vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      var actionIcon = {
        'LOGIN': 'üîê',
        'SAVE_TASKS': 'üíæ',
        'TAB_SWITCH': 'üìë',
        'SEND_CHAT_MESSAGE': 'üí¨',
        'ANSWER_QUESTION': '‚ùì',
        'LOAD_REPORT': 'üìä',
        'EXPORT': 'üìó'
      }[log.action] || 'üìù';
      
      tr.innerHTML = `
        <td style="padding:12px;font-size:13px;color:var(--muted);white-space:nowrap">${timeStr}</td>
        <td style="padding:12px;font-weight:500;color:var(--ink)">${esc(log.email)}</td>
        <td style="padding:12px">
          <span class="chip" style="background:rgba(59,130,246,0.1);color:#3b82f6;font-size:12px">${actionIcon} ${esc(log.action)}</span>
        </td>
        <td style="padding:12px;color:var(--ink)">${esc(log.hub || '-')}</td>
        <td style="padding:12px;text-align:center">
          <button class="btn btn-soft btn-sm view-log-btn" style="padding:6px 12px;font-size:12px">üëÅÔ∏è Xem</button>
        </td>
      `;
      
      tr.addEventListener('click', function() {
        viewAccessDetail(log);
      });
      
      var viewBtn = tr.querySelector('.view-log-btn');
      if (viewBtn) {
        viewBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          viewAccessDetail(log);
        });
      }
      
      tbody.appendChild(tr);
    });
    
    container.appendChild(table);
    
    // Make viewAccessDetail available globally
    window.viewAccessDetail = viewAccessDetail;
    
    // End performance monitoring
    if (perfLabel) {
      var duration = PerformanceMonitor.end(perfLabel);
      PerformanceMonitor.checkPerformance('render-access-log', duration);
    }
  }
  
  function showModal(html) {
    var modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:grid;place-items:center;z-index:9999;';
    
    var box = document.createElement('div');
    box.className = 'glass';
    box.style.cssText = 'max-width:600px;width:90%;max-height:80vh;overflow:auto;border-radius:16px;';
    box.innerHTML = html;
    
    modal.appendChild(box);
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
      if (e.target === modal) modal.remove();
    });
    
    // Return box element so we can access it
    return box;
  }
  
  // Removed duplicate showTaskInfoModal - using the one at line 932 instead
  
  /* ====== ADMIN MODULE ====== */
  
  function loadUsers() {
    if (currentUser.role !== 'admin') {
      toast('B·∫°n kh√¥ng c√≥ quy·ªÅn admin', 'err');
      return;
    }
    
    // Show loading skeleton
    var tbody = $('#usersTableBody');
    if (tbody) {
      var skeletonRow = document.createElement('tr');
      skeletonRow.innerHTML = '<td colspan="7" style="padding:40px">';
      var skeletonContainer = document.createElement('div');
      skeletonContainer.style.display = 'grid';
      skeletonContainer.style.gridTemplateColumns = 'repeat(7, 1fr)';
      skeletonContainer.style.gap = '12px';
      for (var i = 0; i < 7; i++) {
        var skeleton = document.createElement('div');
        skeleton.className = 'skeleton skeleton-text';
        skeleton.style.height = '20px';
        skeletonContainer.appendChild(skeleton);
      }
      skeletonRow.querySelector('td').appendChild(skeletonContainer);
      tbody.innerHTML = '';
      tbody.appendChild(skeletonRow);
    }
    
    callApi('getAllUsers').then(function(users) {
      // getAllUsers returns an array, not an object with error property
      if (!Array.isArray(users)) {
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px">L·ªói: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá</td></tr>';
        }
        toast('L·ªói: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá', 'err');
        return;
      }
      
      // Empty array is valid - just means no users found
      renderUsersTable(users);
    }).catch(function(error) {
      console.error('[Admin] Load users error:', error);
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px">L·ªói: ' + (error.message || error) + '</td></tr>';
      }
      toast('L·ªói: ' + (error.message || error), 'err');
    });
  }
  
  var allUsersData = []; // Store all users for filtering
  
  function renderUsersTable(users) {
    allUsersData = users || [];
    var tbody = $('#usersTableBody');
    tbody.innerHTML = '';
    
    if (!users || users.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px">';
      var emptyState = createEmptyState({
        icon: 'üë•',
        title: 'Ch∆∞a c√≥ user n√†o',
        description: 'B·∫Øt ƒë·∫ßu b·∫±ng c√°ch th√™m user m·ªõi v√†o h·ªá th·ªëng.',
        actionLabel: '+ Th√™m User',
        onAction: function() {
          var addBtn = document.getElementById('addUser');
          if (addBtn) addBtn.click();
        }
      });
      var emptyCell = document.createElement('td');
      emptyCell.colSpan = 7;
      emptyCell.style.padding = '0';
      emptyCell.appendChild(emptyState);
      var emptyRow = document.createElement('tr');
      emptyRow.appendChild(emptyCell);
      tbody.appendChild(emptyRow);
      renderUserStats([]);
      return;
    }
    
    renderUserStats(users);
    filterUsersTable(''); // Render all users initially
  }
  
  function renderUserStats(users) {
    var statsContainer = document.getElementById('adminUserStats');
    if (!statsContainer) return;
    
    var totalUsers = users.length;
    var activeUsers = users.filter(function(u) { return u.active; }).length;
    var adminUsers = users.filter(function(u) { return u.role === 'admin'; }).length;
    var regularUsers = users.filter(function(u) { return u.role === 'user'; }).length;
    
    statsContainer.innerHTML = `
      <div class="glass" style="padding:16px;text-align:center;border-radius:12px">
        <div style="font-size:24px;font-weight:700;color:#3b82f6;margin-bottom:4px">${totalUsers}</div>
        <div style="font-size:12px;color:var(--muted)">T·ªïng Users</div>
      </div>
      <div class="glass" style="padding:16px;text-align:center;border-radius:12px">
        <div style="font-size:24px;font-weight:700;color:#10b981;margin-bottom:4px">${activeUsers}</div>
        <div style="font-size:12px;color:var(--muted)">Active</div>
      </div>
      <div class="glass" style="padding:16px;text-align:center;border-radius:12px">
        <div style="font-size:24px;font-weight:700;color:#8b5cf6;margin-bottom:4px">${adminUsers}</div>
        <div style="font-size:12px;color:var(--muted)">Admins</div>
      </div>
      <div class="glass" style="padding:16px;text-align:center;border-radius:12px">
        <div style="font-size:24px;font-weight:700;color:#f59e0b;margin-bottom:4px">${regularUsers}</div>
        <div style="font-size:12px;color:var(--muted)">Users</div>
      </div>
    `;
  }
  
  function filterUsersTable(searchTerm) {
    var tbody = $('#usersTableBody');
    if (!tbody) return;
    
    var filtered = allUsersData;
    if (searchTerm && searchTerm.trim() !== '') {
      var term = searchTerm.toLowerCase();
      filtered = allUsersData.filter(function(user) {
        return (user.email && user.email.toLowerCase().indexOf(term) !== -1) ||
               (user.displayName && user.displayName.toLowerCase().indexOf(term) !== -1) ||
               (user.hub && user.hub.toLowerCase().indexOf(term) !== -1);
      });
    }
    
    tbody.innerHTML = '';
    
    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px">Kh√¥ng t√¨m th·∫•y user n√†o</td></tr>';
      return;
    }
    
    filtered.forEach(function(user) {
      var tr = document.createElement('tr');
      tr.style.cssText = 'border-bottom:1px solid var(--stroke);transition:background 0.2s';
      tr.onmouseenter = function() { this.style.background = 'rgba(0,0,0,0.02)'; };
      tr.onmouseleave = function() { this.style.background = 'transparent'; };
      
      var lastAccess = user.lastAccess ? new Date(user.lastAccess).toLocaleString(lang === 'en' ? 'en-US' : 'vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      }) : 'Ch∆∞a c√≥';
      
      var roleColor = user.role === 'admin' ? '#8b5cf6' : '#3b82f6';
      var roleBg = user.role === 'admin' ? 'rgba(139,92,246,0.1)' : 'rgba(59,130,246,0.1)';
      
      tr.innerHTML = `
        <td style="padding:12px;font-weight:500;color:var(--ink)">${esc(user.email)}</td>
        <td style="padding:12px;color:var(--ink)">${esc(user.displayName || '-')}</td>
        <td style="padding:12px;color:var(--ink)">${esc(user.hub || '-')}</td>
        <td style="padding:12px;text-align:center">
          <span class="chip" style="background:${roleBg};color:${roleColor};font-size:12px">${esc(user.role || 'user')}</span>
        </td>
        <td style="padding:12px;text-align:center">
          ${user.active ? '<span class="chip" style="background:#10b981;color:#fff;font-size:12px">‚úÖ Active</span>' : '<span class="chip" style="background:rgba(239,68,68,0.1);color:#ef4444;font-size:12px">‚ùå Inactive</span>'}
        </td>
        <td style="padding:12px;text-align:center;font-size:12px;color:var(--muted)">${lastAccess}</td>
        <td style="padding:12px;text-align:center">
          <div style="display:flex;gap:6px;justify-content:center">
            <button class="btn btn-soft btn-sm" onclick="editUser('${esc(user.email)}')" style="padding:6px 12px;font-size:12px">‚úèÔ∏è Edit</button>
            <button class="btn btn-soft btn-sm" onclick="deleteUserConfirm('${esc(user.email)}')" style="padding:6px 12px;font-size:12px;background:rgba(239,68,68,0.1);color:#ef4444">üóëÔ∏è Delete</button>
          </div>
        </td>
      `;
      
      tbody.appendChild(tr);
    });
  }
  
  function getUserByEmail(email, users) {
    if (!users || !email) return null;
    for (var i = 0; i < users.length; i++) {
      if (String(users[i].email).toLowerCase() === String(email).toLowerCase()) {
        return users[i];
      }
    }
    return null;
  }
  
  function showUserDialog(userData, isEdit) {
    var title = isEdit ? '‚úèÔ∏è Ch·ªânh S·ª≠a User' : '‚ûï Th√™m User M·ªõi';
    var emailValue = userData ? esc(userData.email) : '';
    var hubValue = userData ? esc(userData.hub) : '';
    var roleValue = userData ? esc(userData.role) : 'user';
    var activeValue = userData ? (userData.active ? 'true' : 'false') : 'true';
    var displayNameValue = userData ? esc(userData.displayName || '') : '';
    var photoUrlValue = userData ? esc(userData.photoUrl || '') : '';
    var emailDisabled = isEdit ? 'readonly style="background:var(--hover);cursor:not-allowed"' : '';
    
    var html = '<div style="padding:24px">';
    html += '<h3 style="margin:0 0 20px;font-size:20px;color:var(--fg)">' + title + '</h3>';
    
    // Form fields
    html += '<form id="userForm" onsubmit="return false;">';
    
    // Email field
    html += '<div class="group" style="margin-bottom:16px">';
    html += '<div class="label">Email <span style="color:#ef4444">*</span></div>';
    html += '<div class="control">';
    html += '<input type="email" id="userEmail" value="' + emailValue + '" ' + emailDisabled + ' required placeholder="user@spx.vn" style="width:100%"/>';
    html += '</div>';
    html += '</div>';
    
    // Hub field
    html += '<div class="group" style="margin-bottom:16px">';
    html += '<div class="label">Hub <span style="color:#ef4444">*</span></div>';
    html += '<div class="control">';
    html += '<input type="text" id="userHub" value="' + hubValue + '" required placeholder="80TVH01 ho·∫∑c 80TVH01,80TVH02 ho·∫∑c ALL" style="width:100%"/>';
    html += '<small style="color:var(--muted);font-size:12px;display:block;margin-top:4px">C√≥ th·ªÉ g√°n nhi·ªÅu hub b·∫±ng d·∫•u ph·∫©y (,) ho·∫∑c ALL cho admin</small>';
    html += '</div>';
    html += '</div>';
    
    // Role field
    html += '<div class="group" style="margin-bottom:16px">';
    html += '<div class="label">Role <span style="color:#ef4444">*</span></div>';
    html += '<div class="control">';
    html += '<select id="userRole" required style="width:100%">';
    html += '<option value="user"' + (roleValue === 'user' ? ' selected' : '') + '>User</option>';
    html += '<option value="admin"' + (roleValue === 'admin' ? ' selected' : '') + '>Admin</option>';
    html += '</select>';
    html += '</div>';
    html += '</div>';
    
    // Active field
    html += '<div class="group" style="margin-bottom:16px">';
    html += '<div class="label">Tr·∫°ng th√°i <span style="color:#ef4444">*</span></div>';
    html += '<div class="control">';
    html += '<select id="userActive" required style="width:100%">';
    html += '<option value="true"' + (activeValue === 'true' ? ' selected' : '') + '>Active</option>';
    html += '<option value="false"' + (activeValue === 'false' ? ' selected' : '') + '>Inactive</option>';
    html += '</select>';
    html += '</div>';
    html += '</div>';
    
    // Display Name field
    html += '<div class="group" style="margin-bottom:16px">';
    html += '<div class="label">T√™n hi·ªÉn th·ªã</div>';
    html += '<div class="control">';
    html += '<input type="text" id="userDisplayName" value="' + displayNameValue + '" placeholder="T√™n ng∆∞·ªùi d√πng" style="width:100%"/>';
    html += '</div>';
    html += '</div>';
    
    // Photo URL field
    html += '<div class="group" style="margin-bottom:20px">';
    html += '<div class="label">Photo URL</div>';
    html += '<div class="control">';
    html += '<input type="url" id="userPhotoUrl" value="' + photoUrlValue + '" placeholder="https://..." style="width:100%"/>';
    html += '<small style="color:var(--muted);font-size:12px;display:block;margin-top:4px">URL ·∫£nh ƒë·∫°i di·ªán (t√πy ch·ªçn)</small>';
    html += '</div>';
    html += '</div>';
    
    // Buttons
    html += '<div style="display:flex;gap:8px;justify-content:flex-end">';
    html += '<button type="button" class="btn btn-soft" onclick="this.closest(\'.modal\').remove()">H·ªßy</button>';
    html += '<button type="submit" class="btn btn-primary">üíæ ' + (isEdit ? 'C·∫≠p nh·∫≠t' : 'Th√™m') + '</button>';
    html += '</div>';
    
    html += '</form>';
    html += '</div>';
    
    // Show modal and get box element
    var modalBox = showModal(html);
    
    // Setup form submit handler - form is already in the box
    var form = modalBox.querySelector('#userForm');
    if (form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        saveUserFromForm(isEdit, modalBox);
      });
    }
  }
  
  function saveUserFromForm(isEdit, modalBox) {
    // Get form elements from modal box or document
    var container = modalBox || document;
    var emailEl = container.querySelector('#userEmail');
    var hubEl = container.querySelector('#userHub');
    var roleEl = container.querySelector('#userRole');
    var activeEl = container.querySelector('#userActive');
    var displayNameEl = container.querySelector('#userDisplayName');
    var photoUrlEl = container.querySelector('#userPhotoUrl');
    
    // Safety check: ensure all required elements exist
    if (!emailEl || !hubEl || !roleEl || !activeEl || !displayNameEl || !photoUrlEl) {
      toast('L·ªói: Kh√¥ng t√¨m th·∫•y c√°c tr∆∞·ªùng form c·∫ßn thi·∫øt', 'err');
      return;
    }
    
    var email = emailEl.value.trim();
    var hub = hubEl.value.trim();
    var role = roleEl.value;
    var active = activeEl.value === 'true';
    var displayName = displayNameEl.value.trim();
    var photoUrl = photoUrlEl.value.trim();
    
    // Validation
    if (!email) {
      toast('Email kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng', 'err');
      return;
    }
    
    if (!hub) {
      toast('Hub kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng', 'err');
      return;
    }
    
    // Email validation
    var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      toast('Email kh√¥ng h·ª£p l·ªá', 'err');
      return;
    }
    
    // Prepare user data
    var userData = {
      email: email,
      hub: hub,
      role: role,
      active: active,
      displayName: displayName,
      photoUrl: photoUrl
    };
    
    // Show loading
    var submitBtn = container.querySelector('#userForm button[type="submit"]');
    var originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '‚è≥ ƒêang l∆∞u...';
    submitBtn.disabled = true;
    
    // Call API
    callApi('saveUser', userData).then(function(result) {
      if (result.status === 'ok') {
        toast(isEdit ? 'ƒê√£ c·∫≠p nh·∫≠t user th√†nh c√¥ng' : 'ƒê√£ th√™m user th√†nh c√¥ng', 'ok');
        
        // Close modal
        var modal = document.querySelector('.modal');
        if (modal) modal.remove();
        
        // Reload users table
        loadUsers();
      } else {
        toast('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ l∆∞u user'), 'err');
        if (submitBtn) {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }
    }).catch(function(error) {
      toast('L·ªói: ' + error.message, 'err');
      if (submitBtn) {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });
  }
  
  function showAddUserDialog() {
    showUserDialog(null, false);
  }
  
  window.editUser = function(email) {
    // Load users to get user data
    callApi('getAllUsers').then(function(users) {
      if (!users || users.error) {
        toast('L·ªói: Kh√¥ng th·ªÉ t·∫£i danh s√°ch users', 'err');
        return;
      }
      
      var user = getUserByEmail(email, users);
      if (!user) {
        toast('Kh√¥ng t√¨m th·∫•y user: ' + email, 'err');
        return;
      }
      
      // Show edit dialog with user data
      showUserDialog(user, true);
    }).catch(function(error) {
      toast('L·ªói: ' + error.message, 'err');
    });
  };
  
  window.deleteUserConfirm = function(email) {
    if (!confirm('X√≥a user ' + email + '?')) return;
    
    callApi('deleteUser', { email: email }).then(function(result) {
      if (result.status === 'ok') {
        toast('ƒê√£ x√≥a user', 'ok');
        loadUsers();
      } else {
        toast('L·ªói: ' + result.message, 'err');
      }
    }).catch(function(error) {
      toast('L·ªói: ' + error.message, 'err');
    });
  };
  
  /* ====== DATE RANGE HELPERS ====== */
  
  function calculateDateRange(mode, baseDate) {
    var base = new Date(baseDate);
    var start, end;
    
    switch(mode) {
      case 'today':
        start = end = baseDate;
        break;
      
      case 'week':
        var dayOfWeek = base.getDay();
        var monday = new Date(base);
        monday.setDate(base.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        
        var sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        
        start = monday.toISOString().slice(0, 10);
        end = sunday.toISOString().slice(0, 10);
        break;
      
      case 'month':
        start = baseDate.slice(0, 8) + '01';
        var lastDay = new Date(base.getFullYear(), base.getMonth() + 1, 0);
        end = lastDay.toISOString().slice(0, 10);
        break;
      
      default:
        start = end = baseDate;
    }
    
    return { start: start, end: end };
  }
  
  /* ====== TAB SWITCHING ====== */
  
  function setupTabs() {
    $$('.tab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        var tabName = tab.getAttribute('data-tab');
        
        // Update active states
        $$('.tab').forEach(function(t) { t.classList.remove('active'); });
        $$('.content').forEach(function(c) { c.classList.remove('active'); });
        
        tab.classList.add('active');
        var content = document.querySelector('[data-content="' + tabName + '"]');
        if (content) content.classList.add('active');
        
        // Load data for specific tabs
        switch(tabName) {
          case 'admin':
            if (currentUser.role === 'admin') {
            loadUsers();
              // Setup search
              setTimeout(function() {
                var searchInput = document.getElementById('adminSearchUser');
                if (searchInput) {
                  searchInput.addEventListener('input', function() {
                    filterUsersTable(this.value);
                  });
                }
              }, 300);
            } else {
              toast('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p m√¥ ƒëun Admin', 'err');
            }
            break;
          case 'qa':
            setupQA();
            // Auto-load questions
            setTimeout(function() {
              loadQA();
            }, 300);
            break;
          case 'unfinished':
            loadUnfinished();
            break;
          case 'report':
            setupReportHub();
            // Auto-load report when switching to report tab
            setTimeout(function() {
              if (document.getElementById('reportContent')) {
                loadReport();
              }
            }, 300);
            break;
        }
        
        // Log tab switch
        callApi('logEvent', {
          action: 'TAB_SWITCH',
          hub: currentHub,
          details: { tab: tabName }
        });
      });
    });
  }
  
  /* ====== THEME & LANGUAGE ====== */
  
  var currentGradient = localStorage.getItem('spx_gradient') || '';
  
  function setupTheme() {
    document.documentElement.setAttribute('data-theme', theme);
    
    // Apply saved gradient theme
    if (currentGradient) {
      document.documentElement.setAttribute('data-gradient', currentGradient);
    }
    
    function toggleTheme() {
      theme = theme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('spx_theme', theme);
    }
    
    function setupGradientSelector() {
      var gradientBtn = document.getElementById('gradientThemeBtn');
      var gradientMenu = document.getElementById('gradientThemeMenu');
      var coverGradientBtn = document.getElementById('coverGradientThemeBtn');
      var coverGradientMenu = document.getElementById('coverGradientThemeMenu');
      
      function toggleGradientMenu(menu) {
        var isVisible = menu.style.display === 'block';
        // Close all menus first
        var allMenus = document.querySelectorAll('#gradientThemeMenu, #coverGradientThemeMenu');
        allMenus.forEach(function(m) { m.style.display = 'none'; });
        // Toggle current menu
        if (!isVisible) {
          menu.style.display = 'block';
        }
      }
      
      function applyGradient(gradientName) {
        currentGradient = gradientName;
        if (gradientName) {
          document.documentElement.setAttribute('data-gradient', gradientName);
        } else {
          document.documentElement.removeAttribute('data-gradient');
        }
        localStorage.setItem('spx_gradient', gradientName);
        
        // Close menus
        if (gradientMenu) gradientMenu.style.display = 'none';
        if (coverGradientMenu) coverGradientMenu.style.display = 'none';
        
        toast('Gradient theme ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng!', 'ok');
      }
      
      if (gradientBtn && gradientMenu) {
        gradientBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          toggleGradientMenu(gradientMenu);
        });
      }
      
      if (coverGradientBtn && coverGradientMenu) {
        coverGradientBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          toggleGradientMenu(coverGradientMenu);
        });
      }
      
      // Handle gradient option clicks
      var gradientOptions = document.querySelectorAll('.gradient-option');
      gradientOptions.forEach(function(option) {
        option.addEventListener('click', function() {
          var gradientName = this.getAttribute('data-gradient') || '';
          applyGradient(gradientName);
        });
      });
      
      // Close menu when clicking outside
      document.addEventListener('click', function(e) {
        if (gradientMenu && !gradientMenu.contains(e.target) && !gradientBtn.contains(e.target)) {
          gradientMenu.style.display = 'none';
        }
        if (coverGradientMenu && !coverGradientMenu.contains(e.target) && !coverGradientBtn.contains(e.target)) {
          coverGradientMenu.style.display = 'none';
        }
      });
    }
    
    setupGradientSelector();
    
    var themeToggle = document.getElementById('themeToggle');
    var coverTheme = document.getElementById('coverTheme');
    
    if (themeToggle) themeToggle.addEventListener('click', toggleTheme);
    if (coverTheme) coverTheme.addEventListener('click', toggleTheme);
  }
  
  function setupLanguage() {
    // i18n translations
    var translations = {
      vi: {
        'langToggle': 'VI/EN',
        'langToggle2': 'VI/EN',
        'i18n-back': 'Trang b√¨a',
        'i18n-cover-title': 'Qu·∫£n L√Ω Checklist H√†ng Ng√†y',
        'i18n-cover-sub': 'Theo d√µi ti·∫øn ƒë·ªô c√¥ng vi·ªác, qu·∫£n l√Ω hub, v√† c·ªông t√°c nh√≥m theo th·ªùi gian th·ª±c v·ªõi ph√¢n quy·ªÅn b·∫£o m·∫≠t.',
        'i18n-hub-label': 'ƒêang xem ti·∫øn ƒë·ªô Hub',
        'i18n-date-label': 'Ng√†y checklist',
        'i18n-filter-label': 'T√¨m ki·∫øm & L·ªçc',
        'i18n-online': 'Online'
      },
      en: {
        'langToggle': 'EN/VI',
        'langToggle2': 'EN/VI',
        'i18n-back': 'Cover Page',
        'i18n-cover-title': 'Daily Checklist Management',
        'i18n-cover-sub': 'Track work progress, manage hubs, and collaborate in real-time with secure role-based access.',
        'i18n-hub-label': 'Viewing Hub Progress',
        'i18n-date-label': 'Checklist Date',
        'i18n-filter-label': 'Search & Filter',
        'i18n-online': 'Online'
      }
    };
    
    function applyLanguage(newLang) {
      var dict = translations[newLang] || translations.vi;
      Object.keys(dict).forEach(function(key) {
        var el = document.getElementById(key);
        if (el) {
          if (el.tagName === 'BUTTON' || el.tagName === 'SPAN') {
            el.textContent = dict[key];
          } else {
            el.textContent = dict[key];
          }
        }
      });
      lang = newLang;
      localStorage.setItem('spx_lang', newLang);
    }
    
    function toggleLang() {
      var newLang = lang === 'vi' ? 'en' : 'vi';
      applyLanguage(newLang);
      toast('Language switched to ' + newLang.toUpperCase(), 'ok');
    }
    
    // Apply saved language on load
    var savedLang = localStorage.getItem('spx_lang') || 'vi';
    applyLanguage(savedLang);
    
    var langToggle = document.getElementById('langToggle');
    var langToggle2 = document.getElementById('langToggle2');
    if (langToggle) langToggle.addEventListener('click', toggleLang);
    if (langToggle2) langToggle2.addEventListener('click', toggleLang);
  }
  
  /* ====== VIETNAM HOLIDAYS GREETING ====== */
  
  function checkVietnamHolidays() {
    var today = new Date();
    var month = today.getMonth() + 1; // 1-12
    var day = today.getDate();
    
    var holidays = {
      '1-1': 'üéâ Ch√∫c M·ª´ng NƒÉm M·ªõi!',
      '2-14': 'üíù Ch√∫c M·ª´ng Ng√†y Valentine!',
      '3-8': 'üå∏ Ch√∫c M·ª´ng Ng√†y Qu·ªëc T·∫ø Ph·ª• N·ªØ 8/3!',
      '4-30': 'üáªüá≥ Ch√∫c M·ª´ng Ng√†y Gi·∫£i Ph√≥ng Mi·ªÅn Nam 30/4!',
      '5-1': 'üéä Ch√∫c M·ª´ng Ng√†y Qu·ªëc T·∫ø Lao ƒê·ªông 1/5!',
      '9-2': 'üáªüá≥ Ch√∫c M·ª´ng Ng√†y Qu·ªëc Kh√°nh 2/9!',
      '10-20': 'üå∏ Ch√∫c M·ª´ng Ng√†y Ph·ª• N·ªØ Vi·ªát Nam 20/10!',
      '11-20': 'üë®‚Äçüè´ Ch√∫c M·ª´ng Ng√†y Nh√† Gi√°o Vi·ªát Nam 20/11!',
      '12-24': 'üéÑ Ch√∫c M·ª´ng Gi√°ng Sinh!',
      '12-25': 'üéÖ Ch√∫c M·ª´ng L·ªÖ Noel!'
    };
    
    var key = month + '-' + day;
    var greeting = holidays[key];
    
    var greetingEl = document.getElementById('holidayGreeting');
    if (greeting && greetingEl) {
      greetingEl.textContent = greeting;
      greetingEl.style.display = 'block';
    } else if (greetingEl) {
      greetingEl.style.display = 'none';
    }
  }
  
  /* ====== INITIALIZATION ====== */
  
  function initUI() {
    // Setup bulk operations buttons
    var bulkSelectBtn = document.getElementById('bulkSelectBtn');
    var bulkEditBtn = document.getElementById('bulkEditBtn');
    var bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    var bulkExportBtn = document.getElementById('bulkExportBtn');
    var bulkCancelBtn = document.getElementById('bulkCancelBtn');
    
    if (bulkSelectBtn) {
      bulkSelectBtn.addEventListener('click', function() {
        BulkOperations.toggleSelectionMode();
      });
    }
    
    if (bulkEditBtn) {
      bulkEditBtn.addEventListener('click', function() {
        BulkOperations.bulkEdit();
      });
    }
    
    if (bulkDeleteBtn) {
      bulkDeleteBtn.addEventListener('click', function() {
        BulkOperations.bulkDelete();
      });
    }
    
    if (bulkExportBtn) {
      bulkExportBtn.addEventListener('click', function() {
        BulkOperations.bulkExport();
      });
    }
    
    if (bulkCancelBtn) {
      bulkCancelBtn.addEventListener('click', function() {
        BulkOperations.toggleSelectionMode();
      });
    }
    
    // Initialize bulk operations UI
    if (bulkSelectBtn) bulkSelectBtn.style.display = 'inline-block';
    if (bulkEditBtn) bulkEditBtn.style.display = 'none';
    if (bulkDeleteBtn) bulkDeleteBtn.style.display = 'none';
    if (bulkExportBtn) bulkExportBtn.style.display = 'none';
    if (bulkCancelBtn) bulkCancelBtn.style.display = 'none';
    
    // Setup date inputs
    var dateEl = document.querySelector('#date');
    var reportDateEl = document.querySelector('#reportDate');
    var hlDateEl = document.querySelector('#hlDate');
    
    if (dateEl) dateEl.value = todayStr();
    if (reportDateEl) reportDateEl.value = todayStr();
    if (hlDateEl) hlDateEl.value = todayStr();
    
    // Event listeners - Main
    var enterBtn = document.querySelector('#enterAppBtn');
    var backBtn = document.querySelector('#backCover');
    var saveBtn = document.querySelector('#saveBtn');
    var addAdHocBtn = document.querySelector('#addAdHoc');
    
    if (enterBtn) enterBtn.addEventListener('click', enterApp);
    if (backBtn) backBtn.addEventListener('click', showCover);
    if (saveBtn) saveBtn.addEventListener('click', saveTasks);
    if (addAdHocBtn) addAdHocBtn.addEventListener('click', addAdHocTask);
    
    // Hub change
    var hubSelect = document.querySelector('#hub');
    if (hubSelect) {
      hubSelect.addEventListener('change', function() {
        currentHub = this.value;
        localStorage.setItem('currentHubId', currentHub);
        loadTasks();
      });
    }
    
    // Date change
    if (dateEl) dateEl.addEventListener('change', loadTasks);
    
    // Report module  
    var refreshReportBtn = document.querySelector('#refreshReport');
    var quickLoadReportBtn = document.querySelector('#quickLoadReport');
    var exportExcelBtn = document.querySelector('#exportExcel');
    var exportPDFBtn = document.querySelector('#exportPDF');
    
    if (refreshReportBtn) refreshReportBtn.addEventListener('click', loadReport);
    if (quickLoadReportBtn) quickLoadReportBtn.addEventListener('click', loadReport);
    if (exportExcelBtn) exportExcelBtn.addEventListener('click', exportExcelReport);
    if (exportPDFBtn) exportPDFBtn.addEventListener('click', exportPDFReport);
    
    // Report date pickers and range buttons
    var reportDateEl = document.querySelector('#reportDate');
    var reportDateStartEl = document.querySelector('#reportDateStart');
    var reportDateEndEl = document.querySelector('#reportDateEnd');
    var reportDateDefault = document.getElementById('reportDateDefault');
    var reportDateCustom = document.getElementById('reportDateCustom');
    var reportRangeEl = document.querySelector('#reportRange');
    
    function updateReportDateDisplay() {
      try {
        var activeBtn = reportRangeEl ? reportRangeEl.querySelector('.btn.active[data-r]') : null;
        var mode = activeBtn ? activeBtn.getAttribute('data-r') : 'month';
        
        if (mode === 'custom') {
          if (reportDateDefault) reportDateDefault.style.display = 'none';
          if (reportDateCustom) {
            reportDateCustom.style.display = 'flex';
            // Set default dates if not set
            if (reportDateStartEl && !reportDateStartEl.value) {
              var today = new Date();
              var firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
              reportDateStartEl.value = firstDay.toISOString().slice(0, 10);
            }
            if (reportDateEndEl && !reportDateEndEl.value) {
              reportDateEndEl.value = todayStr();
            }
          }
        } else {
          if (reportDateDefault) reportDateDefault.style.display = 'block';
          if (reportDateCustom) reportDateCustom.style.display = 'none';
        }
      } catch (e) {
        console.error('Error in updateReportDateDisplay:', e);
      }
    }
    
    if (reportDateEl) reportDateEl.addEventListener('change', loadReport);
    if (reportDateStartEl) reportDateStartEl.addEventListener('change', loadReport);
    if (reportDateEndEl) reportDateEndEl.addEventListener('change', loadReport);
    
    // Report range buttons
    if (reportRangeEl) {
      // Initial display update
      updateReportDateDisplay();
      
      reportRangeEl.addEventListener('click', function(e) {
        if (e.target && e.target.tagName === 'BUTTON') {
          var btns = document.querySelectorAll('#reportRange .btn');
          btns.forEach(function(btn) { btn.classList.remove('active'); });
          e.target.classList.add('active');
          updateReportDateDisplay();
          // Only auto-load if not custom mode (custom requires user to select dates)
          var mode = e.target.getAttribute('data-r');
          if (mode !== 'custom') {
          loadReport();
          }
        }
      });
    }
    
    // Highlight module
    var refreshHlBtn = document.querySelector('#refreshHl');
    if (refreshHlBtn) refreshHlBtn.addEventListener('click', loadHighlight);
    if (hlDateEl) hlDateEl.addEventListener('change', loadHighlight);
    
    // Highlight range buttons
    var hlRangeEl = document.querySelector('#hlRange');
    if (hlRangeEl) {
      hlRangeEl.addEventListener('click', function(e) {
        if (e.target && e.target.tagName === 'BUTTON') {
          var btns = document.querySelectorAll('#hlRange .btn');
          btns.forEach(function(btn) { btn.classList.remove('active'); });
          e.target.classList.add('active');
          loadHighlight();
        }
      });
    }
    
    // Access log module
    var filterAccessBtn = document.querySelector('#filterAccess');
    var clearAccessBtn = document.querySelector('#clearAccessFilter');
    var exportAccessBtn = document.querySelector('#exportAccessLog');
    if (filterAccessBtn) filterAccessBtn.addEventListener('click', loadAccessLog);
    if (clearAccessBtn) clearAccessBtn.addEventListener('click', clearAccessFilter);
    if (exportAccessBtn) exportAccessBtn.addEventListener('click', exportAccessLogData);
    
    // Admin module
    var addUserBtn = document.querySelector('#addUser');
    var refreshUsersBtn = document.querySelector('#refreshUsers');
    if (addUserBtn) addUserBtn.addEventListener('click', showAddUserDialog);
    if (refreshUsersBtn) refreshUsersBtn.addEventListener('click', loadUsers);
    
    // Notes module
    var noteAddBtn = document.querySelector('#noteAdd');
    var noteSaveBtn = document.querySelector('#noteSave');
    if (noteAddBtn) noteAddBtn.addEventListener('click', addNote);
    if (noteSaveBtn) noteSaveBtn.addEventListener('click', saveNotesData);
    
    // Setup new modules
    setupUnfinished();
    setupReportHub();
    // Setup floating chat
    setupFloatingChat();
    
    // Setup tabs
    setupTabs();
    
    // Setup theme & language
    setupTheme();
    setupLanguage();
    
    // Check Vietnam holidays
    checkVietnamHolidays();
    
    // Update clock every second
    setInterval(updateClock, 1000);
    updateClock();
  }
  
  /* ====== NOTES MODULE ====== */
  
  function loadNotesData() {
    var hub = currentHub;
    var dateEl = $('#date');
    var date = (dateEl && dateEl.value) ? dateEl.value : todayStr();
    var key = 'notes_' + hub + '_' + date;
    
    callApi('loadNotes', { storageKey: key }).then(function(notes) {
      renderNotes(notes || []);
    }).catch(function(error) {
      console.error('Load notes error:', error);
    });
  }
  
  function renderNotes(notes) {
    var container = document.getElementById('noteList');
    if (!container) return;
    container.innerHTML = '';
    
    if (!notes || notes.length === 0) {
      container.innerHTML = '<div class="hint">Ch∆∞a c√≥ ghi ch√∫ n√†o</div>';
      return;
    }
    
    notes.forEach(function(note) {
      var item = document.createElement('div');
      item.className = 'item';
      
      var timestamp = new Date(note.at).toLocaleString(lang === 'en' ? 'en-US' : 'vi-VN');
      
      item.innerHTML = `
        <div style="flex:1">
          <div style="font-weight:700">${esc(note.author || 'User')}</div>
          <div class="t">${timestamp}</div>
          <div style="margin-top:6px;white-space:pre-wrap">${esc(note.text)}</div>
        </div>
      `;
      
      container.appendChild(item);
    });
  }
  
  function addNote() {
    var input = $('#noteInput');
    var text = input.value.trim();
    
    if (!text) {
      toast('Vui l√≤ng nh·∫≠p n·ªôi dung ghi ch√∫', 'warn');
      return;
    }
    
    var hub = currentHub;
    var dateEl = $('#date');
    var date = (dateEl && dateEl.value) ? dateEl.value : todayStr();
    var key = 'notes_' + hub + '_' + date;
    
    // Get current notes
    callApi('loadNotes', { storageKey: key }).then(function(notes) {
      notes = notes || [];
      
      // Add new note
      var newNote = {
        id: 'note_' + Date.now(),
        text: text,
        at: new Date().toISOString(),
        author: currentUser.displayName || currentUser.email
      };
      
      notes.push(newNote);
      
      // Save
      return callApi('saveNotes', { storageKey: key, notes: notes });
    }).then(function(result) {
      if (result.status === 'ok') {
        toast('ƒê√£ th√™m ghi ch√∫', 'ok');
        input.value = '';
        loadNotesData();
      } else {
        toast('L·ªói: ' + result.message, 'err');
      }
    }).catch(function(error) {
      toast('L·ªói: ' + error.message, 'err');
    });
  }
  
  function saveNotesData() {
    toast('Ghi ch√∫ ƒë∆∞·ª£c l∆∞u t·ª± ƒë·ªông', 'ok');
  }
  
  /* ====== Q&A MODULE ====== */
  
  var currentQAFilter = 'all';
  
  function setupQA() {
    var submitBtn = $('#qaSubmit');
    var refreshBtn = $('#qaRefresh');
    
    if (submitBtn) {
      submitBtn.addEventListener('click', submitQA);
    }
    
    if (refreshBtn) {
      refreshBtn.addEventListener('click', loadQA);
    }
    
    // Filter buttons
    var filterBtns = document.querySelectorAll('[data-qa-filter]');
    filterBtns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        filterBtns.forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        currentQAFilter = btn.getAttribute('data-qa-filter');
        loadQA();
      });
    });
    
    // Load on tab switch
    loadQA();
  }
  
  function submitQA() {
    var category = $('#qaCategory').value;
    var question = $('#qaQuestion').value;
    
    if (!question.trim()) {
      toast('Vui l√≤ng nh·∫≠p c√¢u h·ªèi', 'err');
      return;
    }
    
    callApi('submitQuestion', { category: category, question: question.trim() })
      .then(function(result) {
        if (result && result.status === 'ok') {
          toast('ƒê√£ g·ª≠i c√¢u h·ªèi th√†nh c√¥ng!', 'ok');
          $('#qaQuestion').value = '';
          loadQA();
        } else {
          toast('L·ªói: ' + (result.message || 'Unknown error'), 'err');
        }
      })
      .catch(function(error) {
        toast('L·ªói: ' + error.message, 'err');
      });
  }
  
  function loadQA() {
    var args = {};
    if (currentQAFilter !== 'all') {
      if (currentQAFilter === 'pending') {
        args.status = 'Pending';
      } else if (currentQAFilter === 'answered') {
        args.status = 'Answered';
      } else {
        args.category = currentQAFilter;
      }
    }
    
    var list = $('#qaList');
    if (list) {
      list.innerHTML = '';
      // Create skeleton cards
      for (var i = 0; i < 3; i++) {
        var skeletonCard = document.createElement('div');
        skeletonCard.className = 'skeleton skeleton-card';
        skeletonCard.style.marginBottom = '12px';
        skeletonCard.innerHTML = '<div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text"></div>';
        list.appendChild(skeletonCard);
      }
    }
    
    console.log('[QA] Loading questions with filters:', args);
    var perfLabel = PerformanceMonitor.start('api-getQuestions');
    
    callApi('getQuestions', args)
      .then(function(result) {
        PerformanceMonitor.end('api-getQuestions');
        
        // Handle both array and object response
        var questions = [];
        if (Array.isArray(result)) {
          questions = result;
        } else if (result && Array.isArray(result.data)) {
          questions = result.data;
        } else if (result && result.status === 'ok' && Array.isArray(result.questions)) {
          questions = result.questions;
        } else if (result && result.status === 'error') {
          console.error('[QA] API error:', result.message);
          if (list) {
            list.innerHTML = '<div class="glass" style="padding:40px;text-align:center;margin:20px 0">' +
              '<p style="color:var(--error);font-size:16px;font-weight:600;margin-bottom:8px">‚ùå L·ªói t·∫£i c√¢u h·ªèi</p>' +
              '<p style="color:var(--muted);font-size:14px">' + esc(result.message || 'Unknown error') + '</p>' +
              '<button class="btn btn-primary" onclick="loadQA()" style="margin-top:16px">üîÑ Th·ª≠ l·∫°i</button>' +
              '</div>';
          }
          return;
        }
        
        console.log('[QA] Loaded ' + questions.length + ' questions from sheet');
        
        if (questions.length === 0) {
          console.log('[QA] No questions found. Filters:', args);
        } else {
          console.log('[QA] First question:', questions[0]);
        }
        
        renderQA(questions);
      })
      .catch(function(error) {
        PerformanceMonitor.end('api-getQuestions');
        console.error('[QA] Load QA error:', error);
        console.error('[QA] Error details:', JSON.stringify(error));
        
        if (list) {
          list.innerHTML = '<div class="glass" style="padding:40px;text-align:center;margin:20px 0">' +
            '<p style="color:var(--error);font-size:16px;font-weight:600;margin-bottom:8px">‚ùå L·ªói t·∫£i c√¢u h·ªèi</p>' +
            '<p style="color:var(--muted);font-size:14px;margin-bottom:8px">' + esc(error.message || error.toString() || 'Unknown error') + '</p>' +
            '<p style="color:var(--muted);font-size:12px;margin-top:12px">Vui l√≤ng ki·ªÉm tra:</p>' +
            '<ul style="color:var(--muted);font-size:12px;text-align:left;display:inline-block;margin-top:8px">' +
            '<li>Sheet Q&A c√≥ t·ªìn t·∫°i trong Google Sheets</li>' +
            '<li>Sheet c√≥ header row ƒë√∫ng ƒë·ªãnh d·∫°ng</li>' +
            '<li>Sheet c√≥ d·ªØ li·ªáu c√¢u h·ªèi</li>' +
            '<li>Quy·ªÅn truy c·∫≠p v√†o Google Sheets</li>' +
            '</ul>' +
            '<button class="btn btn-primary" onclick="loadQA()" style="margin-top:16px">üîÑ Th·ª≠ l·∫°i</button>' +
            '<button class="btn btn-soft" onclick="console.log(\'QA Debug Info:\', arguments)" style="margin-top:8px;margin-left:8px">üîç Debug</button>' +
            '</div>';
        }
      });
  }
  
  function renderQA(questions) {
    var list = $('#qaList');
    if (!list) {
      console.error('[QA] QA list element not found');
      return;
    }
    
    console.log('[QA] Rendering ' + questions.length + ' questions');
    
    if (!Array.isArray(questions)) {
      console.error('[QA] Questions is not an array:', questions);
      list.innerHTML = '<div class="glass" style="padding:40px;text-align:center;margin:20px 0">' +
        '<p style="color:var(--error);font-size:16px;font-weight:600">‚ùå D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá</p>' +
        '<p style="color:var(--muted);font-size:14px">Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá admin</p>' +
        '</div>';
      return;
    }
    
    if (questions.length === 0) {
      console.log('[QA] No questions to render, showing empty state');
      var emptyState = createEmptyState({
        icon: '‚ùì',
        title: 'Ch∆∞a c√≥ c√¢u h·ªèi n√†o',
        description: 'H√£y ƒë·∫∑t c√¢u h·ªèi ƒë·∫ßu ti√™n c·ªßa b·∫°n ·ªü form ph√≠a tr√™n.',
        actionLabel: 'üí¨ ƒê·∫∑t c√¢u h·ªèi',
        onAction: function() {
          var questionInput = document.getElementById('qaQuestion');
          if (questionInput) {
            questionInput.focus();
            questionInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      });
      list.innerHTML = '';
      list.appendChild(emptyState);
      return;
    }
    
    list.innerHTML = '';
    var renderedCount = 0;
    questions.forEach(function(q, index) {
      try {
        // Validate question data
        if (!q || !q.Question) {
          console.warn('[QA] Invalid question at index ' + index + ':', q);
          return;
        }
        
        renderedCount++;
        console.log('[QA] Rendering question ' + renderedCount + ':', q.ID, q.Question.substring(0, 50) + '...');
        
        var card = document.createElement('div');
        card.className = 'glass';
        card.style.cssText = 'padding:16px;margin-bottom:12px;border-radius:12px;transition:transform 0.2s,box-shadow 0.2s';
        card.onmouseenter = function() {
          this.style.transform = 'translateY(-2px)';
          this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        };
        card.onmouseleave = function() {
          this.style.transform = 'translateY(0)';
          this.style.boxShadow = 'none';
        };
        
        var statusColor = q.Status === 'Answered' || q.Status === 'answered' ? '#10b981' : '#f59e0b';
        var statusBg = q.Status === 'Answered' || q.Status === 'answered' ? 'rgba(16,185,129,0.1)' : 'rgba(245,158,11,0.1)';
        var statusText = q.Status === 'Answered' || q.Status === 'answered' ? '‚úÖ ƒê√£ tr·∫£ l·ªùi' : '‚è≥ Ch·ªù tr·∫£ l·ªùi';
        
        var categoryIcon = {
          'Thao t√°c': 'üîß',
          'Giao di·ªán': 'üé®',
          'N·ªôi dung': 'üìù',
          'Kh√°c': '‚ùì'
        }[q.Category] || '‚ùì';
        
        var html = '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">';
        html += '<div style="display:flex;gap:8px;flex-wrap:wrap">';
        html += '<span class="chip" style="background:rgba(59,130,246,0.1);color:#3b82f6;font-size:12px">' + categoryIcon + ' ' + esc(q.Category) + '</span>';
        html += '<span class="chip" style="background:' + statusBg + ';color:' + statusColor + ';font-size:12px">' + statusText + '</span>';
        html += '</div>';
        html += '<small style="color:var(--muted);font-size:12px">' + (q.CreatedAt || '') + '</small></div>';
        html += '<p style="margin:0 0 12px;font-weight:600;font-size:15px;line-height:1.5">‚ùì ' + esc(q.Question) + '</p>';
        
        if (q.Answer && q.Answer.trim() !== '') {
          html += '<div style="margin-top:12px;padding:14px;background:rgba(16,185,129,0.08);border-left:4px solid #10b981;border-radius:8px">';
          html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px">';
          html += '<small style="color:#10b981;font-weight:600;font-size:12px">‚úÖ Tr·∫£ l·ªùi b·ªüi ' + esc(q.AnsweredBy || 'Admin') + '</small>';
          html += '<small style="color:var(--muted);font-size:11px">‚Ä¢ ' + (q.AnsweredAt || '') + '</small>';
          html += '</div>';
          html += '<p style="margin:0;color:var(--ink);line-height:1.6;white-space:pre-wrap">' + esc(q.Answer) + '</p>';
          html += '</div>';
        } else if (currentUser && currentUser.role === 'admin') {
          html += '<div style="margin-top:12px;padding:12px;background:rgba(245,158,11,0.05);border-left:4px solid #f59e0b;border-radius:8px">';
          html += '<textarea id="answer_' + q.ID + '" rows="3" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..." class="control" style="width:100%;margin-bottom:8px;resize:vertical"></textarea>';
          html += '<button class="btn btn-primary" onclick="answerQA(\'' + q.ID + '\')" style="padding:8px 16px;font-size:13px">üí¨ Tr·∫£ l·ªùi</button>';
          html += '</div>';
        } else {
          html += '<div style="margin-top:12px;padding:12px;background:rgba(0,0,0,0.02);border-radius:8px;text-align:center">';
          html += '<small style="color:var(--muted)">‚è≥ ƒêang ch·ªù admin tr·∫£ l·ªùi...</small>';
          html += '</div>';
        }
        
        card.innerHTML = html;
        list.appendChild(card);
      } catch (renderError) {
        console.error('[QA] Error rendering question at index ' + index + ':', renderError);
        console.error('[QA] Question data:', q);
      }
    });
    
    console.log('[QA] Rendered ' + renderedCount + ' questions successfully');
  }
  
  window.answerQA = function(id) {
    var answerInput = document.getElementById('answer_' + id);
    var answer = answerInput ? answerInput.value : '';
    
    if (!answer.trim()) {
      toast('Vui l√≤ng nh·∫≠p c√¢u tr·∫£ l·ªùi', 'err');
      return;
    }
    
    callApi('answerQuestion', { id: id, answer: answer.trim() })
      .then(function(result) {
        if (result && result.status === 'ok') {
          toast('ƒê√£ tr·∫£ l·ªùi c√¢u h·ªèi!', 'ok');
          loadQA();
        } else {
          toast('L·ªói: ' + (result.message || 'Unknown error'), 'err');
        }
      })
      .catch(function(error) {
        toast('L·ªói: ' + error.message, 'err');
      });
  };
  
  /* ====== UNFINISHED TASKS MODULE ====== */
  
  function setupUnfinished() {
    var refreshBtn = document.getElementById('unfinishedRefresh');
    var exportBtn = document.getElementById('unfinishedExport');
    var showBtn = document.getElementById('showUnfinishedBtn');
    var tile = document.getElementById('unfinishedTile');
    var dateInput = document.getElementById('unfinishedDate');
    
    // Set default date to today (D0)
    if (dateInput) {
      var today = new Date();
      dateInput.value = today.toISOString().slice(0, 10);
      updateUnfinishedDateDisplay();
      
      // Load when date changes
      dateInput.addEventListener('change', function() {
        updateUnfinishedDateDisplay();
        loadUnfinished();
      });
    }
    
    if (refreshBtn) refreshBtn.addEventListener('click', loadUnfinished);
    if (exportBtn) exportBtn.addEventListener('click', exportUnfinished);
    if (showBtn) showBtn.addEventListener('click', showUnfinishedTab);
    if (tile) tile.addEventListener('click', showUnfinishedTab);
  }
  
  function updateUnfinishedDateDisplay() {
    var dateInput = document.getElementById('unfinishedDate');
    var displayEl = document.getElementById('unfinishedDateDisplay');
    if (!dateInput || !displayEl) return;
    
    var selectedDate = dateInput.value;
    var today = new Date().toISOString().slice(0, 10);
    
    if (selectedDate === today) {
      displayEl.textContent = 'ƒêang hi·ªÉn th·ªã tasks ch∆∞a ho√†n th√†nh c·ªßa ng√†y h√¥m nay (D0)';
    } else {
      var dateObj = new Date(selectedDate + 'T00:00:00');
      var dateStr = dateObj.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
      displayEl.textContent = 'ƒêang hi·ªÉn th·ªã tasks ch∆∞a ho√†n th√†nh c·ªßa ng√†y ' + dateStr;
    }
  }
  
  function showUnfinishedTab() {
    // Switch to unfinished tab
    var tabs = document.querySelectorAll('.tab');
    var contents = document.querySelectorAll('.content');
    
    tabs.forEach(function(t) { t.classList.remove('active'); });
    contents.forEach(function(c) { c.classList.remove('active'); });
    
    var unfinishedTab = document.querySelector('[data-tab="unfinished"]');
    var unfinishedContent = document.querySelector('[data-content="unfinished"]');
    
    if (unfinishedTab) unfinishedTab.classList.add('active');
    if (unfinishedContent) unfinishedContent.classList.add('active');
    
    loadUnfinished();
  }
  
  function loadUnfinished() {
    var hub = currentHub;
    var dateInput = document.getElementById('unfinishedDate');
    var selectedDate = dateInput ? dateInput.value : new Date().toISOString().slice(0, 10);
    
    // If no date selected, default to today (D0)
    if (!selectedDate) {
      selectedDate = new Date().toISOString().slice(0, 10);
      if (dateInput) dateInput.value = selectedDate;
    }
    
    callApi('loadUnfinishedTasks', { hub: hub, date: selectedDate })
      .then(function(tasks) {
        renderUnfinished(tasks || []);
      })
      .catch(function(error) {
        console.error('Load unfinished error:', error);
        toast('L·ªói khi t·∫£i tasks ch∆∞a ho√†n th√†nh', 'err');
      });
  }
  
  function renderUnfinished(tasks) {
    var list = document.getElementById('unfinishedList');
    if (!list) return;
    
    currentUnfinishedTasks = tasks; // Store for note function
    
    if (tasks.length === 0) {
      list.innerHTML = '<p class="hint">üéâ Kh√¥ng c√≥ tasks ch∆∞a ho√†n th√†nh!</p>';
      return;
    }
    
    list.innerHTML = '';
    tasks.forEach(function(task, idx) {
      var card = document.createElement('div');
      card.className = 'section glass';
      card.style.marginBottom = '12px';
      
      var html = '<div style="display:flex;justify-content:space-between;align-items:start;gap:12px">';
      html += '<div style="flex:1">';
      html += '<div><span class="chip">' + esc(task.hub || task.Hub || '') + '</span> <span class="chip">' + esc(task.date || task.Date || '') + '</span> <span class="chip">' + esc(task.category || task.Category || '') + '</span></div>';
      html += '<p style="margin:8px 0;font-weight:600">' + esc(task.text || task.Text || '') + '</p>';
      if (task.sla || task.SLA) {
        html += '<small style="color:var(--orange)">‚è∞ SLA: ' + esc(task.sla || task.SLA) + '</small>';
      }
      html += '</div>';
      html += '<div style="display:flex;gap:8px;align-items:start">';
      html += '<button class="btn btn-soft btn-sm" onclick="showUnfinishedNote(' + idx + ')">üìù Note</button>';
      html += '</div>';
      html += '</div>';
      
      card.innerHTML = html;
      list.appendChild(card);
    });
  }
  
  var currentUnfinishedTasks = []; // Store tasks for note function
  
  function showUnfinishedNote(taskIdx) {
    if (!currentUnfinishedTasks[taskIdx]) {
      toast('Kh√¥ng t√¨m th·∫•y task', 'err');
      return;
    }
    
    var task = currentUnfinishedTasks[taskIdx];
    var noteInput = prompt('Nh·∫≠p ghi ch√∫ s·ª± v·ª• cho task: "' + (task.text || task.Text) + '"', '');
    
    if (!noteInput || !noteInput.trim()) return;
    
    callApi('saveTaskNote', {
      hub: task.hub || task.Hub || currentHub,
      date: task.date || task.Date || todayStr(),
      taskText: task.text || task.Text || '',
      note: noteInput.trim()
    }).then(function(result) {
      if (result && result.status === 'ok') {
        toast('‚úÖ Ghi ch√∫ ƒë√£ l∆∞u!', 'ok');
      } else {
        toast('L·ªói: ' + (result ? result.message : 'Failed'), 'err');
      }
    }).catch(function(error) {
      toast('L·ªói: ' + (error.message || error), 'err');
    });
  }
  
  function exportUnfinished() {
    toast('Xu·∫•t file Excel...', 'ok');
    // Implement export logic
  }
  
  /* ====== CHAT MODULE ====== */
  
  var chatMessages = [];
  var chatPollInterval = null;
  
  /* ====== FLOATING CHAT BUTTON & WIDGET ====== */
  
  function setupFloatingChat() {
    var chatButton = document.getElementById('floatingChatButton');
    var chatWidget = document.getElementById('chatWidget');
    var chatClose = document.getElementById('chatWidgetClose');
    var chatSend = document.getElementById('chatWidgetSend');
    var chatInput = document.getElementById('chatWidgetInput');
    
    if (!chatButton || !chatWidget) return;
    
    // Toggle chat widget
    chatButton.addEventListener('click', function() {
      var isVisible = chatWidget.style.display === 'flex';
      chatWidget.style.display = isVisible ? 'none' : 'flex';
      chatButton.style.transform = isVisible ? 'scale(1)' : 'scale(0.9)';
      
      if (!isVisible) {
        // Load messages and users when opening
        loadChatWidgetMessages();
        loadChatWidgetOnlineUsers();
        
        // Start polling
        if (chatPollInterval) clearInterval(chatPollInterval);
        chatPollInterval = setInterval(function() {
          loadChatWidgetMessages();
          loadChatWidgetOnlineUsers();
        }, 3000);
      } else {
        // Stop polling when closed
        if (chatPollInterval) clearInterval(chatPollInterval);
      }
    });
    
    // Close button
    if (chatClose) {
      chatClose.addEventListener('click', function() {
        chatWidget.style.display = 'none';
        chatButton.style.transform = 'scale(1)';
        if (chatPollInterval) clearInterval(chatPollInterval);
      });
    }
    
    // Send message
    if (chatSend) {
      chatSend.addEventListener('click', function() {
        sendChatWidgetMessage();
      });
    }
    
    // Enter key to send
    if (chatInput) {
      chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendChatWidgetMessage();
        }
      });
    }
    
    // Hover effect for button
    chatButton.addEventListener('mouseenter', function() {
      this.style.transform = 'scale(1.1)';
    });
    chatButton.addEventListener('mouseleave', function() {
      if (chatWidget.style.display !== 'flex') {
        this.style.transform = 'scale(1)';
      }
    });
  }
  
  function loadChatWidgetMessages() {
    callApi('getChatMessages', { limit: 50 })
      .then(function(messages) {
        if (!Array.isArray(messages)) messages = [];
        renderChatWidgetMessages(messages);
      })
      .catch(function(error) {
        console.error('[Chat Widget] Load messages error:', error);
      });
  }
  
  function renderChatWidgetMessages(messages) {
    var container = document.getElementById('chatWidgetMessages');
    if (!container) return;
    
    if (!messages || messages.length === 0) {
      container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">Ch∆∞a c√≥ tin nh·∫Øn. H√£y b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán!</div>';
      return;
    }
    
    container.innerHTML = '';
    messages.forEach(function(msg) {
      var isOwn = msg.email === currentUser.email;
      var bubble = document.createElement('div');
      bubble.style.cssText = 'margin-bottom:12px;display:flex;' + (isOwn ? 'justify-content:flex-end' : 'justify-content:flex-start');
      
      var content = document.createElement('div');
      content.style.cssText = 'max-width:75%;padding:10px 14px;border-radius:16px;' + 
        (isOwn ? 'background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff' : 
                 'background:var(--glass);color:var(--ink);border:1px solid var(--stroke)');
      
      var name = document.createElement('div');
      name.style.cssText = 'font-size:11px;font-weight:600;margin-bottom:4px;opacity:0.8';
      name.textContent = isOwn ? 'B·∫°n' : (msg.displayName || msg.email.split('@')[0] || 'Unknown');
      content.appendChild(name);
      
      var text = document.createElement('div');
      text.style.cssText = 'font-size:14px;line-height:1.5;word-wrap:break-word';
      text.textContent = msg.message || '';
      content.appendChild(text);
      
      var time = document.createElement('div');
      time.style.cssText = 'font-size:10px;margin-top:4px;opacity:0.7';
      time.textContent = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) : '';
      content.appendChild(time);
      
      bubble.appendChild(content);
      container.appendChild(bubble);
    });
    
    // Auto-scroll to bottom
    container.scrollTop = container.scrollHeight;
  }
  
  function sendChatWidgetMessage() {
    var input = document.getElementById('chatWidgetInput');
    var message = input ? input.value.trim() : '';
    
    if (!message) return;
    
    callApi('sendChatMessage', { message: message })
      .then(function(result) {
        if (result && result.status === 'ok') {
          input.value = '';
          loadChatWidgetMessages();
        } else {
          toast('L·ªói g·ª≠i tin nh·∫Øn', 'err');
        }
      })
      .catch(function(error) {
        toast('L·ªói: ' + error.message, 'err');
      });
  }
  
  function loadChatWidgetOnlineUsers() {
    callApi('getOnlineUsers', {})
      .then(function(users) {
        if (!Array.isArray(users)) users = [];
        renderChatWidgetOnlineUsers(users);
      })
      .catch(function(error) {
        console.error('[Chat Widget] Load online users error:', error);
        renderChatWidgetOnlineUsers([]);
      });
  }
  
  function renderChatWidgetOnlineUsers(users) {
    var countEl = document.getElementById('chatWidgetOnlineCount');
    var container = document.getElementById('chatWidgetOnlineUsers');
    
    if (countEl) {
      countEl.textContent = users.length || 0;
    }
    
    if (!container) return;
    
    if (!users || users.length === 0) {
      container.innerHTML = '<span style="color:var(--muted);font-size:11px">Kh√¥ng c√≥ ai online</span>';
      return;
    }
    
    container.innerHTML = '';
    users.forEach(function(user) {
      var chip = document.createElement('span');
      chip.className = 'chip';
      chip.style.cssText = 'background:rgba(16,185,129,0.1);color:#10b981;font-size:11px;padding:4px 8px;border-radius:6px';
      var displayText = user.displayName || (user.email ? user.email.split('@')[0] : 'Unknown');
      chip.textContent = displayText;
      container.appendChild(chip);
    });
    
    // Update badge count
    var badge = document.getElementById('chatBadge');
    if (badge && users.length > 0) {
      badge.textContent = users.length > 9 ? '9+' : users.length;
      badge.style.display = 'flex';
    } else if (badge) {
      badge.style.display = 'none';
    }
  }
  
  function loadOnlineUsers() {
    callApi('getOnlineUsers', {})
      .then(function(users) {
        // getOnlineUsers returns an array
        if (!Array.isArray(users)) {
          users = [];
        }
        renderOnlineUsers(users);
      })
      .catch(function(error) {
        console.error('[Chat] Load online users error:', error);
        renderOnlineUsers([]);
      });
  }
  
  function renderOnlineUsers(users) {
    var container = document.getElementById('chatOnlineUsers');
    var countEl = document.getElementById('chatOnlineCount');
    
    if (countEl) {
      countEl.textContent = users.length || 0;
    }
    
    if (!container) return;
    
    if (!users || users.length === 0) {
      container.innerHTML = '<span style="color:var(--muted);font-size:13px">Kh√¥ng c√≥ ai online</span>';
      return;
    }
    
    container.innerHTML = '';
    users.forEach(function(user) {
      var chip = document.createElement('span');
      chip.className = 'chip';
      chip.style.cssText = 'background:rgba(16,185,129,0.1);color:#10b981;font-size:12px;padding:6px 12px';
      // getOnlineUsers returns userId, not email/displayName directly
      var displayText = user.userId || user.email || user.displayName || 'Unknown';
      // Try to get display name from user permissions if available
      if (displayText && displayText.indexOf('@') !== -1) {
        displayText = displayText.split('@')[0];
      }
      chip.textContent = displayText;
      container.appendChild(chip);
    });
  }
  
  function sendChatMessage() {
    var input = $('#chatInput');
    var message = input ? input.value.trim() : '';
    
    if (!message) return;
    
    callApi('sendChatMessage', { message: message })
      .then(function(result) {
        if (result && result.status === 'ok') {
          input.value = '';
          loadChatMessages();
        } else {
          toast('L·ªói g·ª≠i tin nh·∫Øn', 'err');
        }
      })
      .catch(function(error) {
        toast('L·ªói: ' + error.message, 'err');
      });
  }
  
  function loadChatMessages() {
    callApi('getChatMessages', {})
      .then(function(messages) {
        // getChatMessages returns an array
        if (!Array.isArray(messages)) {
          messages = [];
        }
        console.log('[Chat] Received messages:', messages.length);
        renderChatMessages(messages);
      })
      .catch(function(error) {
        console.error('[Chat] Load error:', error);
        renderChatMessages([]);
      });
  }
  
  function renderChatMessages(messages) {
    var container = document.getElementById('chatMessages');
    
    if (!container) {
      console.error('[Chat] Container not found!');
      return;
    }
    
    if (!messages || messages.length === 0) {
      var emptyState = createEmptyState({
        icon: 'üí¨',
        title: 'Ch∆∞a c√≥ tin nh·∫Øn',
        description: 'H√£y b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán v·ªõi team c·ªßa b·∫°n!',
        actionLabel: '‚úçÔ∏è G·ª≠i tin nh·∫Øn',
        onAction: function() {
          var chatInput = document.getElementById('chatInput');
          if (chatInput) {
            chatInput.focus();
            chatInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      });
      container.innerHTML = '';
      container.appendChild(emptyState);
      return;
    }
    
    container.innerHTML = '';
    var isCurrentUser = currentUser && currentUser.email;
      
    messages.forEach(function(msg, idx) {
      var isMe = currentUser && msg.Email && msg.Email.toLowerCase() === currentUser.email.toLowerCase();
      var msgDiv = document.createElement('div');
      msgDiv.style.cssText = 'margin-bottom:16px;display:flex;flex-direction:column;align-items:' + (isMe ? 'flex-end' : 'flex-start');
      
      var timeStr = msg.CreatedAt || '';
      var displayName = msg.DisplayName || (msg.Email ? msg.Email.split('@')[0] : 'Unknown');
      
      var bubble = document.createElement('div');
      bubble.style.cssText = 'max-width:70%;padding:12px 16px;border-radius:12px;word-wrap:break-word;position:relative';
      bubble.style.background = isMe ? 'linear-gradient(135deg, #3b82f6, #2563eb)' : 'var(--glass)';
      bubble.style.color = isMe ? '#fff' : 'var(--ink)';
      bubble.style.border = isMe ? 'none' : '1px solid var(--stroke)';
      
      bubble.innerHTML = `
        <div style="font-weight:600;font-size:13px;margin-bottom:6px;opacity:0.9">${esc(displayName)}</div>
        <div style="line-height:1.5;white-space:pre-wrap">${esc(msg.Message || '')}</div>
        <div style="font-size:11px;opacity:0.7;margin-top:6px;text-align:right">${timeStr}</div>
      `;
      
      msgDiv.appendChild(bubble);
      container.appendChild(msgDiv);
    });
    
    // Auto-scroll to bottom
    container.scrollTop = container.scrollHeight;
  }
  
  /* ====== LOAD BRANDING CONFIG ====== */
  
  function loadBrandingConfig() {
    // Default config (fallback n·∫øu kh√¥ng c√≥ file app-config.js)
    var config = {
      appTitle: '[SPX] DAILY CHECKLIST',
      appVersion: 'v2.5',
      logoUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üìã</text></svg>',
      faviconUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üìã</text></svg>'
    };
    
    // Ki·ªÉm tra xem c√≥ APP_CONFIG global kh√¥ng (t·ª´ file app-config.js)
    if (typeof APP_CONFIG !== 'undefined') {
      config = APP_CONFIG;
    }
    
    // Load logo via Apps Script proxy endpoint (avoids CORS issues)
    // This fetches logo from external URL and serves it through Apps Script
    function loadLogoFromProxy() {
      try {
        // Check if google.script.url.getLocation is available
        if (typeof google === 'undefined' || !google.script || !google.script.url || !google.script.url.getLocation) {
          if (window.logger) logger.log('[Branding] google.script.url.getLocation not available, using direct URL');
          applyDirectLogo();
          return;
        }
        
        google.script.url.getLocation(function(location) {
          if (location && location.scriptUrl) {
            var scriptUrl = location.scriptUrl;
            var logoEndpoint = scriptUrl + '?action=logo';
            
            // Fetch logo as JSON (base64 data URL) from Apps Script proxy
            fetch(logoEndpoint)
              .then(function(response) {
                if (!response.ok) {
                  throw new Error('HTTP ' + response.status);
                }
                return response.json();
              })
              .then(function(data) {
                if (data.status === 'ok' && data.dataUrl) {
                  // Update logo URLs with base64 data URL
                  var topbarLogo = document.getElementById('topbarLogo');
                  var coverLogo = document.getElementById('coverLogo');
                  
                  if (topbarLogo) {
                    topbarLogo.src = data.dataUrl;
                    topbarLogo.onload = function() {
                      if (window.logger) logger.log('[Branding] Topbar logo loaded successfully via proxy');
                    };
                    topbarLogo.onerror = function() {
                      if (window.logger) logger.error('[Branding] Failed to decode topbar logo');
                    };
                  }
                  
                  if (coverLogo) {
                    coverLogo.src = data.dataUrl;
                    coverLogo.onload = function() {
                      if (window.logger) logger.log('[Branding] Cover logo loaded successfully via proxy');
                    };
                    coverLogo.onerror = function() {
                      if (window.logger) logger.error('[Branding] Failed to decode cover logo');
                    };
                  }
                  
                  if (window.logger) logger.log('[Branding] Logo loaded successfully from external URL via Apps Script proxy');
                } else {
                  if (window.logger) logger.warn('[Branding] Logo endpoint returned error:', data.message);
                  // Fallback to direct URL
                  applyDirectLogo();
                }
              })
              .catch(function(error) {
                console.error('[Branding] Failed to fetch logo from proxy:', error);
                // Fallback to direct URL
                applyDirectLogo();
              });
          } else {
            if (window.logger) logger.warn('[Branding] Could not get script URL, using direct URL');
            applyDirectLogo();
          }
        });
      } catch (e) {
        if (window.logger) logger.warn('[Branding] Error getting script URL:', e);
        applyDirectLogo();
      }
    }
    
    // Fallback: try to load logo directly from URL
    function applyDirectLogo() {
      var topbarLogo = document.getElementById('topbarLogo');
      var coverLogo = document.getElementById('coverLogo');
      
      if (config.logoUrl) {
        if (topbarLogo) {
          topbarLogo.src = config.logoUrl;
          topbarLogo.onload = function() {
            if (window.logger) logger.log('[Branding] Topbar logo loaded directly from:', config.logoUrl);
          };
          topbarLogo.onerror = function() {
            if (window.logger) logger.error('[Branding] Failed to load topbar logo directly (CORS may be blocking)');
          };
        }
        
        if (coverLogo) {
          coverLogo.src = config.logoUrl;
          coverLogo.onload = function() {
            if (window.logger) logger.log('[Branding] Cover logo loaded directly from:', config.logoUrl);
          };
          coverLogo.onerror = function() {
            if (window.logger) logger.error('[Branding] Failed to load cover logo directly (CORS may be blocking)');
          };
        }
      }
    }
    
    // Apply configured logo immediately, then try proxy for cached version
    applyDirectLogo();
    loadLogoFromProxy();
    
    // Apply favicon
    var favicon = document.getElementById('appFavicon');
    if (favicon && config.faviconUrl) {
      favicon.href = config.faviconUrl;
    }
    
    // Apply title
    var title = document.getElementById('appTitle');
    if (title && config.appTitle) {
      title.textContent = config.appTitle;
    }
    
    // Apply topbar title
    var topbarTitle = document.getElementById('topbarTitle');
    if (topbarTitle && config.appTitle) {
      topbarTitle.textContent = config.appTitle;
    }
    
    // Note: Logo URLs are applied in the async callback above to use Apps Script endpoint
    
    // Apply cover title
    var coverTitle = document.getElementById('coverTitle');
    if (coverTitle && config.appTitle && config.appVersion) {
      coverTitle.textContent = config.appTitle + ' ' + config.appVersion;
    }
    
    if (window.logger) {
      logger.log('[Branding] Config loaded:', config.appTitle);
      logger.log('[Branding] Logo URL:', config.logoUrl);
      logger.log('[Branding] Favicon URL:', config.faviconUrl);
    }
  }
  
  /* ====== START APPLICATION ====== */
  
  document.addEventListener('DOMContentLoaded', function() {
    loadBrandingConfig();
    checkAuth();
  });
  
})();
</script>
